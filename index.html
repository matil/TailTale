<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no,viewport-fit=cover">
<meta name="mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="theme-color" content="#0B0E2D">
<title>Tail a Tale - Bedtime Stories in Your Voice</title>
<link href="https://fonts.googleapis.com/css2?family=Quicksand:wght@500;600;700&family=Inter:wght@400;500;600;700&family=Heebo:wght@400;500;600;700&family=Cairo:wght@400;600;700&family=Noto+Sans+SC:wght@400;500;700&display=swap" rel="stylesheet">
<style>
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
:root{
  --nd:#0B0E2D;--nm:#141845;--ns:#1E2460;
  --moon:#FFF8DC;--star:#FFEAA7;
  --lav:#C5B3E6;--lavs:#A78BCC;--lavd:#8B6FC0;
  --warm:#FFD4A2;--wg:#FFBE76;--peach:#FFB8B8;--coral:#FF7979;
  --teal:#55E6C1;--teald:#3DC1A3;
  --tx:#E8E4F0;--txs:#A8A0C0;--txd:#706990;
  --gl:rgba(255,255,255,.06);--glh:rgba(255,255,255,.1);--gls:rgba(255,255,255,.12);
  --bd:rgba(255,255,255,.08);
  --rs:14px;--rm:20px;--rl:28px;
  --ff:'Inter','Heebo','Cairo','Noto Sans SC',system-ui,sans-serif;
  --fh:'Quicksand','Heebo','Cairo','Noto Sans SC',system-ui,sans-serif
}
html,body,#root{height:100%;width:100%;overflow:hidden}
body{font-family:var(--ff);background:var(--nd);color:var(--tx);-webkit-font-smoothing:antialiased;font-weight:400;letter-spacing:.01em}
[lang=he] body,[dir=rtl] body{font-family:'Heebo','Inter',system-ui,sans-serif}
[lang=ar] body{font-family:'Cairo','Inter',system-ui,sans-serif}
[lang=zh] body{font-family:'Noto Sans SC','Inter',system-ui,sans-serif}
[lang=ru] body{font-family:'Inter',system-ui,sans-serif}
.bg{position:fixed;inset:0;z-index:0;overflow:hidden;pointer-events:none;background:linear-gradient(180deg,#070A1F 0%,#0B0E2D 25%,#141845 55%,#1A1F55 75%,#1E2460 100%)}
.moon{position:absolute;width:80px;height:80px;border-radius:50%;top:30px;right:25px;background:radial-gradient(circle at 38% 38%,#FFFFFF,#FFFEF5 30%,#FFF8DC 60%,#EDE0AA);box-shadow:0 0 20px 5px rgba(255,250,220,.6),0 0 60px 10px rgba(255,248,200,.35),0 0 120px 20px rgba(255,245,180,.15);animation:mg 6s ease-in-out infinite;transition:opacity .5s,transform .5s}
.bg.dim .moon{opacity:0;visibility:hidden;pointer-events:none;transform:scale(.3);box-shadow:none;animation:none;transition:opacity .6s,transform .6s,visibility .6s}
.moon::after{content:'';position:absolute;top:8px;left:12px;width:14px;height:14px;border-radius:50%;background:radial-gradient(circle,rgba(210,200,160,.25),transparent 70%)}
.moon::before{content:'';position:absolute;inset:0;border-radius:50%;background:radial-gradient(circle at 70% 65%,transparent 50%,rgba(200,185,130,.2) 80%)}
@keyframes mg{0%,100%{box-shadow:0 0 20px 5px rgba(255,250,220,.6),0 0 60px 10px rgba(255,248,200,.35),0 0 120px 20px rgba(255,245,180,.15)}50%{box-shadow:0 0 25px 8px rgba(255,250,220,.7),0 0 70px 15px rgba(255,248,200,.4),0 0 140px 25px rgba(255,245,180,.2)}}
.star{position:absolute;border-radius:50%;background:#fff;animation:tw ease-in-out infinite}
@keyframes tw{0%,100%{opacity:.2;transform:scale(.7)}50%{opacity:.8;transform:scale(1.2)}}
.ff{position:absolute;width:4px;height:4px;background:var(--wg);border-radius:50%;animation:ffa ease-in-out infinite;box-shadow:0 0 8px var(--wg)}
@keyframes ffa{0%,100%{opacity:.15;transform:translate(0,0)}25%{opacity:.7;transform:translate(12px,-18px)}50%{opacity:.3;transform:translate(-8px,-30px)}75%{opacity:.8;transform:translate(16px,-12px)}}
.hills{position:absolute;bottom:0;width:100%;height:120px}.hl{position:absolute;bottom:0;border-radius:50% 50% 0 0}
.hl:nth-child(1){width:max(500px,45vw);height:120px;background:#0F1235;left:-80px}.hl:nth-child(2){width:max(450px,40vw);height:95px;background:#121640;left:180px}.hl:nth-child(3){width:max(600px,50vw);height:105px;background:#0D1030;right:-120px}
.app{position:relative;z-index:1;height:100%;display:flex;flex-direction:column;max-width:520px;margin:0 auto;padding:0 env(safe-area-inset-right) 0 env(safe-area-inset-left)}
.hdr{padding:12px 20px;display:flex;align-items:center;justify-content:space-between;flex-shrink:0}
.logo{display:flex;align-items:center;direction:ltr}
.logo-hdr{height:44px;width:200px;display:block}
.logo-welcome{width:300px;max-width:90vw;margin:0 auto 8px;display:block}
.hbtn{height:36px;padding:0 14px;border-radius:50px;border:1px solid var(--bd);background:var(--gl);font-size:12px;font-weight:700;cursor:pointer;display:flex;align-items:center;gap:5px;color:var(--txs);font-family:var(--ff);transition:.2s}.hbtn:hover{background:var(--glh)}
.main{flex:1;overflow:hidden;padding:0 20px 0;display:flex;flex-direction:column;min-height:0}
.nav{flex-shrink:0;background:rgba(11,14,45,.92);backdrop-filter:blur(20px);border-radius:22px 22px 0 0;padding:6px 12px calc(14px + env(safe-area-inset-bottom,0px));display:flex;justify-content:space-around;border-top:1px solid var(--bd)}
.ni{display:flex;flex-direction:column;align-items:center;gap:3px;background:none;border:none;cursor:pointer;padding:8px 16px;border-radius:14px;transition:.2s;color:var(--txd);font-family:var(--ff)}.ni.a{color:var(--moon);background:rgba(255,248,220,.07)}
.ni-l{font-size:10px;font-weight:700}
.card{background:var(--gl);backdrop-filter:blur(10px);border-radius:var(--rm);padding:18px;margin-bottom:12px;border:1px solid var(--bd)}
.ct{font-family:var(--fh);font-size:17px;font-weight:700;margin-bottom:3px;display:flex;align-items:center;gap:6px}.cs{font-size:13px;color:var(--txs)}
.sr{display:flex;gap:14px;align-items:center;cursor:pointer;padding:14px 16px;border-radius:var(--rm);background:var(--gl);margin-bottom:10px;transition:.25s;border:1px solid var(--bd)}.sr:hover{background:var(--glh);transform:translateY(-1px);box-shadow:0 4px 12px rgba(0,0,0,.15)}.sr.sel{border-color:rgba(197,179,230,.4);background:rgba(197,179,230,.08)}
.se{width:54px;height:54px;display:flex;align-items:center;justify-content:center;background:rgba(255,248,220,.06);border-radius:14px;flex-shrink:0}.si{flex:1;min-width:0}.sn{font-family:var(--fh);font-size:15px;font-weight:700;line-height:1.2}.sd{font-size:11px;color:var(--txd);margin-top:2px}
.badge{display:inline-block;padding:1px 7px;border-radius:6px;font-size:9px;font-weight:700;text-transform:uppercase;margin-top:3px}
.b-ft{background:rgba(85,230,193,.1);color:var(--teal)}.b-fb{background:rgba(255,212,162,.1);color:var(--warm)}.b-bt{background:rgba(197,179,230,.1);color:var(--lav)}
.btn{display:inline-flex;align-items:center;justify-content:center;gap:7px;padding:13px 24px;border:none;border-radius:var(--rl);font-family:var(--fh);font-size:16px;font-weight:700;cursor:pointer;transition:.2s;white-space:nowrap}
.btn:active{transform:scale(.96)}.btn:disabled{opacity:.35;cursor:not-allowed;transform:none}
.bp{background:linear-gradient(135deg,var(--lavs),var(--lavd));color:#fff;box-shadow:0 5px 20px rgba(167,139,204,.3)}
.bg2{background:var(--gls);color:var(--tx);border:1px solid var(--bd)}.bgr{background:linear-gradient(135deg,var(--teal),var(--teald));color:#0B0E2D}
.bw{width:100%}.bsm{padding:9px 18px;font-size:14px}
.ig{margin-bottom:14px}.il{display:block;font-family:var(--fh);font-size:14px;font-weight:600;margin-bottom:5px;color:var(--txs)}
.inp{width:100%;padding:12px 16px;border:1px solid rgba(255,255,255,.1);border-radius:var(--rs);font-family:var(--ff);font-size:15px;background:rgba(255,255,255,.05);color:var(--tx);transition:.2s}.inp:focus{outline:none;border-color:var(--lavs)}.inp::placeholder{color:var(--txd)}
.sh{font-family:var(--fh);font-size:20px;font-weight:800;margin:16px 0 8px;color:var(--moon);display:flex;align-items:center;gap:8px;flex-shrink:0}.ss{font-size:13px;color:var(--txd);margin-bottom:10px;line-height:1.4;flex-shrink:0}
.rb{width:90px;height:90px;border-radius:50%;border:2px solid rgba(255,121,121,.2);background:linear-gradient(135deg,rgba(255,121,121,.6),rgba(255,121,121,.35));color:#fff;cursor:pointer;box-shadow:0 0 25px rgba(255,121,121,.15);transition:.2s;display:flex;align-items:center;justify-content:center;margin:0 auto}
.rb:hover{transform:scale(1.05)}.rb.rec{animation:rp 1.5s ease-in-out infinite}
@keyframes rp{0%{box-shadow:0 0 0 0 rgba(255,121,121,.4)}70%{box-shadow:0 0 0 22px rgba(255,121,121,0)}100%{box-shadow:0 0 0 0 rgba(255,121,121,0)}}
.wf{display:flex;align-items:center;justify-content:center;gap:3px;height:45px;margin:12px 0}.wb{width:3px;background:var(--lav);border-radius:3px;animation:wa .8s ease-in-out infinite}@keyframes wa{0%,100%{height:6px}50%{height:36px}}
.vc{display:flex;align-items:center;gap:12px;padding:12px 14px;border-radius:var(--rs);background:var(--gl);margin-bottom:8px;cursor:pointer;transition:.2s;border:1px solid var(--bd)}.vc:hover{background:var(--glh)}.vc.sel{border-color:rgba(85,230,193,.35);background:rgba(85,230,193,.06)}
.va{width:44px;height:44px;border-radius:50%;display:flex;align-items:center;justify-content:center;flex-shrink:0}.va-u{background:rgba(85,230,193,.1);border:1px solid rgba(85,230,193,.12)}.va-f{background:rgba(255,212,162,.1);border:1px solid rgba(255,212,162,.12)}
.vn{font-weight:700;font-size:14px}.vd{font-size:11px;color:var(--txd)}
.vx{margin-left:auto;background:none;border:none;cursor:pointer;opacity:.3;padding:4px;color:var(--txd)}.vx:hover{opacity:.7}
.pc{border-radius:28px;overflow:hidden;margin-top:6px}.pb{background:linear-gradient(160deg,#1A0A3E,#120835 40%,#0D0628);padding:28px 20px;position:relative;border:1px solid rgba(255,255,255,.05);direction:ltr}
.pti{font-family:var(--fh);font-size:22px;font-weight:700;color:var(--moon);text-align:center;direction:auto;unicode-bidi:plaintext}.pau{font-size:12px;color:rgba(255,255,255,.3);text-align:center;margin-top:2px}
.pbar{margin:22px 0 6px;padding:14px 0;cursor:pointer;-webkit-tap-highlight-color:transparent;touch-action:none;user-select:none}
.pbtr{width:100%;height:6px;background:rgba(255,255,255,.08);border-radius:3px;position:relative}
.pbfl{height:100%;background:linear-gradient(90deg,var(--lavs),var(--wg));border-radius:3px;position:relative;will-change:width}
.pbth{position:absolute;right:-10px;top:50%;transform:translateY(-50%);width:22px;height:22px;background:var(--moon);border-radius:50%;box-shadow:0 0 8px rgba(255,248,220,.3);transition:transform .1s}.pbar:active .pbth{transform:translateY(-50%) scale(1.3)}
.ptm{display:flex;justify-content:space-between;font-size:11px;color:rgba(255,255,255,.25);font-weight:600;font-variant-numeric:tabular-nums}
.pcc{display:flex;align-items:center;justify-content:center;gap:20px;margin-top:20px}
.cb{background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.07);color:rgba(255,255,255,.6);width:46px;height:46px;border-radius:50%;cursor:pointer;display:flex;align-items:center;justify-content:center;transition:.2s}.cb:hover{background:rgba(255,255,255,.1);color:#fff}.cb:active{transform:scale(.93)}
.cb.pp{width:64px;height:64px;background:linear-gradient(135deg,var(--lavs),var(--lavd));color:#fff;box-shadow:0 0 25px rgba(167,139,204,.25);border:none}
.pvb{text-align:center;margin-top:16px;font-size:11px;color:rgba(255,255,255,.25);display:flex;align-items:center;justify-content:center;gap:4px;direction:ltr}.pvb b{color:var(--wg)}
.ra{background:rgba(20,24,69,.5);border-radius:var(--rm);padding:20px;margin-top:14px;flex:1;min-height:100px;overflow-y:auto;font-size:15px;line-height:1.85;color:rgba(232,228,240,.55);border:1px solid var(--bd);scroll-behavior:smooth;margin-bottom:16px}
.ra p{margin-bottom:14px}.ra p:last-child{margin-bottom:0}
.ra .whl{color:var(--wg);transition:color .15s}
.genst{background:rgba(139,111,192,.12);border:1px solid rgba(139,111,192,.2);border-radius:var(--rs);padding:14px;margin-top:12px;text-align:center;font-size:13px;color:var(--lav);line-height:1.5}
.genst .spinner{display:inline-block;width:16px;height:16px;border:2px solid rgba(197,179,230,.3);border-top-color:var(--lav);border-radius:50%;animation:spin 1s linear infinite;vertical-align:middle;margin-right:6px}
@keyframes spin{to{transform:rotate(360deg)}}
.genst .done{color:var(--teal);display:flex;align-items:center;justify-content:center;gap:6px}
.wel{display:flex;flex-direction:column;justify-content:center;align-items:center;min-height:100%;padding:40px 24px;text-align:center}
.wbx{background:rgba(20,24,69,.8);backdrop-filter:blur(20px);border-radius:var(--rl);padding:24px 20px;width:100%;max-width:380px;border:1px solid var(--bd)}
.flt{display:flex;gap:7px;overflow-x:auto;padding-bottom:3px;margin-bottom:10px;scrollbar-width:none;flex-shrink:0}.flt::-webkit-scrollbar{display:none}
.fc{padding:7px 14px;border-radius:50px;border:1px solid var(--bd);background:var(--gl);font-family:var(--ff);font-size:12px;font-weight:700;cursor:pointer;white-space:nowrap;transition:.2s;color:var(--txs)}.fc:hover{background:var(--glh)}.fc.a{background:rgba(167,139,204,.18);color:var(--lav);border-color:rgba(167,139,204,.3)}
.steps{display:flex;gap:7px;margin-bottom:16px}.step{flex:1;height:4px;border-radius:2px;background:rgba(255,255,255,.05);transition:.3s}.step.a{background:var(--lavs)}.step.d{background:var(--teal)}
.toast{position:fixed;bottom:90px;left:50%;transform:translateX(-50%);background:rgba(20,24,69,.95);backdrop-filter:blur(12px);color:var(--moon);padding:10px 22px;border-radius:50px;font-size:13px;font-weight:600;z-index:1000;animation:ti .3s ease-out,tto .3s ease-in 2.5s forwards;border:1px solid var(--bd);white-space:nowrap}
@keyframes ti{from{opacity:0;transform:translateX(-50%) translateY(16px)}}@keyframes tto{to{opacity:0;transform:translateX(-50%) translateY(16px)}}
.info{background:rgba(255,212,162,.05);border:1px solid rgba(255,212,162,.12);border-radius:var(--rs);padding:12px 14px;margin-top:14px;font-size:12px;line-height:1.5;color:var(--txs)}.info b{color:var(--warm)}
.fi{animation:fin .3s ease-out;display:flex;flex-direction:column;flex:1;min-height:0;overflow:hidden}@keyframes fin{from{opacity:0;transform:translateY(10px)}}
.tut-steps{display:flex;align-items:center;justify-content:center;gap:0;margin:0 auto 24px;width:280px}
.tut-dot{width:32px;height:32px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:13px;font-weight:800;border:2px solid rgba(255,255,255,.1);background:rgba(255,255,255,.04);color:var(--txd);transition:.3s;font-family:var(--fh)}
.tut-dot.active{border-color:var(--lavs);background:rgba(167,139,204,.2);color:var(--lav)}
.tut-dot.done{border-color:var(--teal);background:rgba(85,230,193,.15);color:var(--teal)}
.tut-line{flex:1;height:2px;background:rgba(255,255,255,.06);transition:.3s}.tut-line.done{background:var(--teal)}
.tut-title{font-family:var(--fh);font-size:24px;font-weight:800;color:var(--moon);text-align:center;margin-bottom:4px}
.tut-sub{font-size:13px;color:var(--txd);text-align:center;margin-bottom:20px;line-height:1.5}
.ico{display:inline-block;vertical-align:middle;flex-shrink:0}
.ver-btns{display:flex;gap:4px;margin-top:4px}.vbtn{padding:2px 10px;border-radius:8px;border:1px solid var(--bd);background:var(--gl);font-family:var(--ff);font-size:10px;font-weight:700;cursor:pointer;transition:.2s;color:var(--txd)}.vbtn:hover{background:var(--glh)}.vbtn.va2{background:rgba(167,139,204,.18);color:var(--lav);border-color:rgba(167,139,204,.3)}
.prewarm{display:flex;align-items:center;gap:6px;padding:8px 12px;border-radius:10px;background:rgba(85,230,193,.06);border:1px solid rgba(85,230,193,.12);margin-top:8px;font-size:12px;color:var(--teal);animation:fin .3s ease-out}
.prewarm .spinner{width:12px;height:12px;border:1.5px solid rgba(85,230,193,.3);border-top-color:var(--teal);border-radius:50%;animation:spin 1s linear infinite;flex-shrink:0}
.slist{flex:1;overflow-y:auto;-webkit-overflow-scrolling:touch;padding-right:4px;margin-right:-4px;padding-bottom:16px;scrollbar-width:thin;scrollbar-color:rgba(255,255,255,.12) transparent}.slist::-webkit-scrollbar{width:4px}.slist::-webkit-scrollbar-track{background:transparent}.slist::-webkit-scrollbar-thumb{background:rgba(255,255,255,.12);border-radius:4px}.slist::-webkit-scrollbar-thumb:hover{background:rgba(255,255,255,.2)}
.vlist{flex:1;overflow-y:auto;-webkit-overflow-scrolling:touch;padding-right:4px;margin-right:-4px;padding-bottom:16px;scrollbar-width:thin;scrollbar-color:rgba(255,255,255,.12) transparent}.vlist::-webkit-scrollbar{width:4px}.vlist::-webkit-scrollbar-track{background:transparent}.vlist::-webkit-scrollbar-thumb{background:rgba(255,255,255,.12);border-radius:4px}
.csbtn{display:flex;align-items:center;gap:8px;width:100%;padding:14px;border-radius:var(--rm);border:1.5px dashed rgba(197,179,230,.3);background:rgba(197,179,230,.04);cursor:pointer;color:var(--lav);font-family:var(--fh);font-size:14px;font-weight:700;transition:.2s;margin-bottom:10px}.csbtn:hover{background:rgba(197,179,230,.1);border-color:rgba(197,179,230,.5)}
.csform{background:var(--gl);border-radius:var(--rm);padding:18px;border:1px solid var(--bd);margin-bottom:10px;animation:fin .2s ease-out;flex-shrink:0}
.csdel{position:absolute;top:8px;right:8px;background:none;border:none;cursor:pointer;opacity:.3;color:var(--txd);padding:4px}.csdel:hover{opacity:.7}
.cmtabs{display:flex;gap:6px;margin-bottom:10px;flex-shrink:0}.cmtab{flex:1;display:flex;flex-direction:column;align-items:center;gap:4px;padding:12px 8px;border-radius:var(--rm);border:1px solid var(--bd);background:var(--gl);cursor:pointer;transition:.2s;font-family:var(--ff);font-size:11px;font-weight:700;color:var(--txs)}.cmtab:hover{background:var(--glh);border-color:rgba(197,179,230,.3)}.cmtab.a{background:rgba(167,139,204,.15);border-color:rgba(167,139,204,.4);color:var(--lav)}
.gencard{background:var(--gl);border-radius:var(--rm);padding:18px;border:1px solid var(--bd);margin-bottom:10px;animation:fin .2s ease-out;position:relative;flex-shrink:0}
.genloading{display:flex;flex-direction:column;align-items:center;gap:12px;padding:24px 0;text-align:center;color:var(--lav);font-size:13px;font-weight:600}
.genloading .spinner{width:28px;height:28px}
.ddmenu{position:absolute;top:48px;right:16px;background:rgba(20,24,69,.97);backdrop-filter:blur(20px);border:1px solid var(--bd);border-radius:var(--rs);padding:6px;min-width:180px;z-index:50;animation:fin .15s ease-out}
.ddi{display:flex;align-items:center;gap:8px;padding:10px 14px;border-radius:10px;cursor:pointer;font-size:13px;font-weight:600;color:var(--txs);transition:.15s;width:100%;background:none;border:none;font-family:var(--ff);text-align:left}.ddi:hover{background:var(--gl);color:var(--tx)}
.ddiv{height:1px;background:var(--bd);margin:4px 8px}
.langsel{display:flex;flex-wrap:wrap;gap:6px;margin:10px 0}.langopt{padding:6px 14px;border-radius:10px;border:1px solid var(--bd);background:var(--gl);font-size:12px;font-weight:700;cursor:pointer;transition:.2s;color:var(--txs);font-family:var(--ff)}.langopt:hover{background:var(--glh)}.langopt.a{background:rgba(167,139,204,.2);color:var(--lav);border-color:rgba(167,139,204,.3)}
[dir=rtl] .sr{flex-direction:row-reverse}[dir=rtl] .si{text-align:right}[dir=rtl] .vc{flex-direction:row-reverse}[dir=rtl] .ct{flex-direction:row-reverse}[dir=rtl] .sh{flex-direction:row-reverse}[dir=rtl] .nav{flex-direction:row-reverse}[dir=rtl] .ddmenu{right:auto;left:16px}[dir=rtl] .ddi{flex-direction:row-reverse;text-align:right}[dir=rtl] .ver-btns{flex-direction:row-reverse}[dir=rtl] .main{direction:rtl}[dir=rtl] .fi{direction:rtl}[dir=rtl] .ss{text-align:right}[dir=rtl] .ra{direction:rtl}[dir=rtl] .ra p{text-align:right;direction:rtl}[dir=rtl] .genst{direction:rtl}[dir=rtl] .card{direction:rtl}[dir=rtl] .prewarm{direction:rtl}[dir=rtl] .info{direction:rtl;text-align:right}[dir=rtl] .flt{direction:rtl}[dir=rtl] .cmtabs{direction:rtl}[dir=rtl] .hdr{flex-direction:row-reverse}[dir=rtl] .vsample{margin-left:0;margin-right:auto}[dir=rtl] .pvb{direction:ltr}
.tl-spinner{display:inline-flex;align-items:center;gap:6px;padding:10px 16px;border-radius:10px;background:rgba(139,111,192,.1);color:var(--lav);font-size:12px;font-weight:600;margin:10px 0}
.tl-spinner .spinner{width:14px;height:14px;border:2px solid rgba(197,179,230,.3);border-top-color:var(--lav);border-radius:50%;animation:spin 1s linear infinite}
.vsample{width:36px;height:36px;border-radius:50%;border:1px solid rgba(85,230,193,.2);background:rgba(85,230,193,.06);display:flex;align-items:center;justify-content:center;cursor:pointer;transition:.2s;flex-shrink:0;margin-left:auto}.vsample:hover{background:rgba(85,230,193,.15);border-color:rgba(85,230,193,.4)}.vsample:active{transform:scale(.9)}
.vsample.playing{animation:vpulse 1s ease-in-out infinite;border-color:rgba(85,230,193,.5);background:rgba(85,230,193,.15)}
@keyframes vpulse{0%,100%{box-shadow:0 0 0 0 rgba(85,230,193,.3)}50%{box-shadow:0 0 0 8px rgba(85,230,193,0)}}
.vsample-tip{font-size:10px;color:var(--txd);text-align:center;margin-top:4px;opacity:.6}
.seed-overlay{position:fixed;inset:0;z-index:100;background:rgba(7,10,31,.95);display:flex;flex-direction:column;align-items:center;justify-content:center;gap:16px;padding:24px}
.seed-progress{width:200px;height:6px;background:rgba(255,255,255,.08);border-radius:3px;overflow:hidden}.seed-fill{height:100%;background:linear-gradient(90deg,var(--lavs),var(--teal));border-radius:3px;transition:width .3s}
@media(max-width:380px){.hdr{padding:10px 14px}.main{padding:0 12px}.pti{font-size:18px}.ra{font-size:13.5px;padding:14px;line-height:1.75}.se{width:46px;height:46px}.sn{font-size:14px}.tut-title{font-size:20px}.rb{width:80px;height:80px}.btn{padding:11px 20px;font-size:15px}.pb{padding:22px 16px}.cb.pp{width:56px;height:56px}.cb{width:40px;height:40px}.wbx{padding:20px 16px}}
@media(min-width:481px){.app{max-width:540px}.ra{font-size:15.5px}}
@media(min-width:768px){.app{max-width:620px}.main{padding:0 24px}.sr{padding:16px}.card{padding:20px}.ra{font-size:17px;line-height:2;padding:24px}.pti{font-size:26px}.pb{padding:32px 24px}.se{width:60px;height:60px;border-radius:16px}.sn{font-size:16px}.tut-title{font-size:28px}.hdr{padding:16px 24px}}
@media(min-width:1024px){.app{max-width:700px}.pb{padding:36px 32px}.ra{font-size:18px;padding:28px}.main{padding:0 28px}}
@media(min-width:1440px){.app{max-width:760px}}
@media(hover:hover){.sr:hover{transform:translateY(-1px);box-shadow:0 4px 12px rgba(0,0,0,.15)}.vc:hover{background:var(--glh)}.btn:hover{filter:brightness(1.08)}}
</style>
</head>
<body>
<div id="root"></div>
<script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.9/babel.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/onnxruntime-web@1.22.0/dist/ort.min.js" crossorigin="anonymous" onerror="console.error('[ORT] Failed to load onnxruntime-web from CDN')"></script>
<script>
// Configure ONNX Runtime WASM paths
if(window.ort){
  ort.env.wasm.wasmPaths='https://cdn.jsdelivr.net/npm/onnxruntime-web@1.22.0/dist/';
  // Mobile browsers lack SharedArrayBuffer (needs COOP/COEP headers), so use single thread
  const hasSharedArrayBuffer=typeof SharedArrayBuffer!=='undefined';
  ort.env.wasm.numThreads=hasSharedArrayBuffer?Math.min(navigator.hardwareConcurrency||2,4):1;
  ort.env.wasm.proxy=false;
  console.log('[ORT] Configured: threads='+ort.env.wasm.numThreads+', SharedArrayBuffer='+hasSharedArrayBuffer);
}else{console.error('[ORT] onnxruntime-web NOT loaded â€” window.ort is undefined')}
</script>
<script type="text/babel">
const{useState,useEffect,useRef,useCallback,useMemo}=React;

// Custom Icon Set - consistent 24x24 viewBox, 1.5px stroke, round caps
function Icon({name,size=24,color='currentColor',className=''}){
  const s={width:size,height:size,display:'inline-block',verticalAlign:'middle',flexShrink:0};
  const p={xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 24 24",fill:"none",stroke:color,strokeWidth:"1.5",strokeLinecap:"round",strokeLinejoin:"round",style:s,className:'ico '+className};
  switch(name){
    case 'book': return(<svg {...p}><path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"/><path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"/><line x1="9" y1="7" x2="16" y2="7"/><line x1="9" y1="11" x2="14" y2="11"/></svg>);
    case 'mic': return(<svg {...p}><path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"/><path d="M19 10v2a7 7 0 0 1-14 0v-2"/><line x1="12" y1="19" x2="12" y2="23"/><line x1="8" y1="23" x2="16" y2="23"/></svg>);
    case 'play': return(<svg {...p}><polygon points="5 3 19 12 5 21 5 3" fill={color} stroke="none"/></svg>);
    case 'pause': return(<svg {...p}><rect x="6" y="4" width="4" height="16" rx="1" fill={color} stroke="none"/><rect x="14" y="4" width="4" height="16" rx="1" fill={color} stroke="none"/></svg>);
    case 'stop': return(<svg {...p}><rect x="5" y="5" width="14" height="14" rx="2" fill={color} stroke="none"/></svg>);
    case 'replay': return(<svg {...p}><polyline points="1 4 1 10 7 10"/><path d="M3.51 15a9 9 0 1 0 2.13-9.36L1 10"/></svg>);
    case 'back': return(<svg {...p}><polyline points="15 18 9 12 15 6"/></svg>);
    case 'check': return(<svg {...p} fill="none"><polyline points="20 6 9 17 4 12" stroke={color} strokeWidth="2"/></svg>);
    case 'sparkle': return(<svg {...p}><path d="M12 2l2 6 6 2-6 2-2 6-2-6-6-2 6-2 2-6z" fill={color} stroke="none"/></svg>);
    case 'moon': return(<svg {...p}><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z" fill={color} stroke="none" opacity=".8"/></svg>);
    case 'castle': return(<svg {...p}><path d="M3 21V11l3-3V5h2v2l4-4 4 4v2h2v3l3 3v10H3z"/><rect x="9" y="14" width="6" height="7" rx="3" stroke={color}/></svg>);
    case 'fox': return(<svg {...p} stroke="none"><path d="M12 20c-4 0-7-2-7-5s1.5-5 3-6.5L10 3l2 3 2-3 2 5.5c1.5 1.5 3 3.5 3 6.5s-3 5-7 5z" fill={color}/><circle cx="9.5" cy="13" r="1" fill="#0B0E2D"/><circle cx="14.5" cy="13" r="1" fill="#0B0E2D"/><ellipse cx="12" cy="15.5" rx="1.5" ry="1" fill="#2D1B0E"/></svg>);
    case 'brain': return(<svg {...p}><path d="M12 2C9 2 7 4 7 6.5c0 .5.1 1 .3 1.5C5.9 9 5 10.5 5 12.5c0 1.5.8 3 2 3.8C7 17 7.5 18 9 19c1 .7 2 1 3 1s2-.3 3-1c1.5-1 2-2 2-2.7 1.2-.8 2-2.3 2-3.8 0-2-1-3.5-2.3-4.5.2-.5.3-1 .3-1.5C17 4 15 2 12 2z"/><path d="M12 2v18" strokeDasharray="2 2" opacity=".3"/></svg>);
    case 'phone': return(<svg {...p}><rect x="5" y="2" width="14" height="20" rx="2" ry="2"/><line x1="12" y1="18" x2="12.01" y2="18" strokeWidth="2"/></svg>);
    case 'trash': return(<svg {...p}><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></svg>);
    case 'right': return(<svg {...p}><polyline points="9 18 15 12 9 6"/></svg>);
    case 'record': return(<svg {...p}><circle cx="12" cy="12" r="8" fill={color} stroke="none"/></svg>);
    case 'user': return(<svg {...p}><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>);
    case 'globe': return(<svg {...p}><circle cx="12" cy="12" r="10"/><line x1="2" y1="12" x2="22" y2="12"/><path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"/></svg>);
    case 'logout': return(<svg {...p}><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" y1="12" x2="9" y2="12"/></svg>);
    case 'plus': return(<svg {...p}><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>);
    case 'wand': return(<svg {...p}><path d="M15 4l5 5-11 11H4v-5L15 4z"/><path d="M13.5 6.5l4 4" opacity=".5"/><circle cx="19" cy="3" r="1" fill={color} stroke="none"/><circle cx="21" cy="7" r=".6" fill={color} stroke="none" opacity=".6"/><circle cx="17" cy="1" r=".5" fill={color} stroke="none" opacity=".4"/></svg>);
    case 'dice': return(<svg {...p}><rect x="3" y="3" width="18" height="18" rx="3"/><circle cx="8.5" cy="8.5" r="1.2" fill={color} stroke="none"/><circle cx="15.5" cy="8.5" r="1.2" fill={color} stroke="none"/><circle cx="12" cy="12" r="1.2" fill={color} stroke="none"/><circle cx="8.5" cy="15.5" r="1.2" fill={color} stroke="none"/><circle cx="15.5" cy="15.5" r="1.2" fill={color} stroke="none"/></svg>);
    case 'pen': return(<svg {...p}><path d="M17 3a2.83 2.83 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5L17 3z"/></svg>);
    default: return null;
  }
}

// â•â•â•â•â•â•â•â•â•â• i18n â•â•â•â•â•â•â•â•â•â•
const LANGS=[
  {c:'en',n:'English',f:'ðŸ‡¬ðŸ‡§',d:'ltr'},
  {c:'he',n:'×¢×‘×¨×™×ª',f:'ðŸ‡®ðŸ‡±',d:'rtl'},
  {c:'es',n:'EspaÃ±ol',f:'ðŸ‡ªðŸ‡¸',d:'ltr'},
  {c:'fr',n:'FranÃ§ais',f:'ðŸ‡«ðŸ‡·',d:'ltr'},
  {c:'ar',n:'Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©',f:'ðŸ‡¸ðŸ‡¦',d:'rtl'},
  {c:'ru',n:'Ð ÑƒÑÑÐºÐ¸Ð¹',f:'ðŸ‡·ðŸ‡º',d:'ltr'},
  {c:'pt',n:'PortuguÃªs',f:'ðŸ‡§ðŸ‡·',d:'ltr'},
  {c:'zh',n:'ä¸­æ–‡',f:'ðŸ‡¨ðŸ‡³',d:'ltr'},
];
const UI={
  en:{whosReading:"Who's reading tonight?",placeholder:"Mom, Dad, Grandma...",getStarted:"Get Started",setupVoice:"Set Up Your Voice",voiceSub:"Record 6-10 seconds reading softly. Your voice will be used to read stories!",pickStory:"Pick a Story",storySub:"Choose tonight's bedtime adventure",startReading:"Start Reading",continue:"Continue",stories:"Stories",voices:"Voices",play:"Play",bedtimeStories:"Bedtime Stories",chooseAdventure:"Choose tonight's adventure",yourVoices:"Your Voices",recSub:"Record 6-10 seconds reading softly",recordVoice:"Record Your Voice",readSoftly:"Read softly for 6-10 seconds",tapRecord:"Tap to record",recording:"Recording",recorded:"Recorded!",nameVoice:"Name this voice",voicePlaceholder:"Mom's bedtime voice",redo:"Redo",save:"Save",clonedVoices:"Cloned Voices",aiClone:"AI voice clone",deviceVoices:"Device Voices",deviceVoice:"Device voice",goodnight:"Goodnight",voice:"Voice",story:"Story",noneSelected:"None selected",change:"Change",pick:"Pick",beginStory:"Begin Story",connected:"Voice ready",connecting:"Preparing voice...",cloneMsg:"Story will be read in YOUR cloned voice.",deviceMsg:"Select a recorded voice for AI cloning, or use device voice.",back:"Back",storyComplete:"Story complete! Sweet dreams.",warming:"Preparing your voice...",cloneReady:"Voice ready!",howClone:"How voice cloning works:",howCloneDesc:"F5-TTS AI runs on your device â€” no servers, no uploads. Your voice never leaves your phone. First use downloads ~200MB (cached after).",all:"All",fairytales:"Fairytales",fables:"Fables",bedtime:"Bedtime",short:"Short",long:"Long",switchUser:"Switch User",language:"Language",settings:"Settings",cloningPart:"Cloning voice: part",gpuWake:"First time may take a moment...",readSample:"The stars twinkled brightly as the little bear drifted off to sleep in the magical forest.",hi:"Hi",translating:"Translating story...",createStory:"Create Your Own Story",storyTitle:"Story title",storyText:"Write or paste your story here...",yourStories:"Your Stories",customStory:"My story",deleteStory:"Delete story?",saveStory:"Save Story",noVoiceWarn:"No voice selected â€” will use device voice.",voiceFailed:"AI voice unavailable â€” using device voice.",classics:"Classics",myStories:"My Stories",writeStory:"Write a story",generateStory:"Generate with AI",surpriseMe:"Surprise me!",describeStory:"Describe your story",descPlaceholder:"A brave little mouse who saves a kingdom...",generating:"Creating your story...",genFailed:"Could not generate story. Try again.",storyFor:"A bedtime story for ages"},
  he:{whosReading:"×ž×™ ×§×•×¨× ×”×œ×™×œ×”?",placeholder:"××ž×, ××‘×, ×¡×‘×ª×...",getStarted:"×‘×•××• × ×ª×—×™×œ",setupVoice:"×”×’×“×¨×ª ×§×•×œ",voiceSub:"×”×§×œ×™×˜×• 6-10 ×©× ×™×•×ª ×©×œ ×§×¨×™××” ×¨×›×”. ×”×§×•×œ ×©×œ×›× ×™×©×ž×© ×œ×§×¨×™××ª ×”×¡×™×¤×•×¨!",pickStory:"×‘×—×¨×• ×¡×™×¤×•×¨",storySub:"×‘×—×¨×• ××ª ×”×¨×¤×ª×§×ª ×”×©×™× ×” ×©×œ ×”×œ×™×œ×”",startReading:"×”×ª×—×œ ×œ×§×¨×•×",continue:"×”×ž×©×š",stories:"×¡×™×¤×•×¨×™×",voices:"×§×•×œ×•×ª",play:"× ×’×Ÿ",bedtimeStories:"×¡×™×¤×•×¨×™ ×©×™× ×”",chooseAdventure:"×‘×—×¨×• ××ª ×”×¨×¤×ª×§×ª ×”×œ×™×œ×”",yourVoices:"×”×§×•×œ×•×ª ×©×œ×›×",recSub:"×”×§×œ×™×˜×• 6-10 ×©× ×™×•×ª ×©×œ ×§×¨×™××” ×¨×›×”",recordVoice:"×”×§×œ×™×˜×• ××ª ×”×§×•×œ ×©×œ×›×",readSoftly:"×§×¨××• ×‘×¨×›×•×ª 6-10 ×©× ×™×•×ª",tapRecord:"×œ×—×¦×• ×œ×”×§×œ×˜×”",recording:"×ž×§×œ×™×˜",recorded:"×”×•×§×œ×˜!",nameVoice:"×ª× ×• ×©× ×œ×§×•×œ",voicePlaceholder:"×§×•×œ ×”×©×™× ×” ×©×œ ××ž×",redo:"×ž×—×“×©",save:"×©×ž×•×¨",clonedVoices:"×§×•×œ×•×ª ×ž×©×•×›×¤×œ×™×",aiClone:"×©×›×¤×•×œ ×§×•×œ AI",deviceVoices:"×§×•×œ×•×ª ×”×ž×›×©×™×¨",deviceVoice:"×§×•×œ ×ž×›×©×™×¨",goodnight:"×œ×™×œ×” ×˜×•×‘",voice:"×§×•×œ",story:"×¡×™×¤×•×¨",noneSelected:"×œ× × ×‘×—×¨",change:"×©× ×”",pick:"×‘×—×¨",beginStory:"×”×ª×—×œ ×¡×™×¤×•×¨",connected:"×”×§×•×œ ×ž×•×›×Ÿ",connecting:"×ž×›×™×Ÿ ××ª ×”×§×•×œ...",cloneMsg:"×”×¡×™×¤×•×¨ ×™×™×§×¨× ×‘×§×•×œ ×”×ž×©×•×›×¤×œ ×©×œ×›×.",deviceMsg:"×‘×—×¨×• ×§×•×œ ×ž×•×§×œ×˜ ×œ×©×›×¤×•×œ AI, ××• ×”×©×ª×ž×©×• ×‘×§×•×œ ×”×ž×›×©×™×¨.",back:"×—×–×¨×”",storyComplete:"×”×¡×™×¤×•×¨ ×”×¡×ª×™×™×! ×—×œ×•×ž×•×ª ×ž×ª×•×§×™×.",warming:"×ž×›×™×Ÿ ××ª ×”×§×•×œ ×©×œ×›×...",cloneReady:"×”×§×•×œ ×ž×•×›×Ÿ!",howClone:"××™×š ×©×›×¤×•×œ ×§×•×œ ×¢×•×‘×“:",howCloneDesc:"F5-TTS AI ×¨×¥ ×¢×œ ×”×ž×›×©×™×¨ ×©×œ×›× â€” ×‘×œ×™ ×©×¨×ª×™×, ×‘×œ×™ ×”×¢×œ××•×ª. ×”×§×•×œ ×œ× ×™×•×¦× ×ž×”×˜×œ×¤×•×Ÿ. ×©×™×ž×•×© ×¨××©×•×Ÿ: ~200MB.",all:"×”×›×œ",fairytales:"××’×“×•×ª",fables:"×ž×©×œ×™×",bedtime:"×©×™× ×”",short:"×§×¦×¨",long:"××¨×•×š",switchUser:"×”×—×œ×£ ×ž×©×ª×ž×©",language:"×©×¤×”",settings:"×”×’×“×¨×•×ª",cloningPart:"×ž×©×›×¤×œ ×§×•×œ: ×—×œ×§",gpuWake:"×‘×¤×¢× ×”×¨××©×•× ×” ×–×” ×™×›×•×œ ×œ×§×—×ª ×¨×’×¢...",readSample:"×”×›×•×›×‘×™× × ×¦× ×¦×• ×‘×©×§×˜ ×›×©×”×“×•×‘ ×”×§×˜×Ÿ × ×¨×“× ×‘×™×¢×¨ ×”×§×¡×•×.",hi:"×”×™×™",translating:"×ž×ª×¨×’× ×¡×™×¤×•×¨...",classics:"×§×œ××¡×™×§×•×ª",myStories:"×”×¡×™×¤×•×¨×™× ×©×œ×™",writeStory:"×›×ª×•×‘ ×¡×™×¤×•×¨",generateStory:"×¦×•×¨ ×¢× AI",surpriseMe:"×”×¤×ª×¢ ××•×ª×™!",describeStory:"×ª××¨ ××ª ×”×¡×™×¤×•×¨ ×©×œ×š",descPlaceholder:"×¢×›×‘×¨ ×§×˜×Ÿ ×•××ž×™×¥ ×©×ž×¦×™×œ ×ž×ž×œ×›×”...",generating:"×™×•×¦×¨ ××ª ×”×¡×™×¤×•×¨ ×©×œ×š...",genFailed:"×œ× ×”×¦×œ×—× ×• ×œ×™×¦×•×¨ ×¡×™×¤×•×¨. × ×¡×• ×©×•×‘.",storyFor:"×¡×™×¤×•×¨ ×©×™× ×” ×œ×’×™×œ××™"},
  es:{whosReading:"Â¿QuiÃ©n lee esta noche?",placeholder:"MamÃ¡, PapÃ¡, Abuela...",getStarted:"Empezar",setupVoice:"Configura tu voz",voiceSub:"Graba 6-10 segundos leyendo suavemente. Â¡Tu voz leerÃ¡ los cuentos!",pickStory:"Elige un cuento",storySub:"Elige la aventura de esta noche",startReading:"Empezar a leer",continue:"Continuar",stories:"Cuentos",voices:"Voces",play:"Play",bedtimeStories:"Cuentos para dormir",chooseAdventure:"Elige la aventura de esta noche",yourVoices:"Tus voces",recSub:"Graba 6-10 segundos leyendo suavemente",recordVoice:"Graba tu voz",readSoftly:"Lee suavemente 6-10 segundos",tapRecord:"Toca para grabar",recording:"Grabando",recorded:"Â¡Grabado!",nameVoice:"Nombre de esta voz",voicePlaceholder:"Voz de mamÃ¡",redo:"Rehacer",save:"Guardar",clonedVoices:"Voces clonadas",aiClone:"Clon de voz AI",deviceVoices:"Voces del dispositivo",deviceVoice:"Voz del dispositivo",goodnight:"Buenas noches",voice:"Voz",story:"Cuento",noneSelected:"No seleccionado",change:"Cambiar",pick:"Elegir",beginStory:"Empezar cuento",connected:"Voz lista",connecting:"Preparando la voz...",cloneMsg:"El cuento se leerÃ¡ con TU voz clonada.",deviceMsg:"Selecciona una voz grabada para clonar, o usa la voz del dispositivo.",back:"Volver",storyComplete:"Â¡Cuento terminado! Dulces sueÃ±os.",warming:"Preparando tu voz...",cloneReady:"Â¡Voz lista!",howClone:"CÃ³mo funciona la clonaciÃ³n:",howCloneDesc:"F5-TTS AI funciona en tu dispositivo â€” sin servidores. Tu voz nunca sale de tu telÃ©fono. Primera vez: ~200MB.",all:"Todo",fairytales:"Cuentos de hadas",fables:"FÃ¡bulas",bedtime:"Dormir",short:"Corto",long:"Largo",switchUser:"Cambiar usuario",language:"Idioma",settings:"Ajustes",cloningPart:"Clonando voz: parte",gpuWake:"La primera vez puede tardar un momento...",readSample:"Las estrellas brillaban suavemente mientras el pequeÃ±o oso se dormÃ­a en el bosque mÃ¡gico.",hi:"Hola",translating:"Traduciendo cuento...",classics:"ClÃ¡sicos",myStories:"Mis cuentos",writeStory:"Escribir cuento",generateStory:"Generar con IA",surpriseMe:"Â¡SorprÃ©ndeme!",describeStory:"Describe tu cuento",descPlaceholder:"Un ratoncito valiente que salva un reino...",generating:"Creando tu cuento...",genFailed:"No se pudo generar. Intenta de nuevo.",storyFor:"Un cuento para edades"},
  fr:{whosReading:"Qui lit ce soir ?",placeholder:"Maman, Papa, Mamie...",getStarted:"Commencer",setupVoice:"Configure ta voix",voiceSub:"Enregistre 6-10 secondes en lisant doucement. Ta voix lira les histoires !",pickStory:"Choisis une histoire",storySub:"Choisis l'aventure de ce soir",startReading:"Commencer la lecture",continue:"Continuer",stories:"Histoires",voices:"Voix",play:"Jouer",bedtimeStories:"Histoires du soir",chooseAdventure:"Choisis l'aventure de ce soir",yourVoices:"Tes voix",recSub:"Enregistre 6-10 secondes en lisant doucement",recordVoice:"Enregistre ta voix",readSoftly:"Lis doucement 6-10 secondes",tapRecord:"Appuie pour enregistrer",recording:"Enregistrement",recorded:"EnregistrÃ© !",nameVoice:"Nom de cette voix",voicePlaceholder:"Voix de maman",redo:"Refaire",save:"Sauvegarder",clonedVoices:"Voix clonÃ©es",aiClone:"Clone vocal IA",deviceVoices:"Voix de l'appareil",deviceVoice:"Voix appareil",goodnight:"Bonne nuit",voice:"Voix",story:"Histoire",noneSelected:"Non sÃ©lectionnÃ©",change:"Changer",pick:"Choisir",beginStory:"Lancer l'histoire",connected:"Voix prÃªte",connecting:"PrÃ©paration de la voix...",cloneMsg:"L'histoire sera lue avec TA voix clonÃ©e.",deviceMsg:"SÃ©lectionne une voix enregistrÃ©e ou utilise la voix de l'appareil.",back:"Retour",storyComplete:"Histoire terminÃ©e ! Fais de beaux rÃªves.",warming:"PrÃ©paration de ta voix...",cloneReady:"Voix prÃªte !",howClone:"Comment Ã§a marche :",howCloneDesc:"F5-TTS AI fonctionne sur ton appareil â€” sans serveur. Ta voix ne quitte jamais ton tÃ©lÃ©phone. Premier usage: ~200MB.",all:"Tout",fairytales:"Contes de fÃ©es",fables:"Fables",bedtime:"Dodo",short:"Court",long:"Long",switchUser:"Changer d'utilisateur",language:"Langue",settings:"ParamÃ¨tres",cloningPart:"Clonage vocal : partie",gpuWake:"La premiÃ¨re fois peut prendre un moment...",readSample:"Les Ã©toiles scintillaient doucement tandis que le petit ours s'endormait dans la forÃªt magique.",hi:"Salut",translating:"Traduction en cours...",classics:"Classiques",myStories:"Mes histoires",writeStory:"Ã‰crire une histoire",generateStory:"GÃ©nÃ©rer avec IA",surpriseMe:"Surprise-moi !",describeStory:"DÃ©cris ton histoire",descPlaceholder:"Une petite souris courageuse qui sauve un royaume...",generating:"CrÃ©ation en cours...",genFailed:"Impossible de gÃ©nÃ©rer. RÃ©essaye.",storyFor:"Une histoire pour Ã¢ges"},
  ar:{whosReading:"Ù…Ù† ÙŠÙ‚Ø±Ø£ Ø§Ù„Ù„ÙŠÙ„Ø©ØŸ",placeholder:"Ù…Ø§Ù…Ø§ØŒ Ø¨Ø§Ø¨Ø§ØŒ Ø¬Ø¯ØªÙŠ...",getStarted:"Ø§Ø¨Ø¯Ø£",setupVoice:"Ø¥Ø¹Ø¯Ø§Ø¯ ØµÙˆØªÙƒ",voiceSub:"Ø³Ø¬Ù‘Ù„ 6-10 Ø«ÙˆØ§Ù†Ù Ù…Ù† Ø§Ù„Ù‚Ø±Ø§Ø¡Ø© Ø¨Ù‡Ø¯ÙˆØ¡. ØµÙˆØªÙƒ Ø³ÙŠÙ‚Ø±Ø£ Ø§Ù„Ù‚ØµØµ!",pickStory:"Ø§Ø®ØªØ± Ù‚ØµØ©",storySub:"Ø§Ø®ØªØ± Ù…ØºØ§Ù…Ø±Ø© Ø§Ù„Ù„ÙŠÙ„Ø©",startReading:"Ø§Ø¨Ø¯Ø£ Ø§Ù„Ù‚Ø±Ø§Ø¡Ø©",continue:"Ù…ØªØ§Ø¨Ø¹Ø©",stories:"Ù‚ØµØµ",voices:"Ø£ØµÙˆØ§Øª",play:"ØªØ´ØºÙŠÙ„",bedtimeStories:"Ù‚ØµØµ Ù‚Ø¨Ù„ Ø§Ù„Ù†ÙˆÙ…",chooseAdventure:"Ø§Ø®ØªØ± Ù…ØºØ§Ù…Ø±Ø© Ø§Ù„Ù„ÙŠÙ„Ø©",yourVoices:"Ø£ØµÙˆØ§ØªÙƒ",recSub:"Ø³Ø¬Ù‘Ù„ 6-10 Ø«ÙˆØ§Ù†Ù Ù…Ù† Ø§Ù„Ù‚Ø±Ø§Ø¡Ø© Ø¨Ù‡Ø¯ÙˆØ¡",recordVoice:"Ø³Ø¬Ù‘Ù„ ØµÙˆØªÙƒ",readSoftly:"Ø§Ù‚Ø±Ø£ Ø¨Ù‡Ø¯ÙˆØ¡ 6-10 Ø«ÙˆØ§Ù†Ù",tapRecord:"Ø§Ø¶ØºØ· Ù„Ù„ØªØ³Ø¬ÙŠÙ„",recording:"Ø¬Ø§Ø±Ù Ø§Ù„ØªØ³Ø¬ÙŠÙ„",recorded:"ØªÙ… Ø§Ù„ØªØ³Ø¬ÙŠÙ„!",nameVoice:"Ø³Ù…Ù‘ Ù‡Ø°Ø§ Ø§Ù„ØµÙˆØª",voicePlaceholder:"ØµÙˆØª Ù…Ø§Ù…Ø§",redo:"Ø¥Ø¹Ø§Ø¯Ø©",save:"Ø­ÙØ¸",clonedVoices:"Ø£ØµÙˆØ§Øª Ù…Ø³ØªÙ†Ø³Ø®Ø©",aiClone:"Ø§Ø³ØªÙ†Ø³Ø§Ø® ØµÙˆØªÙŠ",deviceVoices:"Ø£ØµÙˆØ§Øª Ø§Ù„Ø¬Ù‡Ø§Ø²",deviceVoice:"ØµÙˆØª Ø§Ù„Ø¬Ù‡Ø§Ø²",goodnight:"ØªØµØ¨Ø­ Ø¹Ù„Ù‰ Ø®ÙŠØ±",voice:"ØµÙˆØª",story:"Ù‚ØµØ©",noneSelected:"Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø§Ø®ØªÙŠØ§Ø±",change:"ØªØºÙŠÙŠØ±",pick:"Ø§Ø®ØªØ±",beginStory:"Ø§Ø¨Ø¯Ø£ Ø§Ù„Ù‚ØµØ©",connected:"Ø§Ù„ØµÙˆØª Ø¬Ø§Ù‡Ø²",connecting:"ØªØ­Ø¶ÙŠØ± Ø§Ù„ØµÙˆØª...",cloneMsg:"Ø³ØªÙÙ‚Ø±Ø£ Ø§Ù„Ù‚ØµØ© Ø¨ØµÙˆØªÙƒ Ø§Ù„Ù…Ø³ØªÙ†Ø³Ø®.",deviceMsg:"Ø§Ø®ØªØ± ØµÙˆØªØ§Ù‹ Ù…Ø³Ø¬Ù„Ø§Ù‹ Ø£Ùˆ Ø§Ø³ØªØ®Ø¯Ù… ØµÙˆØª Ø§Ù„Ø¬Ù‡Ø§Ø².",back:"Ø±Ø¬ÙˆØ¹",storyComplete:"Ø§Ù†ØªÙ‡Øª Ø§Ù„Ù‚ØµØ©! Ø£Ø­Ù„Ø§Ù… Ø³Ø¹ÙŠØ¯Ø©.",warming:"ØªØ­Ø¶ÙŠØ± ØµÙˆØªÙƒ...",cloneReady:"Ø§Ù„ØµÙˆØª Ø¬Ø§Ù‡Ø²!",howClone:"ÙƒÙŠÙ ÙŠØ¹Ù…Ù„:",howCloneDesc:"F5-TTS AI ÙŠØ¹Ù…Ù„ Ø¹Ù„Ù‰ Ø¬Ù‡Ø§Ø²Ùƒ â€” Ø¨Ø¯ÙˆÙ† Ø®ÙˆØ§Ø¯Ù…. ØµÙˆØªÙƒ Ù„Ø§ ÙŠØºØ§Ø¯Ø± Ù‡Ø§ØªÙÙƒ. Ø§Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø£ÙˆÙ„: ~200MB.",all:"Ø§Ù„ÙƒÙ„",fairytales:"Ø­ÙƒØ§ÙŠØ§Øª",fables:"Ø®Ø±Ø§ÙØ§Øª",bedtime:"Ù†ÙˆÙ…",short:"Ù‚ØµÙŠØ±",long:"Ø·ÙˆÙŠÙ„",switchUser:"ØªØ¨Ø¯ÙŠÙ„ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…",language:"Ø§Ù„Ù„ØºØ©",settings:"Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª",cloningPart:"Ø§Ø³ØªÙ†Ø³Ø§Ø®: Ø¬Ø²Ø¡",gpuWake:"Ø§Ù„Ù…Ø±Ø© Ø§Ù„Ø£ÙˆÙ„Ù‰ Ù‚Ø¯ ØªØ³ØªØºØ±Ù‚ Ù„Ø­Ø¸Ø©...",readSample:"ØªÙ„Ø£Ù„Ø£Øª Ø§Ù„Ù†Ø¬ÙˆÙ… Ø¨Ù‡Ø¯ÙˆØ¡ Ø¨ÙŠÙ†Ù…Ø§ ØºÙØ§ Ø§Ù„Ø¯Ø¨ Ø§Ù„ØµØºÙŠØ± ÙÙŠ Ø§Ù„ØºØ§Ø¨Ø© Ø§Ù„Ø³Ø­Ø±ÙŠØ©.",hi:"Ù…Ø±Ø­Ø¨Ø§Ù‹",translating:"Ø¬Ø§Ø±Ù ØªØ±Ø¬Ù…Ø© Ø§Ù„Ù‚ØµØ©...",classics:"ÙƒÙ„Ø§Ø³ÙŠÙƒÙŠØ§Øª",myStories:"Ù‚ØµØµÙŠ",writeStory:"Ø§ÙƒØªØ¨ Ù‚ØµØ©",generateStory:"Ø£Ù†Ø´Ø¦ Ø¨Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ",surpriseMe:"ÙØ§Ø¬Ø¦Ù†ÙŠ!",describeStory:"ØµÙ Ù‚ØµØªÙƒ",descPlaceholder:"ÙØ£Ø± ØµØºÙŠØ± Ø´Ø¬Ø§Ø¹ ÙŠÙ†Ù‚Ø° Ù…Ù…Ù„ÙƒØ©...",generating:"Ø¬Ø§Ø±Ù Ø¥Ù†Ø´Ø§Ø¡ Ù‚ØµØªÙƒ...",genFailed:"ØªØ¹Ø°Ø± Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù‚ØµØ©. Ø­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.",storyFor:"Ù‚ØµØ© Ù†ÙˆÙ… Ù„Ù„Ø£Ø¹Ù…Ø§Ø±"},
  ru:{whosReading:"ÐšÑ‚Ð¾ Ñ‡Ð¸Ñ‚Ð°ÐµÑ‚ ÑÐµÐ³Ð¾Ð´Ð½Ñ?",placeholder:"ÐœÐ°Ð¼Ð°, ÐŸÐ°Ð¿Ð°, Ð‘Ð°Ð±ÑƒÑˆÐºÐ°...",getStarted:"ÐÐ°Ñ‡Ð°Ñ‚ÑŒ",setupVoice:"ÐÐ°ÑÑ‚Ñ€Ð¾Ð¹ ÑÐ²Ð¾Ð¹ Ð³Ð¾Ð»Ð¾Ñ",voiceSub:"Ð—Ð°Ð¿Ð¸ÑˆÐ¸ 6-10 ÑÐµÐºÑƒÐ½Ð´ Ñ‚Ð¸Ñ…Ð¾Ð³Ð¾ Ñ‡Ñ‚ÐµÐ½Ð¸Ñ. Ð¢Ð²Ð¾Ð¹ Ð³Ð¾Ð»Ð¾Ñ Ð±ÑƒÐ´ÐµÑ‚ Ñ‡Ð¸Ñ‚Ð°Ñ‚ÑŒ ÑÐºÐ°Ð·ÐºÐ¸!",pickStory:"Ð’Ñ‹Ð±ÐµÑ€Ð¸ ÑÐºÐ°Ð·ÐºÑƒ",storySub:"Ð’Ñ‹Ð±ÐµÑ€Ð¸ Ð¿Ñ€Ð¸ÐºÐ»ÑŽÑ‡ÐµÐ½Ð¸Ðµ Ð½Ð° Ð½Ð¾Ñ‡ÑŒ",startReading:"ÐÐ°Ñ‡Ð°Ñ‚ÑŒ Ñ‡Ñ‚ÐµÐ½Ð¸Ðµ",continue:"ÐŸÑ€Ð¾Ð´Ð¾Ð»Ð¶Ð¸Ñ‚ÑŒ",stories:"Ð¡ÐºÐ°Ð·ÐºÐ¸",voices:"Ð“Ð¾Ð»Ð¾ÑÐ°",play:"Ð˜Ð³Ñ€Ð°Ñ‚ÑŒ",bedtimeStories:"Ð¡ÐºÐ°Ð·ÐºÐ¸ Ð½Ð° Ð½Ð¾Ñ‡ÑŒ",chooseAdventure:"Ð’Ñ‹Ð±ÐµÑ€Ð¸ Ð¿Ñ€Ð¸ÐºÐ»ÑŽÑ‡ÐµÐ½Ð¸Ðµ",yourVoices:"Ð¢Ð²Ð¾Ð¸ Ð³Ð¾Ð»Ð¾ÑÐ°",recSub:"Ð—Ð°Ð¿Ð¸ÑˆÐ¸ 6-10 ÑÐµÐºÑƒÐ½Ð´ Ñ‚Ð¸Ñ…Ð¾Ð³Ð¾ Ñ‡Ñ‚ÐµÐ½Ð¸Ñ",recordVoice:"Ð—Ð°Ð¿Ð¸ÑˆÐ¸ Ð³Ð¾Ð»Ð¾Ñ",readSoftly:"Ð§Ð¸Ñ‚Ð°Ð¹ Ñ‚Ð¸Ñ…Ð¾ 6-10 ÑÐµÐºÑƒÐ½Ð´",tapRecord:"ÐÐ°Ð¶Ð¼Ð¸ Ð´Ð»Ñ Ð·Ð°Ð¿Ð¸ÑÐ¸",recording:"Ð—Ð°Ð¿Ð¸ÑÑŒ",recorded:"Ð—Ð°Ð¿Ð¸ÑÐ°Ð½Ð¾!",nameVoice:"ÐÐ°Ð·Ð²Ð°Ð½Ð¸Ðµ Ð³Ð¾Ð»Ð¾ÑÐ°",voicePlaceholder:"Ð“Ð¾Ð»Ð¾Ñ Ð¼Ð°Ð¼Ñ‹",redo:"Ð—Ð°Ð½Ð¾Ð²Ð¾",save:"Ð¡Ð¾Ñ…Ñ€Ð°Ð½Ð¸Ñ‚ÑŒ",clonedVoices:"ÐšÐ»Ð¾Ð½Ñ‹ Ð³Ð¾Ð»Ð¾ÑÐ¾Ð²",aiClone:"Ð˜Ð˜-ÐºÐ»Ð¾Ð½ Ð³Ð¾Ð»Ð¾ÑÐ°",deviceVoices:"Ð“Ð¾Ð»Ð¾ÑÐ° ÑƒÑÑ‚Ñ€Ð¾Ð¹ÑÑ‚Ð²Ð°",deviceVoice:"Ð“Ð¾Ð»Ð¾Ñ ÑƒÑÑ‚Ñ€Ð¾Ð¹ÑÑ‚Ð²Ð°",goodnight:"Ð¡Ð¿Ð¾ÐºÐ¾Ð¹Ð½Ð¾Ð¹ Ð½Ð¾Ñ‡Ð¸",voice:"Ð“Ð¾Ð»Ð¾Ñ",story:"Ð¡ÐºÐ°Ð·ÐºÐ°",noneSelected:"ÐÐµ Ð²Ñ‹Ð±Ñ€Ð°Ð½Ð¾",change:"Ð˜Ð·Ð¼ÐµÐ½Ð¸Ñ‚ÑŒ",pick:"Ð’Ñ‹Ð±Ñ€Ð°Ñ‚ÑŒ",beginStory:"ÐÐ°Ñ‡Ð°Ñ‚ÑŒ ÑÐºÐ°Ð·ÐºÑƒ",connected:"Ð“Ð¾Ð»Ð¾Ñ Ð³Ð¾Ñ‚Ð¾Ð²",connecting:"ÐŸÐ¾Ð´Ð³Ð¾Ñ‚Ð¾Ð²ÐºÐ° Ð³Ð¾Ð»Ð¾ÑÐ°...",cloneMsg:"Ð¡ÐºÐ°Ð·ÐºÐ° Ð±ÑƒÐ´ÐµÑ‚ Ð¿Ñ€Ð¾Ñ‡Ð¸Ñ‚Ð°Ð½Ð° Ð¢Ð’ÐžÐ˜Ðœ ÐºÐ»Ð¾Ð½Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð½Ñ‹Ð¼ Ð³Ð¾Ð»Ð¾ÑÐ¾Ð¼.",deviceMsg:"Ð’Ñ‹Ð±ÐµÑ€Ð¸ Ð·Ð°Ð¿Ð¸ÑÐ°Ð½Ð½Ñ‹Ð¹ Ð³Ð¾Ð»Ð¾Ñ Ð¸Ð»Ð¸ Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐ¹ Ð³Ð¾Ð»Ð¾Ñ ÑƒÑÑ‚Ñ€Ð¾Ð¹ÑÑ‚Ð²Ð°.",back:"ÐÐ°Ð·Ð°Ð´",storyComplete:"Ð¡ÐºÐ°Ð·ÐºÐ° Ð¾ÐºÐ¾Ð½Ñ‡ÐµÐ½Ð°! Ð¡Ð»Ð°Ð´ÐºÐ¸Ñ… ÑÐ½Ð¾Ð².",warming:"ÐŸÐ¾Ð´Ð³Ð¾Ñ‚Ð¾Ð²ÐºÐ° Ð³Ð¾Ð»Ð¾ÑÐ°...",cloneReady:"Ð“Ð¾Ð»Ð¾Ñ Ð³Ð¾Ñ‚Ð¾Ð²!",howClone:"ÐšÐ°Ðº ÑÑ‚Ð¾ Ñ€Ð°Ð±Ð¾Ñ‚Ð°ÐµÑ‚:",howCloneDesc:"F5-TTS AI Ñ€Ð°Ð±Ð¾Ñ‚Ð°ÐµÑ‚ Ð½Ð° Ð²Ð°ÑˆÐµÐ¼ ÑƒÑÑ‚Ñ€Ð¾Ð¹ÑÑ‚Ð²Ðµ â€” Ð±ÐµÐ· ÑÐµÑ€Ð²ÐµÑ€Ð¾Ð². Ð“Ð¾Ð»Ð¾Ñ Ð½Ðµ Ð¿Ð¾ÐºÐ¸Ð´Ð°ÐµÑ‚ Ñ‚ÐµÐ»ÐµÑ„Ð¾Ð½. ÐŸÐµÑ€Ð²Ñ‹Ð¹ Ñ€Ð°Ð·: ~200MB.",all:"Ð’ÑÐµ",fairytales:"Ð¡ÐºÐ°Ð·ÐºÐ¸",fables:"Ð‘Ð°ÑÐ½Ð¸",bedtime:"Ð¡Ð¾Ð½",short:"ÐšÐ¾Ñ€Ð¾Ñ‚ÐºÐ¸Ð¹",long:"Ð”Ð»Ð¸Ð½Ð½Ñ‹Ð¹",switchUser:"Ð¡Ð¼ÐµÐ½Ð¸Ñ‚ÑŒ",language:"Ð¯Ð·Ñ‹Ðº",settings:"ÐÐ°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ¸",cloningPart:"ÐšÐ»Ð¾Ð½Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ðµ: Ñ‡Ð°ÑÑ‚ÑŒ",gpuWake:"ÐŸÐµÑ€Ð²Ñ‹Ð¹ Ñ€Ð°Ð· Ð¼Ð¾Ð¶ÐµÑ‚ Ð·Ð°Ð½ÑÑ‚ÑŒ Ð¼Ð¸Ð½ÑƒÑ‚ÐºÑƒ...",readSample:"Ð—Ð²Ñ‘Ð·Ð´Ñ‹ Ñ‚Ð¸Ñ…Ð¾ Ð¼ÐµÑ€Ñ†Ð°Ð»Ð¸, Ð¿Ð¾ÐºÐ° Ð¼Ð°Ð»ÐµÐ½ÑŒÐºÐ¸Ð¹ Ð¼ÐµÐ´Ð²ÐµÐ¶Ð¾Ð½Ð¾Ðº Ð·Ð°ÑÑ‹Ð¿Ð°Ð» Ð² Ð²Ð¾Ð»ÑˆÐµÐ±Ð½Ð¾Ð¼ Ð»ÐµÑÑƒ.",hi:"ÐŸÑ€Ð¸Ð²ÐµÑ‚",translating:"ÐŸÐµÑ€ÐµÐ²Ð¾Ð´ ÑÐºÐ°Ð·ÐºÐ¸...",classics:"ÐšÐ»Ð°ÑÑÐ¸ÐºÐ°",myStories:"ÐœÐ¾Ð¸ ÑÐºÐ°Ð·ÐºÐ¸",writeStory:"ÐÐ°Ð¿Ð¸ÑÐ°Ñ‚ÑŒ ÑÐºÐ°Ð·ÐºÑƒ",generateStory:"Ð¡Ð¾Ð·Ð´Ð°Ñ‚ÑŒ Ñ Ð˜Ð˜",surpriseMe:"Ð£Ð´Ð¸Ð²Ð¸ Ð¼ÐµÐ½Ñ!",describeStory:"ÐžÐ¿Ð¸ÑˆÐ¸ ÑÐ²Ð¾ÑŽ ÑÐºÐ°Ð·ÐºÑƒ",descPlaceholder:"Ð¥Ñ€Ð°Ð±Ñ€Ñ‹Ð¹ Ð¼Ñ‹ÑˆÐ¾Ð½Ð¾Ðº, ÐºÐ¾Ñ‚Ð¾Ñ€Ñ‹Ð¹ ÑÐ¿Ð°ÑÐ°ÐµÑ‚ ÐºÐ¾Ñ€Ð¾Ð»ÐµÐ²ÑÑ‚Ð²Ð¾...",generating:"Ð¡Ð¾Ð·Ð´Ð°ÑŽ ÑÐºÐ°Ð·ÐºÑƒ...",genFailed:"ÐÐµ ÑƒÐ´Ð°Ð»Ð¾ÑÑŒ ÑÐ¾Ð·Ð´Ð°Ñ‚ÑŒ. ÐŸÐ¾Ð¿Ñ€Ð¾Ð±ÑƒÐ¹ ÑÐ½Ð¾Ð²Ð°.",storyFor:"Ð¡ÐºÐ°Ð·ÐºÐ° Ð½Ð° Ð½Ð¾Ñ‡ÑŒ Ð´Ð»Ñ Ð²Ð¾Ð·Ñ€Ð°ÑÑ‚Ð°"},
  pt:{whosReading:"Quem lÃª esta noite?",placeholder:"MamÃ£e, Papai, VovÃ³...",getStarted:"ComeÃ§ar",setupVoice:"Configure sua voz",voiceSub:"Grave 6-10 segundos lendo suavemente. Sua voz lerÃ¡ as histÃ³rias!",pickStory:"Escolha uma histÃ³ria",storySub:"Escolha a aventura de hoje",startReading:"ComeÃ§ar a ler",continue:"Continuar",stories:"HistÃ³rias",voices:"Vozes",play:"Play",bedtimeStories:"HistÃ³rias de ninar",chooseAdventure:"Escolha a aventura",yourVoices:"Suas vozes",recSub:"Grave 6-10 segundos lendo suavemente",recordVoice:"Grave sua voz",readSoftly:"Leia suavemente 6-10 seg",tapRecord:"Toque para gravar",recording:"Gravando",recorded:"Gravado!",nameVoice:"Nome desta voz",voicePlaceholder:"Voz da mamÃ£e",redo:"Refazer",save:"Salvar",clonedVoices:"Vozes clonadas",aiClone:"Clone vocal IA",deviceVoices:"Vozes do dispositivo",deviceVoice:"Voz do dispositivo",goodnight:"Boa noite",voice:"Voz",story:"HistÃ³ria",noneSelected:"NÃ£o selecionado",change:"Mudar",pick:"Escolher",beginStory:"Iniciar histÃ³ria",connected:"Voz lista",connecting:"Preparando a voz...",cloneMsg:"A histÃ³ria serÃ¡ lida com SUA voz clonada.",deviceMsg:"Selecione uma voz gravada ou use a voz do dispositivo.",back:"Voltar",storyComplete:"HistÃ³ria completa! Bons sonhos.",warming:"Preparando sua voz...",cloneReady:"Voz pronta!",howClone:"Como funciona:",howCloneDesc:"F5-TTS AI funciona no seu dispositivo â€” sem servidores. Sua voz nunca sai do telefone. Primeiro uso: ~200MB.",all:"Tudo",fairytales:"Contos de fadas",fables:"FÃ¡bulas",bedtime:"Dormir",short:"Curto",long:"Longo",switchUser:"Trocar usuÃ¡rio",language:"Idioma",settings:"ConfiguraÃ§Ãµes",cloningPart:"Clonando: parte",gpuWake:"A primeira vez pode levar um momento...",readSample:"As estrelas brilhavam suavemente enquanto o ursinho adormecia na floresta mÃ¡gica.",hi:"OlÃ¡",translating:"Traduzindo histÃ³ria...",classics:"ClÃ¡ssicos",myStories:"Minhas histÃ³rias",writeStory:"Escrever histÃ³ria",generateStory:"Gerar com IA",surpriseMe:"Me surpreenda!",describeStory:"Descreva sua histÃ³ria",descPlaceholder:"Um ratinho corajoso que salva um reino...",generating:"Criando sua histÃ³ria...",genFailed:"NÃ£o foi possÃ­vel gerar. Tente novamente.",storyFor:"Uma histÃ³ria para idades"},
  zh:{whosReading:"ä»Šæ™šè°æ¥è¯»ï¼Ÿ",placeholder:"å¦ˆå¦ˆã€çˆ¸çˆ¸ã€å¥¶å¥¶...",getStarted:"å¼€å§‹",setupVoice:"è®¾ç½®ä½ çš„å£°éŸ³",voiceSub:"è½»å£°æœ—è¯»6-10ç§’ã€‚ä½ çš„å£°éŸ³å°†ç”¨æ¥æœ—è¯»æ•…äº‹ï¼",pickStory:"é€‰æ‹©æ•…äº‹",storySub:"é€‰æ‹©ä»Šæ™šçš„å†’é™©",startReading:"å¼€å§‹é˜…è¯»",continue:"ç»§ç»­",stories:"æ•…äº‹",voices:"å£°éŸ³",play:"æ’­æ”¾",bedtimeStories:"ç¡å‰æ•…äº‹",chooseAdventure:"é€‰æ‹©ä»Šæ™šçš„å†’é™©",yourVoices:"ä½ çš„å£°éŸ³",recSub:"å½•åˆ¶6-10ç§’è½»å£°æœ—è¯»",recordVoice:"å½•åˆ¶ä½ çš„å£°éŸ³",readSoftly:"è½»å£°æœ—è¯»6-10ç§’",tapRecord:"ç‚¹å‡»å½•åˆ¶",recording:"å½•åˆ¶ä¸­",recorded:"å½•åˆ¶å®Œæˆï¼",nameVoice:"å‘½åè¿™ä¸ªå£°éŸ³",voicePlaceholder:"å¦ˆå¦ˆçš„å£°éŸ³",redo:"é‡åš",save:"ä¿å­˜",clonedVoices:"å…‹éš†å£°éŸ³",aiClone:"AIå£°éŸ³å…‹éš†",deviceVoices:"è®¾å¤‡å£°éŸ³",deviceVoice:"è®¾å¤‡å£°éŸ³",goodnight:"æ™šå®‰",voice:"å£°éŸ³",story:"æ•…äº‹",noneSelected:"æœªé€‰æ‹©",change:"æ›´æ”¹",pick:"é€‰æ‹©",beginStory:"å¼€å§‹æ•…äº‹",connected:"å£°éŸ³å°±ç»ª",connecting:"å‡†å¤‡å£°éŸ³ä¸­...",cloneMsg:"æ•…äº‹å°†ç”¨ä½ å…‹éš†çš„å£°éŸ³æœ—è¯»ã€‚",deviceMsg:"é€‰æ‹©å½•åˆ¶çš„å£°éŸ³è¿›è¡ŒAIå…‹éš†ï¼Œæˆ–ä½¿ç”¨è®¾å¤‡å£°éŸ³ã€‚",back:"è¿”å›ž",storyComplete:"æ•…äº‹ç»“æŸï¼åšä¸ªå¥½æ¢¦ã€‚",warming:"æ­£åœ¨å‡†å¤‡ä½ çš„å£°éŸ³...",cloneReady:"å£°éŸ³å°±ç»ªï¼",howClone:"å·¥ä½œåŽŸç†ï¼š",howCloneDesc:"F5-TTS AIåœ¨ä½ çš„è®¾å¤‡ä¸Šè¿è¡Œâ€”â€”æ— éœ€æœåŠ¡å™¨ã€‚å£°éŸ³ä¸ä¼šç¦»å¼€æ‰‹æœºã€‚é¦–æ¬¡ä½¿ç”¨ä¸‹è½½~200MBã€‚",all:"å…¨éƒ¨",fairytales:"ç«¥è¯",fables:"å¯“è¨€",bedtime:"ç¡å‰",short:"çŸ­ç¯‡",long:"é•¿ç¯‡",switchUser:"åˆ‡æ¢ç”¨æˆ·",language:"è¯­è¨€",settings:"è®¾ç½®",cloningPart:"å…‹éš†å£°éŸ³ï¼šç¬¬",gpuWake:"é¦–æ¬¡å¯èƒ½éœ€è¦ç¨ç­‰ç‰‡åˆ»...",readSample:"æ˜Ÿæ˜Ÿåœ¨å¤œç©ºä¸­é™é™é—ªçƒï¼Œå°ç†Šåœ¨é­”æ³•æ£®æž—é‡Œå®‰ç„¶å…¥ç¡ã€‚",hi:"ä½ å¥½",translating:"æ­£åœ¨ç¿»è¯‘æ•…äº‹...",classics:"ç»å…¸æ•…äº‹",myStories:"æˆ‘çš„æ•…äº‹",writeStory:"å†™æ•…äº‹",generateStory:"AIç”Ÿæˆ",surpriseMe:"éšæœºæƒŠå–œï¼",describeStory:"æè¿°ä½ çš„æ•…äº‹",descPlaceholder:"ä¸€åªå‹‡æ•¢çš„å°è€é¼ æ‹¯æ•‘äº†ä¸€ä¸ªçŽ‹å›½...",generating:"æ­£åœ¨åˆ›ä½œæ•…äº‹...",genFailed:"æ— æ³•ç”Ÿæˆæ•…äº‹ï¼Œè¯·é‡è¯•ã€‚",storyFor:"ç¡å‰æ•…äº‹ï¼Œé€‚åˆå¹´é¾„"},
};
function makeT(lang){return(key)=>(UI[lang]&&UI[lang][key])||UI.en[key]||key}
function getLangDir(lang){const l=LANGS.find(x=>x.c===lang);return l?l.d:'ltr'}

// Voice sample sentences â€” 10 per language, for testing voices
const VOICE_SAMPLES={
en:["Once upon a time, in a land far, far away, the stars began to sing.","The little bear yawned and snuggled into his cozy blanket.","Goodnight moon, goodnight stars, goodnight little ones everywhere.","A gentle breeze carried the fireflies across the sleepy meadow.","The wise old owl watched over the forest as everyone fell asleep.","Twinkle twinkle little star, how I wonder what you are.","The bunny hopped softly through the moonlit garden.","And they all lived happily ever after. The end.","Close your eyes and dream of magical adventures.","The night sky sparkled with a thousand tiny diamonds."],
he:["×¤×¢×, ×‘××¨×¥ ×¨×—×•×§×” ×ž××•×“, ×”×›×•×›×‘×™× ×”×ª×—×™×œ×• ×œ×©×™×¨.","×”×“×•×‘×•×Ÿ ×”×§×˜×Ÿ ×¤×™×”×§ ×•×”×ª×›×¨×‘×œ ×‘×©×ž×™×›×” ×”×—×ž×™×ž×” ×©×œ×•.","×œ×™×œ×” ×˜×•×‘ ×™×¨×—, ×œ×™×œ×” ×˜×•×‘ ×›×•×›×‘×™×, ×œ×™×œ×” ×˜×•×‘ ×™×œ×“×™× ×‘×›×œ ×ž×§×•×.","×¨×•×— ×¢×“×™× ×” × ×©××” ××ª ×”×’×—×œ×™×œ×™×•×ª ×ž×¢×œ ×”×©×“×” ×”× ×¨×“×.","×”×™× ×©×•×£ ×”×–×§×Ÿ ×•×”×—×›× ×©×ž×¨ ×¢×œ ×”×™×¢×¨ ×‘×–×ž×Ÿ ×©×›×•×œ× × ×¨×“×ž×•.","× ×¦× ×¥ × ×¦× ×¥ ×›×•×›×‘ ×§×˜×Ÿ, ××™×š ×× ×™ ×ª×•×”×” ×ž×” ××ª×”.","×”××¨× ×‘×•×Ÿ ×§×¤×¥ ×‘×©×§×˜ ×“×¨×š ×”×’×™× ×” ×ž×•××¨×ª ×”×™×¨×—.","×•×›×•×œ× ×—×™×• ×‘××•×©×¨ ×•×‘×¢×•×©×¨ ×œ×¢×“. ×”×¡×•×£.","×¢×¦×ž×• ××ª ×”×¢×™× ×™×™× ×•×—×œ×ž×• ×¢×œ ×”×¨×¤×ª×§××•×ª ×§×¡×•×ž×•×ª.","×©×ž×™ ×”×œ×™×œ×” × ×¦×¦×• ×‘××œ×£ ×™×”×œ×•×ž×™× ×§×˜× ×˜× ×™×."],
es:["Ã‰rase una vez, en una tierra muy lejana, las estrellas comenzaron a cantar.","El osito bostezÃ³ y se acurrucÃ³ en su manta acogedora.","Buenas noches luna, buenas noches estrellas, buenas noches pequeÃ±os.","Una brisa suave llevÃ³ las luciÃ©rnagas por el prado dormido.","El viejo bÃºho sabio vigilaba el bosque mientras todos dormÃ­an.","Brilla brilla estrellita, cÃ³mo me pregunto quÃ© serÃ¡s.","El conejito saltÃ³ suavemente por el jardÃ­n iluminado por la luna.","Y todos vivieron felices para siempre. Fin.","Cierra los ojos y sueÃ±a con aventuras mÃ¡gicas.","El cielo nocturno brillaba con mil pequeÃ±os diamantes."],
fr:["Il Ã©tait une fois, dans un pays lointain, les Ã©toiles se mirent Ã  chanter.","Le petit ours bÃ¢illa et se blottit dans sa couverture douillette.","Bonne nuit lune, bonne nuit Ã©toiles, bonne nuit les petits.","Une brise douce portait les lucioles Ã  travers la prairie endormie.","Le vieux hibou sage veillait sur la forÃªt pendant que tous dormaient.","Brille brille petite Ã©toile, comme je me demande ce que tu es.","Le petit lapin sautillait doucement dans le jardin Ã©clairÃ© par la lune.","Et ils vÃ©curent tous heureux pour toujours. Fin.","Ferme les yeux et rÃªve d'aventures magiques.","Le ciel nocturne scintillait de mille petits diamants."],
ar:["Ø°Ø§Øª Ù…Ø±Ø©ØŒ ÙÙŠ Ø£Ø±Ø¶ Ø¨Ø¹ÙŠØ¯Ø© Ø¬Ø¯Ø§Ù‹ØŒ Ø¨Ø¯Ø£Øª Ø§Ù„Ù†Ø¬ÙˆÙ… ØªØºÙ†ÙŠ.","ØªØ«Ø§Ø¡Ø¨ Ø§Ù„Ø¯Ø¨ Ø§Ù„ØµØºÙŠØ± ÙˆØªÙ„Ø­Ù Ø¨Ø¨Ø·Ø§Ù†ÙŠØªÙ‡ Ø§Ù„Ø¯Ø§ÙØ¦Ø©.","ØªØµØ¨Ø­ÙˆÙ† Ø¹Ù„Ù‰ Ø®ÙŠØ± ÙŠØ§ Ù‚Ù…Ø±ØŒ ÙŠØ§ Ù†Ø¬ÙˆÙ…ØŒ ÙŠØ§ Ø£Ø·ÙØ§Ù„ ÙÙŠ ÙƒÙ„ Ù…ÙƒØ§Ù†.","Ù†Ø³ÙŠÙ… Ù„Ø·ÙŠÙ Ø­Ù…Ù„ Ø§Ù„ÙŠØ±Ø§Ø¹Ø§Øª Ø¹Ø¨Ø± Ø§Ù„Ù…Ø±Ø¬ Ø§Ù„Ù†Ø§Ø¦Ù….","Ø§Ù„Ø¨ÙˆÙ…Ø© Ø§Ù„Ø¹Ø¬ÙˆØ²Ø© Ø§Ù„Ø­ÙƒÙŠÙ…Ø© Ø­Ø±Ø³Øª Ø§Ù„ØºØ§Ø¨Ø© Ø¨ÙŠÙ†Ù…Ø§ Ù†Ø§Ù… Ø§Ù„Ø¬Ù…ÙŠØ¹.","Ù„Ù…Ø¹ÙŠ Ù„Ù…Ø¹ÙŠ Ø£ÙŠØªÙ‡Ø§ Ø§Ù„Ù†Ø¬Ù…Ø© Ø§Ù„ØµØºÙŠØ±Ø©ØŒ ÙƒÙ… Ø£ØªØ³Ø§Ø¡Ù„ Ù…Ø§ Ø£Ù†ØªÙ.","Ù‚ÙØ² Ø§Ù„Ø£Ø±Ù†Ø¨ Ø¨Ù‡Ø¯ÙˆØ¡ Ø¹Ø¨Ø± Ø§Ù„Ø­Ø¯ÙŠÙ‚Ø© Ø§Ù„Ù…Ø¶Ø§Ø¡Ø© Ø¨Ø§Ù„Ù‚Ù…Ø±.","ÙˆØ¹Ø§Ø´ÙˆØ§ Ø¬Ù…ÙŠØ¹Ø§Ù‹ Ø¨Ø³Ø¹Ø§Ø¯Ø© Ù„Ù„Ø£Ø¨Ø¯. Ø§Ù„Ù†Ù‡Ø§ÙŠØ©.","Ø£ØºÙ…Ø¶ Ø¹ÙŠÙ†ÙŠÙƒ ÙˆØ§Ø­Ù„Ù… Ø¨Ù…ØºØ§Ù…Ø±Ø§Øª Ø³Ø­Ø±ÙŠØ©.","Ø³Ù…Ø§Ø¡ Ø§Ù„Ù„ÙŠÙ„ ØªÙ„Ø£Ù„Ø£Øª Ø¨Ø£Ù„Ù Ù…Ø§Ø³Ø© ØµØºÙŠØ±Ø©."],
ru:["Ð”Ð°Ð²Ð½Ñ‹Ð¼-Ð´Ð°Ð²Ð½Ð¾, Ð² Ð´Ð°Ð»Ñ‘ÐºÐ¾Ð¹ ÑÑ‚Ñ€Ð°Ð½Ðµ, Ð·Ð²Ñ‘Ð·Ð´Ñ‹ Ð½Ð°Ñ‡Ð°Ð»Ð¸ Ð¿ÐµÑ‚ÑŒ.","ÐœÐ°Ð»ÐµÐ½ÑŒÐºÐ¸Ð¹ Ð¼ÐµÐ´Ð²ÐµÐ¶Ð¾Ð½Ð¾Ðº Ð·ÐµÐ²Ð½ÑƒÐ» Ð¸ ÑƒÐºÑƒÑ‚Ð°Ð»ÑÑ Ð² ÑƒÑŽÑ‚Ð½Ð¾Ðµ Ð¾Ð´ÐµÑÐ»Ð¾.","Ð¡Ð¿Ð¾ÐºÐ¾Ð¹Ð½Ð¾Ð¹ Ð½Ð¾Ñ‡Ð¸, Ð»ÑƒÐ½Ð°, ÑÐ¿Ð¾ÐºÐ¾Ð¹Ð½Ð¾Ð¹ Ð½Ð¾Ñ‡Ð¸, Ð·Ð²Ñ‘Ð·Ð´Ñ‹, ÑÐ¿Ð¾ÐºÐ¾Ð¹Ð½Ð¾Ð¹ Ð½Ð¾Ñ‡Ð¸, Ð¼Ð°Ð»Ñ‹ÑˆÐ¸.","ÐÐµÐ¶Ð½Ñ‹Ð¹ Ð²ÐµÑ‚ÐµÑ€Ð¾Ðº Ð½Ñ‘Ñ ÑÐ²ÐµÑ‚Ð»ÑÑ‡ÐºÐ¾Ð² Ñ‡ÐµÑ€ÐµÐ· ÑÐ¾Ð½Ð½Ñ‹Ð¹ Ð»ÑƒÐ³.","ÐœÑƒÐ´Ñ€Ð°Ñ ÑÑ‚Ð°Ñ€Ð°Ñ ÑÐ¾Ð²Ð° Ð¾Ñ…Ñ€Ð°Ð½ÑÐ»Ð° Ð»ÐµÑ, Ð¿Ð¾ÐºÐ° Ð²ÑÐµ Ð·Ð°ÑÑ‹Ð¿Ð°Ð»Ð¸.","ÐœÐµÑ€Ñ†Ð°Ð¹, Ð¼ÐµÑ€Ñ†Ð°Ð¹, Ð¼Ð°Ð»ÐµÐ½ÑŒÐºÐ°Ñ Ð·Ð²ÐµÐ·Ð´Ð°, ÐºÐ°Ðº Ð¼Ð½Ðµ Ð¸Ð½Ñ‚ÐµÑ€ÐµÑÐ½Ð¾, Ñ‡Ñ‚Ð¾ Ñ‚Ñ‹ Ñ‚Ð°ÐºÐ¾Ðµ.","Ð—Ð°Ð¹Ñ‡Ð¸Ðº Ñ‚Ð¸Ñ…Ð¾ Ð¿Ñ€Ñ‹Ð³Ð°Ð» Ð¿Ð¾ Ð»ÑƒÐ½Ð½Ð¾Ð¼Ñƒ ÑÐ°Ð´Ñƒ.","Ð˜ Ð¶Ð¸Ð»Ð¸ Ð¾Ð½Ð¸ Ð´Ð¾Ð»Ð³Ð¾ Ð¸ ÑÑ‡Ð°ÑÑ‚Ð»Ð¸Ð²Ð¾. ÐšÐ¾Ð½ÐµÑ†.","Ð—Ð°ÐºÑ€Ð¾Ð¹ Ð³Ð»Ð°Ð·Ð° Ð¸ Ð¼ÐµÑ‡Ñ‚Ð°Ð¹ Ð¾ Ð²Ð¾Ð»ÑˆÐµÐ±Ð½Ñ‹Ñ… Ð¿Ñ€Ð¸ÐºÐ»ÑŽÑ‡ÐµÐ½Ð¸ÑÑ….","ÐÐ¾Ñ‡Ð½Ð¾Ðµ Ð½ÐµÐ±Ð¾ ÑÐ²ÐµÑ€ÐºÐ°Ð»Ð¾ Ñ‚Ñ‹ÑÑÑ‡ÐµÐ¹ Ð¼Ð°Ð»ÐµÐ½ÑŒÐºÐ¸Ñ… Ð±Ñ€Ð¸Ð»Ð»Ð¸Ð°Ð½Ñ‚Ð¾Ð²."],
pt:["Era uma vez, numa terra muito distante, as estrelas comeÃ§aram a cantar.","O ursinho bocejou e se aconchegou em seu cobertor quentinho.","Boa noite lua, boa noite estrelas, boa noite pequeninos.","Uma brisa suave carregou os vaga-lumes pelo prado adormecido.","A velha coruja sÃ¡bia vigiava a floresta enquanto todos dormiam.","Brilha brilha estrelinha, como eu me pergunto o que vocÃª Ã©.","O coelhinho pulou suavemente pelo jardim iluminado pela lua.","E todos viveram felizes para sempre. Fim.","Feche os olhos e sonhe com aventuras mÃ¡gicas.","O cÃ©u noturno brilhava com mil pequenos diamantes."],
zh:["ä»Žå‰ï¼Œåœ¨ä¸€ä¸ªé¥è¿œçš„åœ°æ–¹ï¼Œæ˜Ÿæ˜Ÿå¼€å§‹å”±æ­Œäº†ã€‚","å°ç†Šæ‰“äº†ä¸ªå“ˆæ¬ ï¼Œç¼©è¿›äº†æ¸©æš–çš„æ¯¯å­é‡Œã€‚","æ™šå®‰æœˆäº®ï¼Œæ™šå®‰æ˜Ÿæ˜Ÿï¼Œæ™šå®‰æ‰€æœ‰çš„å°æœ‹å‹ã€‚","ä¸€é˜µè½»æŸ”çš„å¾®é£ŽæŠŠè¤ç«è™«å¹è¿‡äº†æ²‰ç¡çš„è‰åœ°ã€‚","èªæ˜Žçš„è€çŒ«å¤´é¹°å®ˆæŠ¤ç€æ£®æž—ï¼Œçœ‹ç€å¤§å®¶å…¥ç¡ã€‚","ä¸€é—ªä¸€é—ªäº®æ™¶æ™¶ï¼Œæ»¡å¤©éƒ½æ˜¯å°æ˜Ÿæ˜Ÿã€‚","å°å…”å­åœ¨æœˆå…‰ä¸‹çš„èŠ±å›­é‡Œè½»è½»åœ°è·³ç€ã€‚","ä»Žæ­¤ä»–ä»¬å¹¸ç¦åœ°ç”Ÿæ´»åœ¨ä¸€èµ·ã€‚ç»“å±€ã€‚","é—­ä¸Šçœ¼ç›ï¼Œæ¢¦æƒ³ç¥žå¥‡çš„å†’é™©å§ã€‚","å¤œç©ºé—ªçƒç€æ— æ•°å°é’»çŸ³èˆ¬çš„å…‰èŠ’ã€‚"]
};
let sampleAudioPlaying=null;
async function playVoiceSample(lang,voiceId){
  // Stop any currently playing sample
  if(sampleAudioPlaying){try{sampleAudioPlaying.pause();sampleAudioPlaying.src=''}catch(e){}sampleAudioPlaying=null}
  // Play back the actual recorded voice from DB
  if(voiceId){
    try{
      const d=await dbGet('voices',voiceId);
      if(d?.blob){
        const url=URL.createObjectURL(d.blob);
        const audio=new Audio(url);
        audio.onended=()=>{URL.revokeObjectURL(url);sampleAudioPlaying=null};
        audio.onerror=()=>{URL.revokeObjectURL(url);sampleAudioPlaying=null};
        sampleAudioPlaying=audio;
        await audio.play();
        return;
      }
    }catch(e){console.warn('Voice playback failed:',e)}
  }
  // Fallback: use device TTS
  const sentences=VOICE_SAMPLES[lang]||VOICE_SAMPLES.en;
  const text=sentences[Math.floor(Math.random()*sentences.length)];
  const synth=window.speechSynthesis;if(!synth)return;
  synth.cancel();
  const u=new SpeechSynthesisUtterance(text);u.rate=0.9;u.pitch=1.0;
  const lc=lang==='zh'?'zh-CN':lang;
  const vs=synth.getVoices();
  const pk=vs.find(v=>v.lang.startsWith(lc)&&/female|samantha|karen|tessa/i.test(v.name))||vs.find(v=>v.lang.startsWith(lc))||vs.find(v=>v.lang.startsWith('en'))||vs[0];
  if(pk)u.voice=pk;
  const fakeAudio={pause:()=>synth.cancel(),src:''};
  sampleAudioPlaying=fakeAudio;synth.speak(u);
  u.onend=()=>{sampleAudioPlaying=null};u.onerror=()=>{sampleAudioPlaying=null};
}

// Translated story titles & authors per language
const SN={
s1:{en:'The Three Little Pigs',he:'×©×œ×•×©×ª ×”×—×–×™×¨×•× ×™×',es:'Los tres cerditos',fr:'Les trois petits cochons',ar:'Ø§Ù„Ø®Ù†Ø§Ø²ÙŠØ± Ø§Ù„Ø«Ù„Ø§Ø«Ø© Ø§Ù„ØµØºÙŠØ±Ø©',ru:'Ð¢Ñ€Ð¸ Ð¿Ð¾Ñ€Ð¾ÑÑ‘Ð½ÐºÐ°',pt:'Os trÃªs porquinhos',zh:'ä¸‰åªå°çŒª'},
s2:{en:'Goldilocks and the Three Bears',he:'×–×”×‘×” ×•×©×œ×•×©×ª ×”×“×•×‘×™×',es:'Ricitos de Oro y los tres osos',fr:'Boucle d\'or et les trois ours',ar:'Ø°Ø§Øª Ø§Ù„Ø´Ø¹Ø± Ø§Ù„Ø°Ù‡Ø¨ÙŠ ÙˆØ§Ù„Ø¯Ø¨Ø¨Ø© Ø§Ù„Ø«Ù„Ø§Ø«Ø©',ru:'Ð—Ð»Ð°Ñ‚Ð¾Ð²Ð»Ð°ÑÐºÐ° Ð¸ Ñ‚Ñ€Ð¸ Ð¼ÐµÐ´Ð²ÐµÐ´Ñ',pt:'Cachinhos de Ouro e os trÃªs ursos',zh:'é‡‘å‘å§‘å¨˜å’Œä¸‰åªç†Š'},
s3:{en:'The Ugly Duckling',he:'×”×‘×¨×•×•×–×•×Ÿ ×”×ž×›×•×¢×¨',es:'El patito feo',fr:'Le vilain petit canard',ar:'Ø§Ù„Ø¨Ø·Ø© Ø§Ù„Ù‚Ø¨ÙŠØ­Ø©',ru:'Ð“Ð°Ð´ÐºÐ¸Ð¹ ÑƒÑ‚Ñ‘Ð½Ð¾Ðº',pt:'O patinho feio',zh:'ä¸‘å°é¸­'},
s4:{en:'Jack and the Beanstalk',he:"×’'×§ ×•×¢×¥ ×”×©×¢×•×¢×™×ª",es:'Juan y las habichuelas mÃ¡gicas',fr:'Jack et le haricot magique',ar:'Ø¬Ø§Ùƒ ÙˆØ³Ø§Ù‚ Ø§Ù„ÙØ§ØµÙˆÙ„ÙŠØ§Ø¡',ru:'Ð”Ð¶ÐµÐº Ð¸ Ð±Ð¾Ð±Ð¾Ð²Ñ‹Ð¹ ÑÑ‚ÐµÐ±ÐµÐ»ÑŒ',pt:'JoÃ£o e o pÃ© de feijÃ£o',zh:'æ°å…‹ä¸Žé­”è±†'},
s5:{en:'Little Red Riding Hood',he:'×›×™×¤×” ××“×•×ž×”',es:'Caperucita Roja',fr:'Le Petit Chaperon rouge',ar:'Ø°Ø§Øª Ø§Ù„Ø±Ø¯Ø§Ø¡ Ø§Ù„Ø£Ø­Ù…Ø±',ru:'ÐšÑ€Ð°ÑÐ½Ð°Ñ Ð¨Ð°Ð¿Ð¾Ñ‡ÐºÐ°',pt:'Chapeuzinho Vermelho',zh:'å°çº¢å¸½'},
s6:{en:'The Tortoise and the Hare',he:'×”×¦×‘ ×•×”××¨× ×‘',es:'La tortuga y la liebre',fr:'Le liÃ¨vre et la tortue',ar:'Ø§Ù„Ø³Ù„Ø­ÙØ§Ø© ÙˆØ§Ù„Ø£Ø±Ù†Ø¨',ru:'Ð§ÐµÑ€ÐµÐ¿Ð°Ñ…Ð° Ð¸ Ð·Ð°ÑÑ†',pt:'A tartaruga e a lebre',zh:'é¾Ÿå…”èµ›è·‘'},
s7:{en:'The Princess and the Pea',he:'×”× ×¡×™×›×” ×¢×œ ×’×¨×’×¨ ×”××¤×•× ×”',es:'La princesa y el guisante',fr:'La princesse au petit pois',ar:'Ø§Ù„Ø£Ù…ÙŠØ±Ø© ÙˆØ§Ù„Ø¨Ø§Ø²Ù„Ø§Ø¡',ru:'ÐŸÑ€Ð¸Ð½Ñ†ÐµÑÑÐ° Ð½Ð° Ð³Ð¾Ñ€Ð¾ÑˆÐ¸Ð½Ðµ',pt:'A princesa e a ervilha',zh:'è±Œè±†å…¬ä¸»'},
s8:{en:'The Stars That Came to Play',he:'×”×›×•×›×‘×™× ×©×‘××• ×œ×©×—×§',es:'Las estrellas que vinieron a jugar',fr:'Les Ã©toiles venues jouer',ar:'Ø§Ù„Ù†Ø¬ÙˆÙ… Ø§Ù„ØªÙŠ Ø¬Ø§Ø¡Øª Ù„ØªÙ„Ø¹Ø¨',ru:'Ð—Ð²Ñ‘Ð·Ð´Ñ‹, ÐºÐ¾Ñ‚Ð¾Ñ€Ñ‹Ðµ Ð¿Ñ€Ð¸ÑˆÐ»Ð¸ Ð¸Ð³Ñ€Ð°Ñ‚ÑŒ',pt:'As estrelas que vieram brincar',zh:'æ¥çŽ©è€çš„æ˜Ÿæ˜Ÿ'},
s9:{en:'Snow White',he:'×©×œ×’×™×”',es:'Blancanieves',fr:'Blanche-Neige',ar:'Ø³Ù†Ùˆ ÙˆØ§ÙŠØª',ru:'Ð‘ÐµÐ»Ð¾ÑÐ½ÐµÐ¶ÐºÐ°',pt:'Branca de Neve',zh:'ç™½é›ªå…¬ä¸»'},
s10:{en:'Cinderella',he:'×¡×™× ×“×¨×œ×”',es:'Cenicienta',fr:'Cendrillon',ar:'Ø³Ù†Ø¯Ø±ÙŠÙ„Ø§',ru:'Ð—Ð¾Ð»ÑƒÑˆÐºÐ°',pt:'Cinderela',zh:'ç°å§‘å¨˜'},
s11:{en:'Sleeping Beauty',he:'×”×™×¤×”×¤×™×™×” ×”× ×¨×“×ž×ª',es:'La bella durmiente',fr:'La Belle au bois dormant',ar:'Ø§Ù„Ø¬Ù…ÙŠÙ„Ø© Ø§Ù„Ù†Ø§Ø¦Ù…Ø©',ru:'Ð¡Ð¿ÑÑ‰Ð°Ñ ÐºÑ€Ð°ÑÐ°Ð²Ð¸Ñ†Ð°',pt:'A Bela Adormecida',zh:'ç¡ç¾Žäºº'},
s12:{en:'Hansel and Gretel',he:"×”× ×–×œ ×•×’×¨×˜×œ",es:'Hansel y Gretel',fr:'Hansel et Gretel',ar:'Ù‡Ø§Ù†Ø³Ù„ ÙˆØºØ±ÙŠØªÙ„',ru:'Ð“ÐµÐ½Ð·ÐµÐ»ÑŒ Ð¸ Ð“Ñ€ÐµÑ‚ÐµÐ»ÑŒ',pt:'JoÃ£o e Maria',zh:'éŸ©å¡žå°”ä¸Žæ ¼è•¾ç‰¹'},
};
const SA_TR={en:'Traditional',he:'×ž×¡×•×¨×ª×™',es:'Tradicional',fr:'Traditionnel',ar:'ØªÙ‚Ù„ÙŠØ¯ÙŠ',ru:'Ð¢Ñ€Ð°Ð´Ð¸Ñ†Ð¸Ð¾Ð½Ð½Ð°Ñ',pt:'Tradicional',zh:'ä¼ ç»Ÿ'};
function getStoryTitle(id,lang){return SN[id]?.[lang]||SN[id]?.en||''}
function getStoryAuthor(a,lang){if(a==='Traditional')return SA_TR[lang]||a;if(a==='Tail a Tale Original')return 'Tail a Tale';return a}

// Story Illustrations - unique square SVG icon per story
function StoryIcon({id,size=48}){
  const s={width:size,height:size,display:'block'};
  const p={xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 48 48",fill:"none",style:s};
  switch(id){
    case 's1': // Three Little Pigs - three houses
      return(<svg {...p}>
        <rect x="4" y="28" width="11" height="12" rx="1" fill="#F5D6A0" stroke="#C9A96E" strokeWidth=".5"/>
        <path d="M3 28L9.5 20L16 28" fill="#E8C170" stroke="#C9A96E" strokeWidth=".5"/>
        <line x1="7" y1="22" x2="12" y2="22" stroke="#C9A96E" strokeWidth=".3" opacity=".5"/>
        <rect x="7" y="32" width="4" height="5" rx=".5" fill="#8B6914" opacity=".4"/>
        <rect x="18" y="24" width="12" height="16" rx="1" fill="#B8845A" stroke="#8B6340" strokeWidth=".5"/>
        <path d="M17 24L24 16L31 24" fill="#9B6B42" stroke="#8B6340" strokeWidth=".5"/>
        <line x1="20" y1="18" x2="28" y2="18" stroke="#8B6340" strokeWidth=".3" opacity=".3"/>
        <rect x="21" y="28" width="5" height="6" rx=".5" fill="#5C3D1E" opacity=".4"/>
        <rect x="33" y="20" width="12" height="20" rx="1" fill="#CC4444" stroke="#993333" strokeWidth=".5"/>
        <path d="M32 20L39 10L46 20" fill="#AA3333" stroke="#993333" strokeWidth=".5"/>
        <rect x="36" y="24" width="5" height="6" rx=".5" fill="#FFE4A0" opacity=".5"/>
        <rect x="37" y="32" width="4" height="6" rx=".5" fill="#5C2020" opacity=".5"/>
        <line x1="38.5" y1="24" x2="38.5" y2="30" stroke="#993333" strokeWidth=".3"/>
        <line x1="36" y1="27" x2="41" y2="27" stroke="#993333" strokeWidth=".3"/>
        <circle cx="8" cy="6" r="2" fill="#FFEAA7" opacity=".5"/>
        <circle cx="40" cy="5" r="1.5" fill="#FFEAA7" opacity=".4"/>
      </svg>);
    case 's2': // Goldilocks - three bowls on a table
      return(<svg {...p}>
        <rect x="6" y="26" width="36" height="3" rx="1" fill="#8B6340"/>
        <rect x="8" y="29" width="3" height="12" fill="#6B4320"/><rect x="37" y="29" width="3" height="12" fill="#6B4320"/>
        <ellipse cx="13" cy="24" rx="5" ry="3.5" fill="#E8D4B0" stroke="#C9A96E" strokeWidth=".5"/>
        <ellipse cx="13" cy="22" rx="3.5" ry="1.5" fill="#F5E6C8" opacity=".6"/>
        <path d="M8 24 Q8 20 10 19" stroke="#C9A96E" strokeWidth=".8" fill="none"/>
        <ellipse cx="24" cy="23" rx="6" ry="4" fill="#E8D4B0" stroke="#C9A96E" strokeWidth=".5"/>
        <ellipse cx="24" cy="21" rx="4.5" ry="2" fill="#F5E6C8" opacity=".6"/>
        <path d="M18 23 Q18 18 20 17" stroke="#C9A96E" strokeWidth=".8" fill="none"/>
        <ellipse cx="36" cy="22" rx="7" ry="5" fill="#E8D4B0" stroke="#C9A96E" strokeWidth=".5"/>
        <ellipse cx="36" cy="19.5" rx="5.5" ry="2.5" fill="#F5E6C8" opacity=".6"/>
        <path d="M29 22 Q29 16 31 15" stroke="#C9A96E" strokeWidth=".8" fill="none"/>
        <circle cx="13" cy="22" r="1" fill="#FFBE76" opacity=".5"/>
        <circle cx="24" cy="21" r="1.2" fill="#FFBE76" opacity=".5"/>
        <circle cx="36" cy="19" r="1.5" fill="#FFBE76" opacity=".5"/>
        <path d="M20 8 Q22 4 24 8" stroke="#F5A623" strokeWidth="1.5" fill="none"/>
        <path d="M22 10 Q24 5 26 10" stroke="#F5A623" strokeWidth="1" fill="none" opacity=".5"/>
        <circle cx="24" cy="3" r="1" fill="#FFEAA7" opacity=".6"/>
      </svg>);
    case 's3': // Ugly Duckling - small grey duckling + swan reflection
      return(<svg {...p}>
        <path d="M4 34 Q12 30 24 32 Q36 30 44 34 L44 44 L4 44Z" fill="#3D5A80" opacity=".3"/>
        <path d="M4 36 Q12 33 24 35 Q36 33 44 36 L44 44 L4 44Z" fill="#4A7FB5" opacity=".2"/>
        <ellipse cx="18" cy="24" rx="7" ry="5" fill="#9E9E9E"/>
        <circle cx="13" cy="20" r="4.5" fill="#ABABAB"/>
        <circle cx="11.5" cy="19" r=".8" fill="#333"/>
        <path d="M9 21 L7 20.5 L9 20" fill="#F5A623" stroke="none"/>
        <path d="M25 24 Q28 20 26 18" stroke="#9E9E9E" strokeWidth="1.5" fill="none" strokeLinecap="round"/>
        <path d="M14 38 Q18 36 22 38 Q26 40 30 38" stroke="#FFF" strokeWidth=".8" fill="none" opacity=".3"/>
        <path d="M22 42 Q24 38 26 36 Q28 34 28 30" stroke="#FFF" strokeWidth="1" fill="none" opacity=".25"/>
        <ellipse cx="26" cy="42" rx="5" ry="2.5" fill="#FFF" opacity=".15"/>
        <circle cx="36" cy="8" r="2" fill="#FFEAA7" opacity=".5"/>
        <circle cx="42" cy="12" r="1" fill="#FFEAA7" opacity=".3"/>
      </svg>);
    case 's4': // Jack and the Beanstalk - beanstalk going up into clouds
      return(<svg {...p}>
        <rect x="16" y="36" width="16" height="8" rx="2" fill="#8B6340" opacity=".4"/>
        <path d="M24 40 Q20 30 22 22 Q24 14 20 8 Q18 4 20 0" stroke="#3DC1A3" strokeWidth="3" fill="none" strokeLinecap="round"/>
        <path d="M24 40 Q28 32 26 24 Q24 16 28 10 Q30 6 28 2" stroke="#55E6C1" strokeWidth="2" fill="none" strokeLinecap="round" opacity=".6"/>
        <ellipse cx="18" cy="28" rx="4" ry="2.5" fill="#3DC1A3" opacity=".5"/>
        <ellipse cx="30" cy="20" rx="4" ry="2.5" fill="#55E6C1" opacity=".4"/>
        <ellipse cx="16" cy="14" rx="3.5" ry="2" fill="#3DC1A3" opacity=".4"/>
        <ellipse cx="10" cy="4" rx="10" ry="5" fill="#C5B3E6" opacity=".3"/>
        <ellipse cx="30" cy="3" rx="12" ry="4" fill="#C5B3E6" opacity=".25"/>
        <ellipse cx="20" cy="6" rx="8" ry="4" fill="#FFF" opacity=".1"/>
        <circle cx="12" cy="2" r="1.5" fill="#FFEAA7" opacity=".5"/>
        <circle cx="38" cy="6" r="1.5" fill="#FFEAA7" opacity=".5"/>
        <circle cx="8" cy="42" r="1" fill="#F5A623" opacity=".5"/>
        <circle cx="40" cy="38" r="1.5" fill="#F5A623" opacity=".4"/>
      </svg>);
    case 's5': // Little Red Riding Hood - red hood in forest path
      return(<svg {...p}>
        <rect x="0" y="38" width="48" height="10" fill="#1A3A1A" opacity=".3"/>
        <path d="M0 38 Q12 34 24 36 Q36 34 48 38" fill="#2A5A2A" opacity=".2"/>
        <path d="M6 38 L6 10" stroke="#5C3D1E" strokeWidth="3"/><ellipse cx="6" cy="8" rx="8" ry="10" fill="#2E7D32" opacity=".5"/>
        <path d="M42 38 L42 12" stroke="#5C3D1E" strokeWidth="3"/><ellipse cx="42" cy="10" rx="7" ry="9" fill="#2E7D32" opacity=".4"/>
        <path d="M16 38 Q24 32 32 38" fill="#D4A76A" opacity=".15"/>
        <path d="M24 38 L24 26" stroke="none"/>
        <ellipse cx="24" cy="30" rx="4" ry="3" fill="#CC3333"/>
        <path d="M20 29 Q24 22 28 29" fill="#CC3333"/>
        <circle cx="24" cy="32" r="3" fill="#FFD4A2"/>
        <circle cx="23" cy="31.5" r=".5" fill="#333"/><circle cx="25.5" cy="31.5" r=".5" fill="#333"/>
        <ellipse cx="24" cy="36" rx="3" ry="4" fill="#CC3333" opacity=".8"/>
        <rect x="22" y="34" width="4" height="2" rx="1" fill="#FFF" opacity=".3"/>
        <circle cx="14" cy="4" r="1.5" fill="#FFEAA7" opacity=".6"/>
      </svg>);
    case 's6': // Tortoise and the Hare - tortoise crossing finish line
      return(<svg {...p}>
        <rect x="0" y="36" width="48" height="12" fill="#3DC1A3" opacity=".1"/>
        <path d="M36 10 L36 36" stroke="#FF7979" strokeWidth="1.5" strokeDasharray="3 2"/>
        <path d="M34 8 L38 8" stroke="#FF7979" strokeWidth="2"/>
        <ellipse cx="16" cy="30" rx="8" ry="6" fill="#5C8A3A"/>
        <path d="M8 30 Q10 22 16 20 Q22 22 24 30" fill="#4A7530" stroke="#3A5A20" strokeWidth=".5"/>
        <path d="M10 26 Q16 23 22 26" stroke="#3A5A20" strokeWidth=".4" fill="none"/>
        <path d="M12 28 Q16 25.5 20 28" stroke="#3A5A20" strokeWidth=".4" fill="none"/>
        <circle cx="8" cy="28" r="3" fill="#7BA55A"/>
        <circle cx="7" cy="27.5" r=".6" fill="#222"/>
        <path d="M5 29 L4 28.5" stroke="#7BA55A" strokeWidth=".5"/>
        <ellipse cx="11" cy="34" rx="2" ry="1" fill="#7BA55A"/><ellipse cx="21" cy="34" rx="2" ry="1" fill="#7BA55A"/>
        <ellipse cx="38" cy="20" rx="4" ry="5" fill="#ABABAB" opacity=".3"/>
        <path d="M36 16 Q38 12 40 16" stroke="#ABABAB" strokeWidth="1" fill="none" opacity=".3"/>
        <text x="34" y="6" fill="#FFEAA7" fontSize="5" fontFamily="Quicksand,sans-serif" fontWeight="700" opacity=".6">1st</text>
      </svg>);
    case 's7': // Princess and the Pea - stack of mattresses with pea
      return(<svg {...p}>
        <rect x="10" y="38" width="28" height="3" rx="1" fill="#8B6340"/>
        <rect x="8" y="38" width="2" height="6" fill="#6B4320"/><rect x="38" y="38" width="2" height="6" fill="#6B4320"/>
        <circle cx="24" cy="37" r="1.5" fill="#55E6C1"/>
        <circle cx="24" cy="37" r="2.5" fill="#55E6C1" opacity=".2"/>
        {[0,1,2,3,4,5].map(i=><rect key={i} x={11+i*.3} y={32-i*3} width={26-i*.6} height={2.5} rx="1.2"
          fill={i%2===0?'#C5B3E6':'#FFB8B8'} stroke={i%2===0?'#A78BCC':'#E8A0A0'} strokeWidth=".3" opacity={.7+i*.05}/>)}
        <rect x="13" y="13" width="22" height="2" rx="1" fill="#FFF8DC" opacity=".6"/>
        <ellipse cx="24" cy="12" rx="3" ry="2.5" fill="#FFD4A2"/>
        <circle cx="23" cy="11.5" r=".5" fill="#333"/><circle cx="25.5" cy="11.5" r=".5" fill="#333"/>
        <path d="M21 9 Q24 6 27 9" fill="#C5B3E6"/>
        <circle cx="40" cy="6" r="1.5" fill="#FFEAA7" opacity=".5"/>
        <circle cx="8" cy="8" r="1" fill="#FFEAA7" opacity=".4"/>
      </svg>);
    case 's8': // Stars That Came to Play - playful stars bouncing
      return(<svg {...p}>
        <path d="M24 42 Q26 38 24 36 Q22 34 24 30" stroke="#C5B3E6" strokeWidth="1" fill="none" strokeDasharray="2 1" opacity=".3"/>
        <path d="M12 8 L13.5 13 L18.5 13 L14.5 16 L16 21 L12 18 L8 21 L9.5 16 L5.5 13 L10.5 13Z" fill="#FFEAA7"/>
        <circle cx="12" cy="14.5" r="7" fill="#FFEAA7" opacity=".1"/>
        <circle cx="11" cy="14" r=".6" fill="#333"/><circle cx="13.5" cy="14" r=".6" fill="#333"/>
        <path d="M11 15.5 Q12 16.5 13 15.5" stroke="#333" strokeWidth=".4" fill="none"/>
        <path d="M32 14 L33 17 L36 17 L33.5 19 L34.5 22 L32 20 L29.5 22 L30.5 19 L28 17 L31 17Z" fill="#FFD4A2" opacity=".7"/>
        <path d="M40 6 L40.8 8 L43 8 L41.2 9.3 L42 11.5 L40 10 L38 11.5 L38.8 9.3 L37 8 L39.2 8Z" fill="#C5B3E6" opacity=".6"/>
        <path d="M20 28 L20.6 30 L22.5 30 L21 31 L21.6 33 L20 31.8 L18.4 33 L19 31 L17.5 30 L19.4 30Z" fill="#55E6C1" opacity=".5"/>
        <rect x="18" y="36" width="12" height="8" rx="1" fill="#2A1F5E" opacity=".3"/>
        <rect x="20" y="37" width="3" height="5" fill="#4A7FB5" opacity=".2"/><rect x="25" y="37" width="3" height="5" fill="#4A7FB5" opacity=".2"/>
      </svg>);
    case 's9': // Snow White - poisoned apple with mirror
      return(<svg {...p}>
        <ellipse cx="30" cy="26" rx="10" ry="11" fill="#CC3333"/>
        <ellipse cx="30" cy="26" rx="9" ry="10" fill="#E84444"/>
        <path d="M30 16 Q32 12 34 16" stroke="#5C3D1E" strokeWidth="1" fill="none"/>
        <ellipse cx="30" cy="16.5" rx="2" ry="1" fill="#3DC1A3" opacity=".6"/>
        <ellipse cx="33" cy="22" rx="3" ry="2" fill="#FF6666" opacity=".4"/>
        <path d="M26 32 Q30 36 34 32" fill="#AA2222" opacity=".3"/>
        <ellipse cx="14" cy="20" rx="9" ry="12" fill="#C5B3E6" opacity=".2" stroke="#A78BCC" strokeWidth=".8"/>
        <ellipse cx="14" cy="20" rx="7" ry="10" fill="#1A1345" opacity=".3"/>
        <path d="M11 17 Q14 14 17 17" stroke="#FFF" strokeWidth=".5" fill="none" opacity=".3"/>
        <circle cx="12" cy="20" r=".5" fill="#FFF" opacity=".3"/><circle cx="16" cy="20" r=".5" fill="#FFF" opacity=".3"/>
        <path d="M12 22 Q14 23.5 16 22" stroke="#FFF" strokeWidth=".4" fill="none" opacity=".3"/>
        <circle cx="6" cy="6" r="1.5" fill="#FFEAA7" opacity=".5"/>
        <circle cx="42" cy="8" r="1" fill="#FFEAA7" opacity=".4"/>
      </svg>);
    case 's10': // Cinderella - glass slipper with sparkles
      return(<svg {...p}>
        <path d="M8 36 Q8 28 16 26 L30 26 Q34 26 36 30 Q38 34 40 36 L44 36 Q44 40 40 40 L12 40 Q8 40 8 36Z" fill="#87CEEB" opacity=".4" stroke="#5BACDB" strokeWidth=".5"/>
        <path d="M8 36 Q8 28 16 26 L30 26 Q34 26 36 30 Q38 34 40 36" fill="none" stroke="#FFF" strokeWidth=".3" opacity=".5"/>
        <path d="M16 26 Q20 22 18 18" stroke="#5BACDB" strokeWidth="1" fill="none" strokeLinecap="round"/>
        <path d="M12 34 Q20 30 28 34" stroke="#FFF" strokeWidth=".3" opacity=".3"/>
        <ellipse cx="36" cy="38" rx="4" ry="1" fill="#5BACDB" opacity=".15"/>
        <path d="M14 10 L15 13 L18 13 L15.5 15 L16.5 18 L14 16 L11.5 18 L12.5 15 L10 13 L13 13Z" fill="#FFEAA7" opacity=".7"/>
        <path d="M34 8 L34.8 10.5 L37 10.5 L35.2 12 L36 14.5 L34 13 L32 14.5 L32.8 12 L31 10.5 L33.2 10.5Z" fill="#C5B3E6" opacity=".6"/>
        <circle cx="24" cy="6" r="1" fill="#FFF" opacity=".5"/>
        <circle cx="40" cy="14" r=".8" fill="#FFEAA7" opacity=".4"/>
        <path d="M26 16 L26.5 17.5 L28 17.5 L27 18.5 L27.3 20 L26 19 L24.7 20 L25 18.5 L24 17.5 L25.5 17.5Z" fill="#55E6C1" opacity=".5"/>
      </svg>);
    case 's11': // Sleeping Beauty - rose with thorns and spinning wheel
      return(<svg {...p}>
        <circle cx="32" cy="28" r="10" fill="none" stroke="#8B6340" strokeWidth="1.5"/>
        <circle cx="32" cy="28" r="1.5" fill="#8B6340"/>
        <line x1="32" y1="18" x2="32" y2="24" stroke="#8B6340" strokeWidth=".8"/>
        <line x1="32" y1="32" x2="32" y2="38" stroke="#8B6340" strokeWidth=".8"/>
        <line x1="22" y1="28" x2="28" y2="28" stroke="#8B6340" strokeWidth=".8"/>
        <line x1="36" y1="28" x2="42" y2="28" stroke="#8B6340" strokeWidth=".8"/>
        <line x1="25" y1="21" x2="29" y2="25" stroke="#8B6340" strokeWidth=".6"/>
        <line x1="35" y1="31" x2="39" y2="35" stroke="#8B6340" strokeWidth=".6"/>
        <line x1="32" y1="14" x2="32" y2="12" stroke="#8B6340" strokeWidth="1"/>
        <circle cx="32" cy="11" r="1" fill="#C9A96E"/>
        <circle cx="14" cy="20" r="5" fill="#E84444" opacity=".8"/>
        <circle cx="12" cy="18" r="3.5" fill="#CC3333"/>
        <circle cx="16" cy="17" r="3" fill="#E84444" opacity=".6"/>
        <circle cx="14" cy="22" r="3" fill="#CC3333" opacity=".7"/>
        <path d="M14 26 Q13 32 14 38" stroke="#3DC1A3" strokeWidth="1.5" fill="none"/>
        <path d="M13 30 L11 28" stroke="#3DC1A3" strokeWidth=".8"/><path d="M15 34 L17 32" stroke="#3DC1A3" strokeWidth=".8"/>
        <ellipse cx="14" cy="15" rx="2.5" ry="1.5" fill="#3DC1A3" opacity=".5"/>
        <circle cx="6" cy="6" r="1" fill="#FFEAA7" opacity=".5"/>
      </svg>);
    case 's12': // Hansel and Gretel - gingerbread house
      return(<svg {...p}>
        <path d="M8 24 L24 8 L40 24" fill="#C9A96E" stroke="#8B6340" strokeWidth=".5"/>
        <rect x="10" y="24" width="28" height="18" rx="1" fill="#D4A76A" stroke="#8B6340" strokeWidth=".5"/>
        <circle cx="16" cy="14" r="2" fill="#FF7979" opacity=".7"/>
        <circle cx="32" cy="14" r="2" fill="#55E6C1" opacity=".7"/>
        <circle cx="24" cy="12" r="1.5" fill="#FFEAA7" opacity=".7"/>
        <path d="M8 24 L24 8 L40 24" fill="none" stroke="#FFF" strokeWidth="1" strokeDasharray="2 2" opacity=".3"/>
        <rect x="14" y="28" width="6" height="6" rx=".5" fill="#FFB8B8" opacity=".5" stroke="#E8A0A0" strokeWidth=".3"/>
        <line x1="17" y1="28" x2="17" y2="34" stroke="#E8A0A0" strokeWidth=".3"/>
        <line x1="14" y1="31" x2="20" y2="31" stroke="#E8A0A0" strokeWidth=".3"/>
        <rect x="28" y="28" width="6" height="6" rx=".5" fill="#C5B3E6" opacity=".5" stroke="#A78BCC" strokeWidth=".3"/>
        <line x1="31" y1="28" x2="31" y2="34" stroke="#A78BCC" strokeWidth=".3"/>
        <line x1="28" y1="31" x2="34" y2="31" stroke="#A78BCC" strokeWidth=".3"/>
        <rect x="20" y="34" width="8" height="8" rx="4" fill="#8B6340"/>
        <circle cx="26" cy="37" r="1" fill="#F5A623"/>
        <circle cx="12" cy="36" r="1.5" fill="#FF7979" opacity=".5"/>
        <circle cx="36" cy="36" r="1.5" fill="#55E6C1" opacity=".5"/>
        <circle cx="24" cy="20" r="1" fill="#FFEAA7" opacity=".5"/>
        <path d="M6 24 Q4 22 6 20" stroke="#3DC1A3" strokeWidth="1" fill="none" opacity=".3"/>
        <path d="M42 24 Q44 22 42 20" stroke="#3DC1A3" strokeWidth="1" fill="none" opacity=".3"/>
      </svg>);
    default:
      if(id?.startsWith('cs-'))return(<svg {...p}>
        <rect x="8" y="4" width="24" height="32" rx="3" fill="#C5B3E6" opacity=".2" stroke="#A78BCC" strokeWidth=".5"/>
        <line x1="14" y1="12" x2="28" y2="12" stroke="#A78BCC" strokeWidth=".5" opacity=".4"/>
        <line x1="14" y1="17" x2="26" y2="17" stroke="#A78BCC" strokeWidth=".5" opacity=".3"/>
        <line x1="14" y1="22" x2="24" y2="22" stroke="#A78BCC" strokeWidth=".5" opacity=".3"/>
        <path d="M34 8 L36 6 L40 10 L38 12Z" fill="#FFEAA7" stroke="#C9A96E" strokeWidth=".3"/>
        <line x1="38" y1="12" x2="28" y2="22" stroke="#C9A96E" strokeWidth=".8"/>
        <path d="M12 28 L13.5 32 L17 32 L14.5 34.5 L15.5 38 L12 36 L8.5 38 L9.5 34.5 L7 32 L10.5 32Z" fill="#FFEAA7" opacity=".6"/>
        <circle cx="38" cy="38" r="1" fill="#FFEAA7" opacity=".4"/>
      </svg>);
      return <Icon name="book" size={size} color="var(--lav)"/>;
  }
}

// IndexedDB
const DB='tailatale';const DBV=4;
function openDB(){return new Promise((res,rej)=>{const r=indexedDB.open(DB,DBV);r.onupgradeneeded=e=>{const db=e.target.result;if(!db.objectStoreNames.contains('voices'))db.createObjectStore('voices',{keyPath:'id'});if(!db.objectStoreNames.contains('audioCache'))db.createObjectStore('audioCache',{keyPath:'key'});if(!db.objectStoreNames.contains('translations'))db.createObjectStore('translations',{keyPath:'key'});if(!db.objectStoreNames.contains('customStories'))db.createObjectStore('customStories',{keyPath:'id'});if(!db.objectStoreNames.contains('settings'))db.createObjectStore('settings',{keyPath:'key'})};r.onsuccess=e=>res(e.target.result);r.onerror=e=>rej(e)})}
async function dbPut(s,d){const db=await openDB();return new Promise((res,rej)=>{const tx=db.transaction(s,'readwrite');tx.objectStore(s).put(d);tx.oncomplete=()=>res();tx.onerror=e=>rej(e)})}
async function dbGet(s,k){const db=await openDB();return new Promise((res,rej)=>{const tx=db.transaction(s,'readonly');const r=tx.objectStore(s).get(k);r.onsuccess=()=>res(r.result||null);r.onerror=e=>rej(e)})}
async function dbDel(s,k){const db=await openDB();return new Promise(res=>{const tx=db.transaction(s,'readwrite');tx.objectStore(s).delete(k);tx.oncomplete=()=>res()})}
async function dbGetAll(s){const db=await openDB();return new Promise((res,rej)=>{const tx=db.transaction(s,'readonly');const r=tx.objectStore(s).getAll();r.onsuccess=()=>res(r.result||[]);r.onerror=e=>rej(e)})}

// Translation â€” embedded for built-in stories, Claude API for custom stories only
// Purge any poisoned MyMemory translations from cache on startup
(async()=>{try{const db=await openDB();const tx=db.transaction('translations','readwrite');const store=tx.objectStore('translations');const req=store.getAll();req.onsuccess=()=>{const all=req.result||[];let purged=0;for(const r of all){if(r.text&&typeof r.text==='string'&&(r.text.includes('MYMEMORY')||r.text.includes('QUOTA EXCEEDED')||r.text.includes('QUERY LENGTH LIMIT')||r.text.includes('NO QUERY SPECIFIED')||r.text.toUpperCase()===r.text&&r.text.length>50)){store.delete(r.key);purged++}}if(purged)console.log('[i18n] Purged',purged,'poisoned translation cache entries')}}catch(e){}})();

async function translateText(text,from,to){
  if(from===to)return text;
  const key=`${from}_${to}_${hashCode(text)}`;
  const cached=await dbGet('translations',key).catch(()=>null);
  if(cached&&!cached.text?.includes('MYMEMORY')&&cached.text!==text)return cached.text;
  // Google Translate language codes
  const gLang=(c)=>({zh:'zh-CN',he:'iw'}[c]||c);
  // Strategy 1: Google Translate free API (paragraph by paragraph to preserve structure)
  try{
    const paras=text.split('\n\n');const translated=[];
    for(const p of paras){
      if(!p.trim()){translated.push('');continue}
      const url=`https://translate.googleapis.com/translate_a/single?client=gtx&sl=${gLang(from)}&tl=${gLang(to)}&dt=t&q=${encodeURIComponent(p)}`;
      const r=await fetch(url);
      if(!r.ok)throw new Error('GT '+r.status);
      const d=await r.json();
      translated.push((d[0]||[]).map(s=>s[0]||'').join(''));
    }
    const result=translated.join('\n\n');
    await dbPut('translations',{key,text:result,from,to,ts:Date.now()});
    return result;
  }catch(e){console.warn('Google Translate failed:',e)}
  // Strategy 2: Claude API (works in artifact viewer)
  try{
    const resp=await fetch('https://api.anthropic.com/v1/messages',{
      method:'POST',headers:{'Content-Type':'application/json'},
      body:JSON.stringify({model:'claude-sonnet-4-20250514',max_tokens:4000,
        messages:[{role:'user',content:`Translate the following bedtime story from ${from} to ${to}. Keep the same paragraph structure (separated by double newlines). Output ONLY the translated text, nothing else:\n\n${text}`}]})
    });
    if(!resp.ok)throw new Error('API '+resp.status);
    const d=await resp.json();const result=d?.content?.[0]?.text||text;
    if(result&&result!==text){await dbPut('translations',{key,text:result,from,to,ts:Date.now()});return result}
  }catch(e){console.warn('Claude translation failed:',e)}
  return text;
}
function hashCode(s){let h=0;for(let i=0;i<s.length;i++)h=(h*31+s.charCodeAt(i))&0x7fffffff;return h.toString(36)}

// AI Story Generation via Anthropic API
const SURPRISE_PROMPTS=[
  "a tiny dragon who is afraid of fire and learns to be brave",
  "a cloud that falls from the sky and makes friends on earth",
  "a lost star who finds its way home with help from forest animals",
  "a teddy bear who comes alive at night and goes on adventures",
  "a little fish who dreams of flying and meets a helpful bird",
  "a shy moon who hides behind clouds until the children call her",
  "a magic paintbrush that brings drawings to life",
  "twin kittens who discover a secret garden behind the bookshelf",
  "a sleepy train that carries dreams to children around the world",
  "a brave ladybug who saves her meadow from a big storm",
  "a snowflake who doesn't want to melt and searches for a cold place",
  "a baby owl learning to hoot who accidentally wakes up the whole forest",
];
function getRandomPrompt(){return SURPRISE_PROMPTS[Math.floor(Math.random()*SURPRISE_PROMPTS.length)]}

async function generateStoryAI(description,lang,childName){
  const langName=LANGS.find(l=>l.c===lang)?.n||'English';
  // Always generate in English first (more reliable), then translate if needed
  const prompt=`Write a short, gentle bedtime story (200-300 words) for young children (ages 3-7).

Story idea: ${description}

Requirements:
- Write in English
- Sweet, calming tone perfect for bedtime
- Simple vocabulary for young children
- Include the child's name "${childName}" as a character or the one being told the story
- End peacefully with the character falling asleep or a gentle goodnight
- Use 4-6 short paragraphs separated by blank lines
- Start with a title on the first line, then a blank line, then the story
- Do NOT include any labels like "Title:" â€” just write the title directly`;

  try{
    const r=await fetch("https://api.anthropic.com/v1/messages",{
      method:"POST",headers:{"Content-Type":"application/json"},
      body:JSON.stringify({model:"claude-sonnet-4-20250514",max_tokens:1000,
        messages:[{role:"user",content:prompt}]})
    });
    if(!r.ok){const errText=await r.text().catch(()=>'');console.error('Story gen API error:',r.status,errText);throw new Error('API '+r.status)}
    const d=await r.json();
    const text=d.content?.map(b=>b.text||'').join('\n').trim();
    if(!text)throw new Error('Empty response');
    const lines=text.split('\n');
    let title=lines[0].replace(/^[#*"]+|[#*"]+$/g,'').trim();
    let body=lines.slice(1).join('\n').trim();
    // Translate if non-English
    if(lang!=='en'){
      try{
        const trTitle=await translateText(title,'en',lang);
        const trBody=await translateText(body,'en',lang);
        if(trTitle&&trTitle!==title)title=trTitle;
        if(trBody&&trBody!==body)body=trBody;
      }catch(e){console.warn('Story translation failed, using English:',e)}
    }
    return{title,body};
  }catch(e){
    console.error('Story generation failed:',e);
    return null;
  }
}

// ===== F5-TTS Browser Voice Cloning Engine =====
// Runs 100% locally via ONNX Runtime Web â€” no servers, no quotas, works offline
const F5_REPO='nsarang/F5-TTS-ONNX';
const F5_CDN=`https://huggingface.co/${F5_REPO}/resolve/main/`;
let f5S={enc:null,tf:null,dec:null},f5V=null,f5Loading=false,f5Ready=false,f5Waiters=[];
let f5UseFP16=false; // set during init if WebGPU fp16 is available
let f5DownloadProgress=0,f5DownloadCbs=[];
function onF5Progress(fn){f5DownloadCbs.push(fn);return()=>{f5DownloadCbs=f5DownloadCbs.filter(f=>f!==fn)}}
function notifyF5(p){f5DownloadProgress=p;f5DownloadCbs.forEach(fn=>fn(p))}

// Cached fetch with progress â€” uses Cache API for persistent storage
async function f5Fetch(path,onProg){
  const url=F5_CDN+path;
  console.log('[F5] Fetching:',path);
  try{
    const cache=await caches.open('f5-tts-v1');
    const cached=await cache.match(url);
    if(cached){
      const sz=cached.headers.get('content-length');
      console.log('[F5] âœ“ Cache hit:',path,sz?'('+Math.round(sz/1024/1024)+'MB)':'');
      if(onProg)onProg(1);return cached.arrayBuffer();
    }
    console.log('[F5] â¬‡ Downloading:',path,'...');
    const res=await fetch(url);
    if(!res.ok)throw new Error('HTTP '+res.status+' '+res.statusText+' for '+path);
    const total=parseInt(res.headers.get('content-length'),10);
    const reader=res.body.getReader();const chunks=[];let got=0;let lastLog=0;
    while(true){
      const{done,value}=await reader.read();if(done)break;
      chunks.push(value);got+=value.length;
      if(onProg&&total)onProg(got/total);
      // Log progress every 10%
      if(total&&(got-lastLog)>total*0.1){lastLog=got;console.log('[F5]   '+path+': '+Math.round(got/total*100)+'% ('+Math.round(got/1024/1024)+'MB)')}
    }
    console.log('[F5] âœ“ Downloaded:',path,'('+Math.round(got/1024/1024)+'MB)');
    const blob=new Blob(chunks);
    try{await cache.put(url,new Response(blob.slice()));console.log('[F5]   Cached for offline use')}catch(e){console.warn('[F5]   Cache put failed:',e.message)}
    return blob.arrayBuffer();
  }catch(e){
    console.warn('[F5] Cache API issue, direct fetch:',e.message);
    const res=await fetch(url);if(!res.ok)throw new Error('HTTP '+res.status+' for '+path);
    const buf=await res.arrayBuffer();console.log('[F5] âœ“ Downloaded (no cache):',path,'('+Math.round(buf.byteLength/1024/1024)+'MB)');
    return buf;
  }
}

// Initialize F5-TTS â€” downloads models + creates ONNX sessions
async function initF5(progressCb){
  if(f5Ready){console.log('[F5] Already ready');return true}
  if(f5Loading)return new Promise(r=>f5Waiters.push(r));
  f5Loading=true;
  try{
    // Step 1: Check ORT
    if(!window.ort)throw new Error('ONNX Runtime Web not loaded â€” check network tab for ort.min.js');
    console.log('[F5] ORT available âœ“');

    // Step 2: Detect GPU â†’ choose FP16 or FP32 transformer
    let hasWebGPU=false;
    try{
      if(navigator.gpu){const a=await navigator.gpu.requestAdapter();if(a){hasWebGPU=true;console.log('[F5] WebGPU available â†’ using FP16 transformer (~85MB)')}}
    }catch(e){console.log('[F5] WebGPU not available')}
    if(!hasWebGPU)console.log('[F5] Using WASM + FP32 transformer (~170MB)');
    f5UseFP16=hasWebGPU;
    const tfPath=f5UseFP16?'onnx/transformer_fp16.onnx':'onnx/transformer_fp32.onnx';

    const pg={e:0,t:0,d:0,v:0};
    const up=()=>{const p=pg.e*.03+pg.t*.92+pg.d*.03+pg.v*.02;notifyF5(p);if(progressCb)progressCb(p)};

    // Step 3: Download all files
    console.log('[F5] Downloading models...');
    const t0=Date.now();
    let eBuf,tBuf,dBuf,vocText;
    try{
      [eBuf,tBuf,dBuf,vocText]=await Promise.all([
        f5Fetch('onnx/encoder_fp32.onnx',p=>{pg.e=p;up()}),
        f5Fetch(tfPath,p=>{pg.t=p;up()}),
        f5Fetch('onnx/decoder_fp32.onnx',p=>{pg.d=p;up()}),
        f5Fetch('vocab.txt').then(b=>{pg.v=1;up();return new TextDecoder().decode(b)})
      ]);
    }catch(dlErr){throw new Error('Model download failed: '+dlErr.message)}
    console.log('[F5] âœ“ All downloads in '+((Date.now()-t0)/1000).toFixed(1)+'s');

    // Step 4: Create ONNX sessions
    let eps=hasWebGPU?['webgpu','wasm']:['wasm'];
    const so={executionProviders:eps};

    console.log('[F5] Creating encoder session...');
    f5S.enc=await ort.InferenceSession.create(eBuf,so);
    console.log('[F5] âœ“ Encoder. In:',f5S.enc.inputNames,'Out:',f5S.enc.outputNames);

    console.log('[F5] Creating transformer session (largest model, please wait)...');
    f5S.tf=await ort.InferenceSession.create(tBuf,so);
    console.log('[F5] âœ“ Transformer. In:',f5S.tf.inputNames,'Out:',f5S.tf.outputNames);

    console.log('[F5] Creating decoder session...');
    f5S.dec=await ort.InferenceSession.create(dBuf,so);
    console.log('[F5] âœ“ Decoder. In:',f5S.dec.inputNames,'Out:',f5S.dec.outputNames);

    // Step 5: Load vocab
    f5V={};
    vocText.split('\n').forEach((line,i)=>{const ch=line.replace(/\r/g,'');if(ch.length>0)f5V[ch]=i});
    console.log('[F5] âœ“ Vocab:',Object.keys(f5V).length,'chars');

    f5Ready=true;f5Loading=false;notifyF5(1);
    f5Waiters.forEach(r=>r(true));f5Waiters=[];
    console.log('[F5] âœ… Ready! Total init: '+((Date.now()-t0)/1000).toFixed(1)+'s');
    return true;
  }catch(e){
    console.error('[F5] âŒ Init FAILED:',e.message,e);
    f5Loading=false;f5Ready=false;
    f5Waiters.forEach(r=>r(false));f5Waiters=[];
    throw e;
  }
}

// Tensor math on raw Float32Arrays
function arrRMS(d){let s=0;for(let i=0;i<d.length;i++)s+=d[i]*d[i];return Math.sqrt(s/d.length)}
function arrToInt16(d,q=0.999){const a=Float32Array.from(d,v=>Math.abs(v));a.sort();const mx=a[Math.min(Math.floor(a.length*q),a.length-1)];const sc=mx>0?32767/mx:1;const r=new Int16Array(d.length);for(let i=0;i<d.length;i++)r[i]=Math.max(-32768,Math.min(32767,Math.round(d[i]*sc)));return r}

// Float32â†”Float16 conversion for WebGPU FP16 transformer
function f32ToF16(f32arr){
  const u16=new Uint16Array(f32arr.length);
  const buf32=new Float32Array(1),ubuf=new Uint32Array(buf32.buffer);
  for(let i=0;i<f32arr.length;i++){
    buf32[0]=f32arr[i];const u=ubuf[0];
    const s=(u>>16)&0x8000,e=((u>>23)&0xff)-127+15,f=(u>>13)&0x3ff;
    u16[i]=e<=0?s:e>=31?s|0x7c00:s|(e<<10)|f;
  }
  return u16;
}
function f16ToF32(u16arr){
  const f32=new Float32Array(u16arr.length);
  const buf32=new Float32Array(1),ubuf=new Uint32Array(buf32.buffer);
  for(let i=0;i<u16arr.length;i++){
    const h=u16arr[i],s=(h&0x8000)<<16,e=(h>>10)&0x1f,f=h&0x3ff;
    if(e===0){f32[i]=0;continue}
    if(e===31){ubuf[0]=s|0x7f800000|(f<<13);f32[i]=buf32[0];continue}
    ubuf[0]=s|((e-15+127)<<23)|(f<<13);f32[i]=buf32[0];
  }
  return f32;
}
function toFP16Tensor(ortTensor){
  const d=ortTensor.data instanceof Float32Array?ortTensor.data:new Float32Array(ortTensor.data);
  return new ort.Tensor('float16',f32ToF16(d),ortTensor.dims);
}
function toFP32Tensor(ortTensor){
  if(ortTensor.type==='float32')return ortTensor;
  const d=ortTensor.data instanceof Uint16Array?ortTensor.data:new Uint16Array(ortTensor.data);
  return new ort.Tensor('float32',f16ToF32(d),ortTensor.dims);
}

// F5-TTS 3-stage inference pipeline
async function f5Infer(refF32,refText,genText,speed=1.0,nfe=8){
  const{enc,tf,dec}=f5S;const hop=256,tgtRMS=0.1;
  // Normalize RMS
  let audio=refF32;const rms=arrRMS(audio);
  console.log('[F5] Ref audio: '+audio.length+' samples, rms='+rms.toFixed(4));
  if(rms>0&&rms<tgtRMS){audio=new Float32Array(audio.length);for(let i=0;i<refF32.length;i++)audio[i]=refF32[i]/(rms*tgtRMS)}
  // To int16
  const i16=arrToInt16(audio);
  const audioT=new ort.Tensor('int16',i16,[1,1,i16.length]);
  // Tokenize
  const combined=refText+' '+genText;
  const toks=Int32Array.from([...combined].map(c=>f5V[c]||0));
  const unkCount=[...combined].filter(c=>!f5V[c]).length;
  if(unkCount>0)console.warn('[F5] Unknown chars:',unkCount,'/',combined.length);
  const textT=new ort.Tensor('int32',toks,[1,toks.length]);
  // Duration
  const refLen=Math.trunc(audio.length/hop);
  const dur=refLen+Math.trunc(((refLen/(refText.length+1))*genText.length)/speed);
  const durT=new ort.Tensor('int64',new BigInt64Array([BigInt(dur)]),[1]);
  console.log('[F5] Frames: ref='+refLen+' total='+dur+' | NFE='+nfe+' | FP16='+f5UseFP16);

  // Stage 1: Encoder (always fp32)
  console.log('[F5] Stage 1/3: Encoder...');
  const t1=Date.now();
  const eI={};eI[enc.inputNames[0]]=audioT;eI[enc.inputNames[1]]=textT;eI[enc.inputNames[2]]=durT;
  const eO=await enc.run(eI);
  let noise=eO[enc.outputNames[0]],rcq=eO[enc.outputNames[1]],rsq=eO[enc.outputNames[2]],
      rck=eO[enc.outputNames[3]],rsk=eO[enc.outputNames[4]],cmt=eO[enc.outputNames[5]],
      cmtd=eO[enc.outputNames[6]],rsl=eO[enc.outputNames[7]];
  console.log('[F5] Encoder done ('+((Date.now()-t1)/1000).toFixed(1)+'s). Noise:',noise.dims);

  // Convert to FP16 for transformer if using FP16 model
  if(f5UseFP16){
    try{noise=toFP16Tensor(noise);rcq=toFP16Tensor(rcq);rsq=toFP16Tensor(rsq);
    rck=toFP16Tensor(rck);rsk=toFP16Tensor(rsk);cmt=toFP16Tensor(cmt);cmtd=toFP16Tensor(cmtd);
    console.log('[F5] Converted encoder outputs to FP16')}catch(e){console.warn('[F5] FP16 conversion failed, using FP32:',e.message);f5UseFP16=false}
  }

  // Stage 2: Transformer NFE loop
  console.log('[F5] Stage 2/3: Transformer ('+nfe+' steps)...');
  const t2=Date.now();
  let ts=new ort.Tensor('int32',new Int32Array([0]),[1]);
  for(let s=0;s<nfe-1;s++){
    const stepT=Date.now();
    const tI={};tI[tf.inputNames[0]]=noise;tI[tf.inputNames[1]]=rcq;tI[tf.inputNames[2]]=rsq;
    tI[tf.inputNames[3]]=rck;tI[tf.inputNames[4]]=rsk;tI[tf.inputNames[5]]=cmt;
    tI[tf.inputNames[6]]=cmtd;tI[tf.inputNames[7]]=ts;
    const tO=await tf.run(tI);noise=tO[tf.outputNames[0]];ts=tO[tf.outputNames[1]];
    console.log('[F5]   Step '+(s+1)+'/'+(nfe-1)+' ('+((Date.now()-stepT)/1000).toFixed(1)+'s)');
    await new Promise(r=>setTimeout(r,0)); // yield to UI
  }
  console.log('[F5] Transformer done ('+((Date.now()-t2)/1000).toFixed(1)+'s total)');

  // Convert back to FP32 for decoder
  if(f5UseFP16)noise=toFP32Tensor(noise);

  // Stage 3: Decoder
  console.log('[F5] Stage 3/3: Decoder...');
  const t3=Date.now();
  const dI={};dI[dec.inputNames[0]]=noise;dI[dec.inputNames[1]]=rsl;
  const dO=await dec.run(dI);
  const raw=dO[dec.outputNames[0]].data;
  console.log('[F5] Decoder done ('+((Date.now()-t3)/1000).toFixed(1)+'s). Output: '+raw.length+' samples');
  const out=new Float32Array(raw.length);
  for(let i=0;i<raw.length;i++)out[i]=(typeof raw[i]==='number'?raw[i]:Number(raw[i]))/32767.0;
  // Revert RMS
  if(rms>0&&rms<tgtRMS){for(let i=0;i<out.length;i++)out[i]*=(rms/tgtRMS)}
  console.log('[F5] âœ… Generated '+out.length+' samples ('+(out.length/24000).toFixed(1)+'s audio) in '+((Date.now()-t1)/1000).toFixed(1)+'s');
  return out;
}

// Float32Array â†’ WAV Blob
function f32ToWav(samples,sr=24000){
  const buf=new ArrayBuffer(44+samples.length*2);const v=new DataView(buf);
  const ws=(o,s)=>{for(let i=0;i<s.length;i++)v.setUint8(o+i,s.charCodeAt(i))};
  ws(0,'RIFF');v.setUint32(4,36+samples.length*2,true);ws(8,'WAVE');ws(12,'fmt ');
  v.setUint32(16,16,true);v.setUint16(20,1,true);v.setUint16(22,1,true);v.setUint32(24,sr,true);
  v.setUint32(28,sr*2,true);v.setUint16(32,2,true);v.setUint16(34,16,true);
  ws(36,'data');v.setUint32(40,samples.length*2,true);
  let o=44;for(let i=0;i<samples.length;i++){const s=Math.max(-1,Math.min(1,samples[i]));v.setInt16(o,s<0?s*0x8000:s*0x7FFF,true);o+=2}
  return new Blob([buf],{type:'audio/wav'});
}

// Decode voice recording â†’ 24kHz mono Float32Array
async function decodeRefAudio(voiceBlob){
  const ctx=new(window.AudioContext||window.webkitAudioContext)({sampleRate:24000});
  const ab=voiceBlob instanceof Blob?await voiceBlob.arrayBuffer():voiceBlob;
  const audio=await ctx.decodeAudioData(ab);ctx.close();
  let mono;
  if(audio.numberOfChannels===1)mono=new Float32Array(audio.getChannelData(0));
  else{mono=new Float32Array(audio.length);for(let ch=0;ch<audio.numberOfChannels;ch++){const d=audio.getChannelData(ch);for(let i=0;i<audio.length;i++)mono[i]+=d[i]}for(let i=0;i<mono.length;i++)mono[i]/=audio.numberOfChannels}
  const max=10*24000;if(mono.length>max)mono=mono.slice(0,max);
  return mono;
}

// Cache decoded ref audio per voice (avoids re-decoding every chunk)
let refAudioCache={id:null,f32:null};
async function getRefAudio(voiceBlob,voiceId){
  if(refAudioCache.id===voiceId&&refAudioCache.f32)return refAudioCache.f32;
  const f32=await decodeRefAudio(voiceBlob);
  refAudioCache={id:voiceId,f32};return f32;
}

// ===== Main generateChunk â€” F5-TTS local voice cloning =====
let generateLock=false;
async function generateChunk(text,voiceBlob,langCode){
  while(generateLock)await new Promise(r=>setTimeout(r,200));
  generateLock=true;
  try{
    const lang=langCode||'en';
    const refText=UI[lang]?.readSample||UI.en.readSample;
    // Ensure F5-TTS is loaded (first call downloads ~200MB, cached after)
    if(!f5Ready){
      console.log('[F5] First use â€” loading voice engine...');
      await initF5(p=>console.log('[F5] Download:',Math.round(p*100)+'%'));
    }
    if(!f5Ready)throw new Error('F5-TTS failed to initialize');
    // Get reference audio (decoded & cached)
    console.log('[F5] Decoding reference audio...');
    const refF32=await getRefAudio(voiceBlob,'current');
    console.log('[F5] Ref audio decoded:',refF32.length,'samples ('+(refF32.length/24000).toFixed(1)+'s)');
    // Run inference
    console.log('[F5] Generating speech for:',text.substring(0,60)+'...');
    const t0=Date.now();
    const audioF32=await f5Infer(refF32,refText,text,1.0,16);
    console.log('[F5] âœ… Generated',audioF32.length,'samples in',(Date.now()-t0)/1000,'s');
    return f32ToWav(audioF32,24000);
  }catch(err){
    console.error('[F5] âŒ generateChunk failed:',err.message,err);
    throw err;
  }finally{generateLock=false}
}
function chunkText(text,maxLen=280){const sentences=text.match(/[^.!?ã€‚ï¼ï¼Ÿ]+[.!?ã€‚ï¼ï¼Ÿ]+[\s"]*/g)||[text];const chunks=[];let cur='';for(const s of sentences){if((cur+s).length>maxLen&&cur){chunks.push(cur.trim());cur=s}else cur+=s}if(cur.trim())chunks.push(cur.trim());return chunks}

// Voice pre-warm: download F5-TTS models + validate voice
let preWarmStatus={active:false,done:false,error:false,progress:0};let preWarmListeners=[];
function onPreWarmChange(fn){preWarmListeners.push(fn);return()=>{preWarmListeners=preWarmListeners.filter(f=>f!==fn)}}
function notifyPreWarm(){preWarmListeners.forEach(fn=>fn({...preWarmStatus}))}
async function preWarmVoice(voiceId){
  preWarmStatus={active:true,done:false,error:false,progress:0};notifyPreWarm();
  try{
    const d=await dbGet('voices',voiceId);if(!d?.blob)throw new Error('No voice');
    console.log('[F5] Pre-warming: downloading models if needed...');
    await initF5(p=>{preWarmStatus.progress=p;notifyPreWarm()});
    // Quick test decode of reference audio
    await decodeRefAudio(d.blob);
    preWarmStatus={active:false,done:true,error:false,progress:1};notifyPreWarm();
    console.log('[F5] Pre-warm complete! Models cached for offline use.');
  }catch(e){
    console.warn('[F5] Pre-warm failed:',e);
    preWarmStatus={active:false,done:false,error:true,progress:0};notifyPreWarm();
  }
}

// Stories - each has txS (short ~2-3min) and txL (long ~6-8min)
const S=[
{id:'s1',t:'The Three Little Pigs',a:'Traditional',c:'fairytale',age:'3-6',mS:2,mL:6,
txS:"Once upon a time, three little pigs left home to build their own houses. The first pig built a straw house. The second pig built a stick house. The third pig built a strong brick house.\n\nA big bad wolf came and blew down the straw house! The pig ran to his brother. The wolf blew down the stick house too! Both pigs ran to the brick house.\n\nThe wolf huffed and puffed, but he could NOT blow down the brick house! He tried the chimney, but the smart pig had hot water waiting. The wolf ran away forever.\n\nThe three pigs lived happily ever after. The End.",
txL:"Once upon a time, there were three little pigs who lived with their mother in a cozy cottage at the edge of a meadow. One sunny morning, their mother called them together. \"My dear little pigs, you are all grown up now. It is time for you to go out into the world and build your own houses.\"\n\nShe packed each pig a little lunch and kissed them goodbye. \"Remember,\" she said, \"always do your very best work.\"\n\nThe first little pig was very lazy. He found a farmer selling straw and thought, \"This will be easy!\" He piled up the straw, tied it together, and in just one afternoon, his house was done. \"This will do just fine!\" he said, and spent the rest of the day playing in the sunshine.\n\nThe second little pig was a bit more careful. He gathered sticks from the forest and wove them together. It took him two days. \"Good enough for me!\" he said happily.\n\nBut the third little pig was the wisest of all. He bought bricks and mortar and spent many long days building his house. His brothers laughed at him. \"Why work so hard?\" they teased. But the third pig kept building. He added a strong door, a fireplace, and even a chimney.\n\nOne chilly evening, a big bad wolf came creeping through the woods. He spotted the straw house and licked his lips. \"Little pig, little pig, let me come in!\" he growled.\n\n\"Not by the hair on my chinny chin chin!\" squealed the first pig.\n\n\"Then I'll huff, and I'll puff, and I'll BLOW your house down!\" And he did just that! The straw flew everywhere, and the first pig ran squealing to his brother's stick house.\n\nThe wolf followed. \"Little pigs, little pigs, let me come in!\" \"Not by the hair on our chinny chin chins!\" So the wolf huffed, and he puffed, and he BLEW the stick house down too! Both pigs ran as fast as their little legs could carry them to the brick house.\n\nThe wolf was right behind them. \"Little pigs, little pigs, let me come in!\" \"Not by the hair on our chinny chin chins!\" roared all three pigs together.\n\nThe wolf huffed. And he puffed. And he huffed and puffed some more. But the brick house stood perfectly still! Not a single brick moved.\n\nThe wolf had one more idea. He climbed onto the roof and started sliding down the chimney. But the clever third pig had a big pot of hot water bubbling over the fire. SPLASH! The wolf yelped, jumped right back out, and ran away into the forest, never to be seen again.\n\nThe three pigs danced and celebrated. From that day on, they all lived together in the strong brick house, safe and happy. And the first two pigs learned that it always pays to do your very best work.\n\nThe End."},
{id:'s2',t:'Goldilocks and the Three Bears',a:'Robert Southey',c:'fairytale',age:'3-6',mS:2,mL:7,
txS:"Once upon a time, a girl named Goldilocks found a cottage in the forest. Inside were three bowls of porridge. The big one was too hot, the medium one too cold, but the little one was just right!\n\nShe tried three chairs. Too hard, too soft, just right! But it broke. She tried three beds. Too hard, too soft, just right! She fell asleep.\n\nThe three bears came home and found her. Goldilocks woke up, saw them, and ran all the way home. She never went into anyone's house without asking again. The End.",
txL:"Once upon a time, at the edge of a great green forest, there lived three bears in a neat little cottage. There was great big Papa Bear, medium-sized Mama Bear, and tiny little Baby Bear. Every morning, Mama Bear made porridge for breakfast.\n\nOne particular morning, the porridge was far too hot to eat. \"Let's go for a walk while it cools down,\" suggested Papa Bear in his great big voice. And off they went, leaving their door unlocked, as bears often do.\n\nNow, not far away, a curious little girl named Goldilocks was wandering through the forest, picking wildflowers. She had golden curls that bounced as she walked, and a nose for adventure that sometimes got her into trouble.\n\nShe spotted the bears' cottage and peeked through the window. \"How lovely!\" she said. She knocked on the door. No answer. So she let herself right in.\n\nOn the table sat three bowls of porridge. Goldilocks was very hungry. She tasted Papa Bear's porridge. \"Ouch! Too hot!\" She tasted Mama Bear's porridge. \"Brrr! Too cold!\" Then she tasted Baby Bear's porridge. \"Mmm, just right!\" She ate every last spoonful.\n\nIn the living room stood three chairs. She sat in Papa Bear's chair. \"Too hard!\" She sat in Mama Bear's chair. \"Too soft!\" She sat in Baby Bear's chair. \"Just right!\" But she rocked back and forth so much that CRACK! The little chair broke into pieces.\n\nFeeling sleepy, Goldilocks went upstairs and found three beds. She lay on Papa Bear's bed. \"Too hard!\" She lay on Mama Bear's bed. \"Too soft!\" She lay on Baby Bear's bed. \"Just right!\" And she fell fast asleep, snoring softly.\n\nSoon the three bears came home from their walk. Papa Bear looked at his bowl. \"Someone's been eating my porridge!\" he growled. Mama Bear looked at hers. \"Someone's been eating my porridge too!\" Baby Bear looked at his empty bowl and cried, \"Someone's been eating my porridge, and they ate it ALL up!\"\n\nThey went to the living room. \"Someone's been sitting in my chair!\" said Papa Bear. \"Someone's been sitting in my chair!\" said Mama Bear. \"Someone's been sitting in my chair,\" sobbed Baby Bear, \"and they BROKE it!\"\n\nUpstairs they went. \"Someone's been sleeping in my bed!\" rumbled Papa Bear. \"Someone's been sleeping in my bed!\" said Mama Bear. \"Someone's been sleeping in my bed,\" squeaked Baby Bear, \"and SHE'S STILL THERE!\"\n\nGoldilocks woke up with a start. She saw three bears staring at her with three pairs of wide eyes. She screamed, jumped out of the window, and ran all the way home without stopping once.\n\nAnd from that day on, Goldilocks never ever went into anyone's house without being invited first. And the bears? They got a new lock for their door.\n\nThe End."},
{id:'s3',t:'The Ugly Duckling',a:'H.C. Andersen',c:'fairytale',age:'4-8',mS:2,mL:6,
txS:"Once upon a time, a mother duck's eggs hatched. All the ducklings were fluffy and yellow, except the last one. He was big and grey.\n\nEveryone called him ugly. The poor duckling ran away. He spent a long, cold winter all alone.\n\nWhen spring came, he flew to a lake and saw beautiful swans. He looked at his reflection and gasped. He was a beautiful swan too!\n\nThe other swans welcomed him with joy. He had been a swan all along. The End.",
txL:"Once upon a time, by a peaceful pond surrounded by tall reeds and swaying cattails, a mother duck sat patiently on her nest. One by one, her eggs began to crack. Pop! Pop! Pop! Out tumbled fluffy yellow ducklings, peeping and cheeping with delight.\n\nBut the biggest egg hadn't hatched yet. Mother Duck waited and waited. Finally, CRACK! Out came the last duckling. He was much bigger than the others, with grey feathers and large, clumsy feet.\n\n\"Oh my,\" said Mother Duck, trying to be kind. But the other animals were not so gentle. \"What an ugly duckling!\" clucked the hens. \"He doesn't look like a duck at all!\" quacked the other ducks. Even his brothers and sisters waddled away from him.\n\nEvery day, someone had something mean to say. The cat hissed at him. The turkey gobbled at him. Even the girl who fed the ducks shooed him away. The ugly duckling's heart was heavy with sadness.\n\nOne autumn evening, he saw a flock of magnificent white birds flying across the orange sky. They were the most beautiful creatures he had ever seen, with long graceful necks and wings like silk. Something stirred deep inside him, though he didn't know why.\n\n\"I wish I could be like them,\" he whispered.\n\nWinter came, cold and cruel. The pond froze over. The duckling had to paddle all night long to keep a small circle of water from turning to ice. He was tired, hungry, and desperately lonely. A kind farmer found him and brought him inside, but the farmer's children scared him, and he escaped back into the bitter cold.\n\nSlowly, slowly, the days grew longer. The ice melted. The flowers pushed through the earth. Spring had finally arrived.\n\nThe duckling felt stronger than ever before. He spread his wings, and to his amazement, they were large and powerful. He flew! Really flew! He soared over meadows and forests until he landed on a sparkling lake.\n\nThree beautiful white swans glided toward him. The duckling bowed his head, expecting them to chase him away. But then he saw his reflection in the clear water.\n\nStaring back at him was not an ugly grey duckling. It was a beautiful white swan, with a long graceful neck and gleaming feathers.\n\n\"Welcome, brother!\" called the swans. Children on the shore pointed and cheered. \"Look! The new swan is the most beautiful of all!\"\n\nThe young swan ruffled his magnificent feathers. After all the sadness and loneliness, he had found where he truly belonged. He had been a swan all along, and now the whole world could see it.\n\nThe End."},
{id:'s4',t:'Jack and the Beanstalk',a:'Traditional',c:'fairytale',age:'4-8',mS:2,mL:7,
txS:"Once upon a time, poor Jack traded his cow for magic beans. His mother threw them out the window in anger.\n\nBy morning, a giant beanstalk reached into the clouds! Jack climbed up and found a giant's castle. He grabbed a bag of gold and escaped.\n\nHe climbed again for a golden hen, and once more for a magic harp. But the giant chased him! Jack slid down and chopped the beanstalk. The giant fell and never returned.\n\nJack and his mother lived happily ever after. The End.",
txL:"Once upon a time, there lived a poor boy named Jack with his mother in a tiny cottage. They had nothing left to eat, and their only cow, Milky White, had stopped giving milk.\n\n\"You must take her to market and sell her,\" said Jack's mother with tears in her eyes. So Jack set off down the road with Milky White.\n\nOn the way, he met a strange old man. \"I'll trade you these magic beans for your cow,\" said the man, holding out five shimmering beans that sparkled like tiny stars.\n\nJack thought they were wonderful and made the trade. But when he got home, his mother was furious. \"Magic beans? You foolish boy!\" She threw the beans out the window and sent Jack to bed without supper.\n\nBut in the morning, Jack rubbed his eyes in amazement. Outside his window grew an enormous beanstalk, so tall it disappeared into the clouds above! Its leaves were as big as blankets, and its trunk was as thick as a tree.\n\nJack began to climb. Up, up, up he went, past the birds, past the clouds, until he reached a strange land floating in the sky. Before him stood an enormous castle.\n\nJack crept inside. Everything was giant-sized. The tables were as tall as houses, the chairs as big as rooms. Suddenly, the floor shook. BOOM. BOOM. BOOM.\n\n\"Fee-fi-fo-fum! I smell the blood of an Englishman!\" roared a terrible voice. A huge giant stomped into the room! Jack hid inside a teacup just in time.\n\nThe giant sat down and counted bags of gold coins. When he fell asleep, his snores shaking the walls, Jack grabbed a bag of gold and scrambled down the beanstalk as fast as he could.\n\nHis mother could hardly believe it! They bought food, new clothes, and fixed up their cottage. But soon the gold ran out.\n\nSo Jack climbed the beanstalk again. This time he found a hen that laid golden eggs! He tucked her under his arm and climbed back down. Now they would never be poor again.\n\nBut Jack was brave and curious, so he climbed one more time. In the castle he found a beautiful golden harp that played the sweetest music all by itself. Jack picked it up, but the harp cried out, \"Master! Master!\"\n\nThe giant woke with a roar! \"Fee-fi-fo-fum!\" He chased Jack across the castle, through the great hall, out the door, and to the beanstalk.\n\nJack climbed down faster than he ever had before. The giant followed, and the whole beanstalk swayed and shook. \"Mother, bring the axe!\" Jack shouted.\n\nAs soon as his feet touched the ground, Jack swung the axe with all his might. CHOP! CHOP! CHOP! The beanstalk cracked, groaned, and came crashing down. The giant fell far, far away and was never seen again.\n\nJack, his mother, the golden hen, and the magical harp all lived happily and richly ever after.\n\nThe End."},
{id:'s5',t:'Little Red Riding Hood',a:'Brothers Grimm',c:'fairytale',age:'4-7',mS:2,mL:6,
txS:"Once upon a time, Little Red Riding Hood went to visit her sick grandmother. In the forest, a sneaky wolf asked where she was going, then ran ahead.\n\nAt grandmother's house, the wolf pretended to be her. \"What big eyes you have!\" \"All the better to see you with!\" \"What big teeth you have!\" \"All the better to catch you!\"\n\nA brave woodcutter heard the commotion and chased the wolf away. Grandmother was safe. Red Riding Hood always stayed on the path after that. The End.",
txL:"Once upon a time, in a little village at the edge of a dark forest, there lived a sweet girl who always wore a beautiful red hooded cape that her grandmother had made for her. Everyone called her Little Red Riding Hood.\n\nOne morning, her mother packed a basket with fresh bread, butter, and a jar of honey. \"Your grandmother is feeling poorly,\" said her mother. \"Please take this to her. But remember: stay on the path and don't talk to strangers.\"\n\n\"I promise, Mother,\" said Little Red Riding Hood, and off she went, skipping into the forest.\n\nThe forest was beautiful. Sunlight danced through the leaves, and birds sang in the branches. But deeper in, the trees grew taller and the shadows grew darker.\n\nSuddenly, a wolf stepped out from behind a tree. He had sharp teeth and cunning eyes, but he smiled his friendliest smile. \"Good morning, little girl. Where are you going with that lovely basket?\"\n\n\"To my grandmother's cottage on the other side of the forest,\" said Red Riding Hood. \"She's not feeling well.\"\n\n\"How kind of you!\" said the wolf. \"Why don't you pick some of these beautiful flowers for her? They would surely make her feel better.\" And he pointed to a patch of wildflowers off the path.\n\nWhile Red Riding Hood gathered flowers, forgetting her mother's warning, the wolf raced ahead to grandmother's cottage. He knocked on the door. \"It's me, Grandmother! Little Red Riding Hood!\"\n\n\"Come in, dear!\" called the grandmother. The wolf burst in, and the frightened grandmother quickly hid in the wardrobe closet.\n\nThe wolf put on grandmother's nightcap and glasses, pulled the covers up to his chin, and climbed into bed.\n\nSoon, Little Red Riding Hood arrived and knocked on the door. \"Come in!\" called a strange, gruff voice. She stepped inside. Something didn't look quite right.\n\n\"Grandmother, what big eyes you have!\" \"All the better to see you with, my dear.\" \"Grandmother, what big ears you have!\" \"All the better to hear you with, my dear.\" \"Grandmother, what big teeth you have!\" \"All the better to CATCH you with!\"\n\nThe wolf leaped out of bed! Little Red Riding Hood screamed as loud as she could.\n\nA brave woodcutter was working nearby. He heard the scream, burst through the door, and swung his mighty axe. The wolf was so frightened he jumped right out the window and ran away into the deepest, darkest part of the forest, never to return.\n\nGrandmother came out of the wardrobe, and they all shared the bread and honey together. From that day on, Little Red Riding Hood always, always stayed on the path.\n\nThe End."},
{id:'s6',t:'The Tortoise and the Hare',a:'Aesop',c:'fable',age:'3-7',mS:1,mL:5,
txS:"A hare bragged that no one could beat him in a race. A slow tortoise accepted the challenge.\n\nThe race started. The hare ran far ahead, then took a nap. The tortoise just kept walking, step by step.\n\nWhen the hare woke up, the tortoise was already at the finish line! Slow and steady wins the race. The End.",
txL:"Once upon a time, in a sunny meadow, there lived a hare who was the fastest animal anyone had ever seen. He could zip through the fields like lightning and leap over streams in a single bound. And oh, how he loved to brag about it!\n\n\"I am the fastest creature in the whole world!\" the hare would boast every single day. \"No one can beat me! Not the fox, not the deer, not anyone!\"\n\nAll the animals were tired of hearing it. Then one day, a quiet little tortoise slowly raised his head. \"I'll race you,\" he said calmly.\n\nThe hare nearly fell over laughing. \"You? Race ME? That's the funniest thing I've ever heard! Your legs are shorter than my ears!\"\n\n\"Nevertheless,\" said the tortoise, \"I challenge you to a race.\"\n\nThe fox agreed to judge, and all the animals gathered to watch. The course ran from the old oak tree to the big red barn on the hill.\n\n\"On your marks, get set, GO!\" shouted the fox.\n\nThe hare shot off like a rocket! In seconds, he was far ahead, just a blur of brown fur. The tortoise took his first careful step. Then another. And another.\n\nThe hare looked back and laughed. The tortoise was barely past the starting line! \"This is too easy,\" said the hare. \"I have plenty of time.\" He spotted a nice shady spot under a tree and decided to take a little rest. Just a short nap.\n\nThe warm sun, the gentle breeze, and the soft grass were so comfortable that the hare fell into a deep, deep sleep.\n\nMeanwhile, the tortoise kept walking. Step by step. One foot in front of the other. He didn't stop. He didn't complain. He didn't look at how far he still had to go. He just kept moving forward.\n\nThe sun moved across the sky. The shadows grew longer. The tortoise passed the sleeping hare without making a sound. He just kept walking.\n\nFinally, the hare woke up with a start. He stretched and yawned. \"Better finish this race, I suppose.\" He looked toward the barn, expecting to see the empty path.\n\nBut there, just steps from the finish line, was the tortoise!\n\nThe hare ran as fast as he could, his ears flat against his head, his legs a blur. But it was too late. The tortoise crossed the finish line just as the hare arrived, huffing and puffing.\n\nAll the animals cheered! The tortoise smiled his slow, wise smile.\n\n\"How did you beat me?\" gasped the hare.\n\n\"Slow and steady wins the race,\" said the tortoise simply.\n\nAnd from that day on, the hare never bragged again. Well, almost never.\n\nThe End."},
{id:'s7',t:'The Princess and the Pea',a:'H.C. Andersen',c:'fairytale',age:'4-8',mS:2,mL:5,
txS:"A prince wanted to marry a real princess, but he could never be sure the princesses he met were real.\n\nOne stormy night, a girl knocked on the castle door, soaking wet. The clever queen placed a tiny pea under twenty mattresses. The girl slept terribly.\n\n\"Only a real princess could feel that!\" said the queen. The prince was overjoyed. They married and lived happily ever after. The End.",
txL:"Once upon a time, there was a prince who wanted very much to marry a real princess. He traveled all around the world, to every kingdom and every land, but something was always wrong. There were plenty of princesses, but he could never be sure if they were real princesses.\n\nOne had dirty fingernails. Another yawned during the royal feast. A third one was perfectly lovely but kept calling the prince by the wrong name. He came home feeling very sad.\n\nThen one evening, a terrible storm blew in. Thunder crashed, lightning flashed, and rain poured down in sheets. In the middle of this dreadful weather, there came a knocking at the castle gate. The old king himself went to open it.\n\nThere stood a girl, absolutely soaked from head to toe. Water ran down her hair and into her shoes. She looked quite a mess. Yet she claimed to be a real princess.\n\n\"We'll see about that,\" thought the old queen, but she said nothing. She went quietly to the guest bedroom, removed all the bedding, and placed a single tiny green pea on the bare mattress. Then she piled twenty thick mattresses on top of the pea, and twenty soft quilts on top of the mattresses.\n\nThe girl had to climb a ladder to get into bed! It was so high she could barely see the floor.\n\nIn the morning, the queen asked sweetly, \"Did you sleep well, my dear?\"\n\n\"Oh, it was terrible!\" said the girl. \"I hardly closed my eyes all night. Something terribly hard was in the bed! I'm covered in bruises. It was quite dreadful!\"\n\nThe queen clapped her hands with delight. Only a real princess could have skin so delicate that she could feel a tiny pea through twenty mattresses and twenty quilts! This was truly a princess!\n\nThe prince was overjoyed. He had finally found his real princess! They were married in a grand ceremony with dancing, feasting, and fireworks that lit up the sky.\n\nAnd the pea? It was placed in the royal museum, where it can still be seen today, if nobody has taken it.\n\nThe End."},
{id:'s8',t:'The Stars That Came to Play',a:'Tail a Tale Original',c:'bedtime',age:'2-5',mS:1,mL:5,
txS:"High in the sky, little star Twinkle didn't want to sleep. She bounced from cloud to cloud.\n\nThen she saw a child by a window. \"Where's my favorite star?\" Twinkle flew to her spot and shone bright.\n\n\"Goodnight, little star!\" said the child. Twinkle smiled. Shining for someone who loves you is the best kind of playing. Goodnight, everyone. The End.",
txL:"High, high up in the velvet night sky, past the fluffy clouds and the sleepy birds, lived a family of stars. There was Papa Star, big and bright. Mama Star, warm and golden. And little Twinkle, the smallest star of all.\n\nEvery evening, when the sun went to sleep and painted the sky pink and purple, it was time for the stars to come out and shine. Papa Star would stretch his five points and glow steadily. Mama Star would shimmer with a soft, golden light. And all the little stars would take their places and twinkle quietly.\n\nBut tonight, little Twinkle didn't want to stay in her spot. \"I don't want to sleep!\" she said. \"I want to PLAY!\"\n\nShe bounced from cloud to cloud, leaving sparkly trails behind her like a tiny comet. She slid down a moonbeam. She played hide-and-seek behind the sleepy moon, who yawned and said, \"Now, now, little one.\"\n\nTwinkle giggled and danced across the sky. She made friends with a firefly who had flown too high. She drew swirly patterns in the darkness. She even tickled the Northern Lights until they wiggled and changed colors.\n\nBut then Twinkle looked down, far, far below. In a tiny house, by a tiny window, she saw a tiny child looking up at the sky. The child looked sad.\n\n\"Where's my favorite star?\" whispered the child. \"The little one that twinkles just for me?\"\n\nTwinkle felt warm inside, right in the center of her starry heart. She realized something important. She flew as fast as she could back to her special spot in the sky. She took a deep breath and shone as bright as she possibly could. She twinkled and sparkled with all her might.\n\nThe child's face lit up with the biggest smile. \"There you are! There's my star! Goodnight, little star! I love you!\"\n\n\"Goodnight,\" whispered Twinkle, glowing with happiness.\n\nTwinkle realized that shining for someone who loves you is the very best kind of playing in the whole wide sky.\n\nSo she settled into her cozy spot, twinkling softly, watching over the sleeping child below. One by one, the other little stars settled down too. The moon pulled a cloud blanket over his face.\n\nGoodnight, little ones. Goodnight, stars. Goodnight, fireflies. Goodnight, moon. Goodnight, Twinkle.\n\nThe End."},
{id:'s9',t:'Snow White',a:'Brothers Grimm',c:'fairytale',age:'4-8',mS:3,mL:8,
txS:"Once upon a time, Snow White's vain stepmother asked her magic mirror who was the fairest. When the mirror said Snow White, the Queen sent her into the forest.\n\nSnow White found a cottage belonging to seven kind dwarfs who let her stay. But the wicked Queen found her and tricked her with a poisoned apple. Snow White fell into a deep sleep.\n\nThe dwarfs kept watch over her. One day, a prince found her and kissed her forehead. Snow White woke up! They married and lived happily ever after. The End.",
txL:"Once upon a time, in a castle atop a snowy hill, there lived a beautiful princess named Snow White. Her skin was as white as snow, her lips as red as roses, and her hair as black as ebony wood. She was kind to every creature she met, from the tiniest mouse to the tallest horse.\n\nBut Snow White's stepmother, the Queen, was terribly vain. She owned a magic mirror, and every morning she would stand before it and ask, \"Mirror, mirror, on the wall, who is the fairest one of all?\"\n\nAnd every morning, the mirror would reply, \"You, my Queen, are the fairest one of all.\" And the Queen would smile.\n\nBut Snow White grew more beautiful with each passing year. One fateful morning, the Queen asked her mirror the usual question. This time, the mirror said, \"You, my Queen, are fair, it is true. But Snow White is a thousand times more beautiful than you.\"\n\nThe Queen turned red with rage! She called for a huntsman and ordered him to take Snow White deep into the forest and never bring her back. But the huntsman was a kind man. He led Snow White into the woods and said, \"Run, princess. Run and never return to the castle.\"\n\nSnow White ran and ran until she was lost and alone. Just when she thought she could go no further, she stumbled upon a tiny cottage tucked between the trees. She knocked, but no one answered. The door was unlocked, so she went inside.\n\nEverything was small and neat. A little table with seven little chairs. Seven little plates. Seven little beds upstairs. Snow White was so tired that she lay across three of the little beds and fell fast asleep.\n\nThat evening, seven dwarfs came home from their work in the diamond mines. \"Someone's been in our house!\" they cried. They found Snow White sleeping peacefully. When she woke and told them her story, their hearts melted. \"Stay with us!\" they said. \"We'll keep you safe.\"\n\nSo Snow White stayed. She cooked and cleaned and sang, and the dwarfs loved her dearly. Doc, Grumpy, Happy, Sleepy, Bashful, Sneezy, and Dopey each watched out for her in their own way. Every morning when they left for work, they warned her, \"Don't open the door to strangers!\"\n\nBut the magic mirror told the Queen where Snow White was hiding. The wicked Queen disguised herself as an old peddler woman and traveled to the cottage. She carried a basket of apples. One apple was special. It was the most beautiful, shiny red apple you ever saw, but one bite would put anyone into a sleep as deep as death.\n\n\"Apples for sale! Beautiful apples!\" called the old woman.\n\nSnow White remembered the dwarfs' warning, but the apple looked so delicious. The old woman took a bite from the green side, which was safe, to prove it wasn't poisoned. Snow White took the beautiful red side and bit into it.\n\nShe fell to the ground instantly, the apple tumbling from her hand.\n\nWhen the dwarfs came home and found her, they wept bitterly. They could not wake her, no matter what they tried. She was so beautiful, even in sleep, that they could not bear to bury her. They made a glass case and placed her inside, keeping watch over her day and night.\n\nSeasons passed. One spring day, a prince was riding through the forest. He saw the glass case and the beautiful girl inside. He dismounted and gently kissed her forehead.\n\nSnow White's eyes fluttered open. She took a deep breath and smiled. The spell was broken! True love's kiss had awakened her.\n\nThe seven dwarfs danced with joy. Snow White and the prince were married in a grand celebration, and they invited everyone in the kingdom, even the smallest creatures of the forest.\n\nAnd they all lived happily ever after.\n\nThe End."},
{id:'s10',t:'Cinderella',a:'Charles Perrault',c:'fairytale',age:'4-8',mS:3,mL:8,
txS:"Once upon a time, kind Cinderella lived with her cruel stepmother and stepsisters. They made her cook and clean all day.\n\nWhen the King held a grand ball, a Fairy Godmother appeared! She turned a pumpkin into a carriage, gave Cinderella a beautiful gown and glass slippers. \"Be home by midnight!\"\n\nAt the ball, the prince fell in love with Cinderella. At midnight she ran, leaving one glass slipper. The prince searched everywhere. When the slipper fit Cinderella perfectly, they married and lived happily ever after. The End.",
txL:"Once upon a time, in a grand house by the market square, there lived a kind and gentle girl named Cinderella. After her dear father passed away, she was left with her stepmother and two stepsisters, who were terribly cruel.\n\nThey took her beautiful bedroom and gave her a tiny room in the attic. They took her pretty dresses and gave her rags. They made her cook the meals, scrub the floors, wash the clothes, and tend the fire until her face was smudged with cinders. That's how she got her name, Cinderella.\n\nDespite everything, Cinderella remained kind. She sang to the birds, befriended the mice, and never said a harsh word about anyone.\n\nOne exciting day, an invitation arrived from the palace. The King was holding a grand ball for his son, the prince! Every maiden in the kingdom was invited.\n\nThe stepsisters shrieked with delight. They ordered Cinderella to sew their dresses, curl their hair, and polish their shoes. \"Can I come too?\" asked Cinderella hopefully.\n\n\"YOU?\" they laughed. \"A dirty cinder girl at the royal ball? Don't be ridiculous!\"\n\nAfter they left in their fine carriage, Cinderella sat by the cold fireplace and cried. \"I wish I could go to the ball,\" she whispered.\n\nSuddenly, the room filled with sparkling light! A warm, kind voice said, \"Dry your tears, dear child.\" There stood her Fairy Godmother, surrounded by tiny floating stars.\n\n\"Bring me a pumpkin from the garden,\" she said. With a wave of her wand, the pumpkin swelled and transformed into a magnificent golden carriage! Six mice became six prancing white horses. A rat became a jolly coachman.\n\nThen the Fairy Godmother touched Cinderella's rags. They shimmered and transformed into the most beautiful ball gown anyone had ever seen, silver and blue, covered in tiny diamonds that sparkled like stars. On her feet appeared delicate glass slippers that caught the light like crystal.\n\n\"Now go, my dear, and enjoy yourself!\" said the Fairy Godmother. \"But remember this: the magic ends at the stroke of midnight. You MUST leave before then!\"\n\nCinderella arrived at the palace and everyone gasped. \"Who is that beautiful girl?\" whispered the guests. The prince saw her across the room, and his heart skipped a beat. He crossed the ballroom and bowed.\n\n\"May I have this dance?\"\n\nThey danced every dance together. They talked and laughed, and the prince was enchanted by her kindness and grace. Even the stepsisters didn't recognize her!\n\nCinderella was so happy that she almost forgot. Then she heard it. BONG! BONG! The great clock was striking midnight!\n\n\"I must go!\" she cried, pulling away from the prince. She ran down the grand staircase as fast as she could. In her hurry, one glass slipper slipped off her foot and clattered on the marble steps. She didn't dare stop to get it.\n\nBONG! The twelfth stroke sounded just as she reached the garden. Her gown turned back to rags. The carriage became a pumpkin. The horses became mice. But in her hand she still held one glass slipper.\n\nThe prince picked up the slipper on the stairs. \"I will find her,\" he declared. \"I will marry the girl whose foot fits this slipper.\"\n\nHe traveled to every house in the kingdom. Every girl tried the slipper, but it was always too big, too small, too wide, or too narrow. Finally, he came to Cinderella's house.\n\nThe stepsisters squeezed and pushed, but the slipper wouldn't fit. \"Is there anyone else?\" asked the prince. \"Just the cinder girl,\" they sneered.\n\nCinderella stepped forward. She slipped her foot into the glass slipper, and it fit perfectly. Then she pulled the matching slipper from her apron pocket.\n\nThe stepsisters' jaws dropped. The prince took Cinderella's hand. \"It's you,\" he said softly. \"I've found you.\"\n\nCinderella, with her kind heart, forgave her stepsisters. She and the prince were married in the grandest wedding the kingdom had ever seen, with music, flowers, and fireworks that painted the sky.\n\nAnd they lived happily ever after.\n\nThe End."},
{id:'s11',t:'Sleeping Beauty',a:'Charles Perrault',c:'fairytale',age:'4-8',mS:2,mL:7,
txS:"Once upon a time, fairies gave a baby princess gifts of beauty and kindness. But an uninvited fairy cursed her: she would prick her finger on a spindle and fall asleep forever.\n\nA good fairy softened the curse: true love's kiss could wake her. On her sixteenth birthday, the princess found a spinning wheel and fell into a deep sleep. The whole castle slept too.\n\nA hundred years later, a brave prince found her and kissed her. She woke up, the castle came alive, and they lived happily ever after. The End.",
txL:"Once upon a time, a king and queen had wished for a child for many years. When at last a beautiful baby girl was born, the whole kingdom celebrated. The king invited twelve fairies to a grand christening feast.\n\nOne by one, the fairies approached the cradle and gave the princess magical gifts. \"She shall have beauty,\" said the first. \"Grace,\" said the second. \"Kindness,\" said the third. \"Wisdom, a lovely singing voice, a gentle heart...\"\n\nBut before the twelfth fairy could give her gift, the castle doors burst open with a CRASH! In swept the thirteenth fairy, who had not been invited. Her eyes blazed with fury.\n\n\"You forgot ME!\" she shrieked. \"So here is MY gift! Before the sun sets on her sixteenth birthday, the princess shall prick her finger on the spindle of a spinning wheel and FALL INTO AN ENDLESS SLEEP!\"\n\nWith a flash of dark light, she vanished. The queen held her baby close, trembling. But the twelfth fairy had not yet given her gift. She could not undo the curse entirely, but she could soften it.\n\n\"The princess shall not die,\" she said gently. \"Instead, she shall fall into a deep sleep, and she shall be awakened by true love's kiss.\"\n\nThe king ordered every spinning wheel in the kingdom burned. For sixteen years, the princess grew up happy, beautiful, and kind, never knowing about the terrible curse.\n\nOn the morning of her sixteenth birthday, while everyone was preparing for the celebration, the curious princess explored a part of the castle she had never seen before. Up a winding staircase, behind a dusty door, she found a tiny room. Inside sat an old woman at a spinning wheel, the only one left in the kingdom.\n\n\"What a fascinating thing!\" said the princess. \"May I try?\" She reached out and touched the spindle.\n\nA single drop of blood appeared on her finger. The princess felt suddenly drowsy. Her eyes grew heavy, and she sank to the floor in a deep, enchanted sleep.\n\nThe spell spread through the castle like a wave. The king fell asleep on his throne. The queen dozed off in the garden. The cook slept at the stove. The dogs curled up in the courtyard. Even the flies on the wall stopped buzzing. The wind died, and not a leaf stirred.\n\nAround the silent castle, thick thorny roses grew, climbing higher and higher until the walls, towers, and gates were completely hidden. Years passed. Then decades. Then a century. The castle became a legend, a fairy tale that grandparents told their grandchildren.\n\n\"Behind those thorns,\" they said, \"sleeps a beautiful princess, waiting for true love's kiss.\"\n\nMany princes tried to cut through the thorns, but the vines were too strong. Then, exactly one hundred years after the princess fell asleep, a young prince came riding by. He was brave and kind, and when he heard the old story, he knew he had to try.\n\nAs he approached, something wonderful happened. The thorns parted before him, turning into beautiful blooming roses. Pink, red, and white flowers opened a path straight to the castle gate.\n\nInside, everything was still and silent. He walked through halls of sleeping servants, past sleeping guards and sleeping cats. Up the winding staircase he climbed, until he found the tiny room where the princess lay.\n\nShe was the most beautiful sight he had ever seen. He knelt beside her and gently kissed her.\n\nThe princess's eyes fluttered open. She looked at the prince and smiled, as if she had been waiting for him all along. \"You came,\" she whispered.\n\nAll around the castle, everyone woke up! The king stretched on his throne. The queen blinked in the garden. The cook finished stirring the pot. The dogs barked, the birds sang, and the wind blew once more.\n\nThe prince and the princess were married that very evening, and the celebration lasted seven days and seven nights.\n\nAnd they all lived happily ever after.\n\nThe End."},
{id:'s12',t:'Hansel and Gretel',a:'Brothers Grimm',c:'fairytale',age:'5-8',mS:3,mL:8,
txS:"Once upon a time, Hansel and Gretel were lost deep in the forest. After three days of wandering, they found an amazing house made of gingerbread and candy.\n\nAn old woman invited them in, but she was a wicked witch! She locked Hansel in a cage to fatten him up. Clever Hansel held out a thin bone so the witch thought he was still skinny.\n\nBrave Gretel tricked the witch into the oven and slammed the door shut! She freed Hansel, they found treasure, and walked home to their overjoyed father. They lived happily ever after. The End.",
txL:"Once upon a time, at the edge of a vast, dark forest, there lived a poor woodcutter with his two children, Hansel and Gretel. Times were very hard, and there was barely enough food to eat.\n\nOne dreadful day, the children's stepmother said, \"We cannot feed them anymore. We must leave them in the forest.\" The woodcutter wept, but he was too weak to argue.\n\nBut clever Hansel had been listening at the door. That night, he crept outside and filled his pockets with white pebbles that gleamed like silver coins in the moonlight.\n\nThe next morning, the family walked deep into the forest. As they walked, Hansel secretly dropped pebbles along the path. When the parents left them by a fire and disappeared, Hansel said, \"Don't worry, Gretel. Follow the pebbles!\" And sure enough, the shining pebbles led them safely home.\n\nBut the stepmother was furious. She locked the door that night so Hansel couldn't collect more pebbles. The next morning, all Hansel could grab was a crust of bread. As they walked into the forest, he dropped breadcrumbs along the path.\n\nThis time, when they tried to find their way home, the crumbs were gone! The birds had eaten every last one. The children were truly lost.\n\nThey wandered for three long days and nights, eating only berries and roots. They were cold, hungry, and frightened. Then, just when they had nearly given up hope, they saw something incredible through the trees.\n\nA house! But not just any house. The walls were made of gingerbread. The roof was made of cake. The windows were made of clear sugar candy. Gumdrops decorated the door, and licorice vines climbed the walls.\n\n\"I can't believe it!\" cried Gretel. They ran to the house and began to eat. Hansel broke off a piece of the roof. Gretel licked a windowpane.\n\nSuddenly, the door creaked open. Out came a very old woman leaning on a cane. She had kind eyes and a sweet voice. \"Oh, you poor dears! You must be so hungry. Come inside! I have warm beds and pancakes and hot chocolate!\"\n\nThe children went in gratefully. But the old woman's kindness was a trick. She was a wicked witch who had built the candy house to lure children! Her eyes were red and could barely see, but her nose could smell a child from miles away.\n\nThe next morning, she grabbed Hansel and locked him in an iron cage! \"I'm going to fatten you up and eat you!\" she cackled.\n\nEvery day, the witch made Gretel cook huge meals for Hansel. Porridge with cream, dumplings, pies, and puddings. Every day, the witch went to the cage and said, \"Hold out your finger, boy, so I can feel how fat you're getting!\"\n\nBut clever Hansel had found a thin chicken bone in his cage. Each time, he held out the bone instead of his finger. The witch, nearly blind, would squeeze the bone and grumble, \"Still too skinny! More food!\"\n\nThis went on for weeks. Finally, the witch lost all patience. \"Fat or thin, I'm going to eat him tomorrow!\" she told Gretel. \"Heat the oven!\"\n\nThe witch's big stone oven was roaring with flames. She told Gretel to lean inside and check if it was hot enough. But brave, clever Gretel knew what the witch was planning.\n\n\"I don't know how,\" said Gretel innocently. \"I've never checked an oven before. Could you show me?\"\n\nThe witch huffed impatiently. \"Silly girl! It's easy! Like this!\" She leaned into the oven.\n\nWith all her strength, Gretel pushed the witch inside and SLAMMED the iron door shut! That was the end of the wicked witch.\n\nGretel found the key and freed Hansel. They hugged each other tightly. Then they explored the witch's house and found chests overflowing with pearls, rubies, and gold coins. They filled their pockets until they could carry no more.\n\nThey walked and walked until they found a path, and the path led them home. Their father ran out crying tears of joy. The stepmother was gone. He had missed his children every single day.\n\nWith the witch's treasure, they never went hungry again. And Hansel and Gretel stayed close together, brave and clever, for the rest of their happy lives.\n\nThe End."},
];


// UI Components
function BG({dim}){
  const stars=useMemo(()=>[...Array(30)].map(()=>({l:`${Math.random()*100}%`,t:`${Math.random()*55}%`,s:Math.random()*2+.5,d:Math.random()*3+2,dl:Math.random()*4})),[]);
  const flies=useMemo(()=>[...Array(6)].map(()=>({l:`${Math.random()*100}%`,t:`${10+Math.random()*50}%`,d:Math.random()*4+3,dl:Math.random()*5})),[]);
  return(<div className={`bg ${dim?'dim':''}`}>{stars.map((s,i)=><div key={i} className="star" style={{left:s.l,top:s.t,width:s.s,height:s.s,animationDuration:`${s.d}s`,animationDelay:`${s.dl}s`}}/>)}<div className="moon"/>{flies.map((f,i)=><div key={`f${i}`} className="ff" style={{left:f.l,top:f.t,animationDuration:`${f.d}s`,animationDelay:`${f.dl}s`}}/>)}<div className="hills"><div className="hl"/><div className="hl"/><div className="hl"/></div></div>);
}
function Toast({msg}){return msg?<div className="toast">{msg}</div>:null}

// SVG Logos
function LogoFull({className=''}){
  return(<svg className={className} viewBox="0 0 320 200" fill="none" xmlns="http://www.w3.org/2000/svg">
    <defs>
      <radialGradient id="mG" cx="50%" cy="50%" r="50%"><stop offset="0%" stopColor="#FFF8DC" stopOpacity=".25"/><stop offset="100%" stopColor="#FFF8DC" stopOpacity="0"/></radialGradient>
      <linearGradient id="a1" x1="0" y1="0" x2="1" y2="0"><stop offset="0%" stopColor="#8B6FC0" stopOpacity="0"/><stop offset="30%" stopColor="#8B6FC0" stopOpacity=".15"/><stop offset="70%" stopColor="#55E6C1" stopOpacity=".1"/><stop offset="100%" stopColor="#55E6C1" stopOpacity="0"/></linearGradient>
      <linearGradient id="a2" x1="0" y1="0" x2="1" y2="0"><stop offset="0%" stopColor="#55E6C1" stopOpacity="0"/><stop offset="40%" stopColor="#C5B3E6" stopOpacity=".12"/><stop offset="100%" stopColor="#FFD4A2" stopOpacity="0"/></linearGradient>
      <linearGradient id="bC" x1="0" y1="0" x2="0" y2="1"><stop offset="0%" stopColor="#2A1F5E"/><stop offset="100%" stopColor="#1A1345"/></linearGradient>
      <linearGradient id="tG" x1="0" y1="0" x2="1" y2="0"><stop offset="0%" stopColor="#E87B35"/><stop offset="100%" stopColor="#F5A623"/></linearGradient>
      <filter id="sG"><feGaussianBlur stdDeviation="1.5" result="b"/><feMerge><feMergeNode in="b"/><feMergeNode in="SourceGraphic"/></feMerge></filter>
    </defs>
    <path d="M20 35 Q80 15 160 30 Q240 45 300 20" stroke="url(#a1)" strokeWidth="12" fill="none" opacity=".6"/>
    <path d="M0 50 Q100 25 200 45 Q280 58 320 35" stroke="url(#a2)" strokeWidth="8" fill="none" opacity=".5"/>
    <circle cx="160" cy="36" r="50" fill="url(#mG)"/>
    <circle cx="160" cy="30" r="22" fill="#FFF8DC"/><circle cx="160" cy="30" r="21" fill="#FFFEF5"/><circle cx="170" cy="24" r="17" fill="#070A1F"/>
    <circle cx="152" cy="28" r="2.5" fill="#F0E6B0" opacity=".4"/><circle cx="158" cy="36" r="1.8" fill="#F0E6B0" opacity=".3"/>
    <g filter="url(#sG)">
      <circle cx="52" cy="18" r="2" fill="#FFEAA7"/><circle cx="268" cy="12" r="2.5" fill="#FFEAA7"/>
      <circle cx="88" cy="8" r="1.5" fill="#FFF"/><circle cx="232" cy="5" r="1.8" fill="#FFF"/>
      <circle cx="40" cy="42" r="1.2" fill="#FFEAA7"/><circle cx="280" cy="38" r="1.5" fill="#FFEAA7"/>
      <circle cx="120" cy="12" r="1" fill="#FFF" opacity=".8"/><circle cx="200" cy="8" r="1.3" fill="#FFF" opacity=".7"/>
    </g>
    <path d="M70 28 L71.5 24 L73 28 L77 29.5 L73 31 L71.5 35 L70 31 L66 29.5Z" fill="#FFF" opacity=".7"/>
    <path d="M245 30 L246 27 L247 30 L250 31 L247 32 L246 35 L245 32 L242 31Z" fill="#FFF" opacity=".5"/>
    <path d="M95 85 Q160 95 160 78 Q160 95 225 85 L225 102 Q160 112 160 96 Q160 112 95 102Z" fill="url(#bC)" stroke="#3D2E7E" strokeWidth=".8"/>
    <line x1="108" y1="88" x2="150" y2="84" stroke="#C5B3E6" strokeWidth=".3" opacity=".2"/>
    <line x1="170" y1="84" x2="212" y2="88" stroke="#C5B3E6" strokeWidth=".3" opacity=".2"/>
    <line x1="160" y1="78" x2="160" y2="96" stroke="#C5B3E6" strokeWidth=".5" opacity=".3"/>
    <ellipse cx="155" cy="78" rx="22" ry="11" fill="#E87B35"/><ellipse cx="155" cy="78" rx="18" ry="8.5" fill="#F09548"/>
    <ellipse cx="155" cy="80" rx="12" ry="5" fill="#FFD4A2" opacity=".3"/>
    <path d="M177 74 Q195 58 215 60 Q235 62 245 78 Q248 84 240 86 Q232 88 226 80 Q220 72 206 70 Q192 68 182 76" fill="url(#tG)"/>
    <path d="M238 78 Q245 82 240 86 Q232 88 226 80" fill="#FFF8DC" opacity=".45"/>
    <circle cx="136" cy="72" r="11.5" fill="#E87B35"/><circle cx="136" cy="72" r="9.5" fill="#F09548"/>
    <polygon points="126,64 128,50 134,62" fill="#E87B35"/><polygon points="128,62 129,54 132,61" fill="#FFB8B8" opacity=".5"/>
    <polygon points="141,60 147,48 148,62" fill="#E87B35"/><polygon points="142.5,60 146,52 147,61" fill="#FFB8B8" opacity=".5"/>
    <path d="M130 72 Q133 69.5 136 72" stroke="#6B3410" strokeWidth="1.2" strokeLinecap="round" fill="none"/>
    <path d="M137.5 71.5 Q140.5 69 143.5 71.5" stroke="#6B3410" strokeWidth="1.2" strokeLinecap="round" fill="none"/>
    <ellipse cx="136" cy="75.5" rx="2.2" ry="1.4" fill="#2D1B0E"/>
    <ellipse cx="131.5" cy="76" rx="3.5" ry="2.5" fill="#FFF8DC" opacity=".35"/>
    <ellipse cx="140.5" cy="76" rx="3.5" ry="2.5" fill="#FFF8DC" opacity=".35"/>
    <path d="M134 76 Q136 78 138 76" stroke="#6B3410" strokeWidth=".7" strokeLinecap="round" fill="none"/>
    <text x="152" y="58" fill="#C5B3E6" fontSize="8" fontFamily="Quicksand,sans-serif" fontWeight="700" opacity=".65">z</text>
    <text x="160" y="48" fill="#C5B3E6" fontSize="10" fontFamily="Quicksand,sans-serif" fontWeight="700" opacity=".45">z</text>
    <text x="170" y="38" fill="#C5B3E6" fontSize="12" fontFamily="Quicksand,sans-serif" fontWeight="700" opacity=".25">z</text>
    <text x="160" y="140" textAnchor="middle" fontFamily="Quicksand,sans-serif" fontWeight="800" fontSize="40" letterSpacing="2">
      <tspan fill="#FFF8DC">T</tspan><tspan fill="#F5A623">a</tspan><tspan fill="#FFF8DC">il </tspan>
      <tspan fill="#C5B3E6" fontSize="28" dy="2">a</tspan><tspan dy="-2"> </tspan>
      <tspan fill="#FFF8DC">T</tspan><tspan fill="#F5A623">a</tspan><tspan fill="#FFF8DC">le</tspan>
    </text>
    <path d="M70 146 Q110 155 160 150 Q210 145 250 150" stroke="url(#tG)" strokeWidth="2.5" strokeLinecap="round" fill="none" opacity=".5"/>
    <text x="160" y="170" textAnchor="middle" fontFamily="Inter,sans-serif" fontWeight="600" fontSize="12" fill="#A8A0C0" letterSpacing="3">BEDTIME STORIES IN YOUR VOICE</text>
  </svg>);
}
function LogoHeader(){
  return(<svg className="logo-hdr" viewBox="0 0 200 44" fill="none" xmlns="http://www.w3.org/2000/svg">
    <defs><linearGradient id="htG" x1="0" y1="0" x2="1" y2="0"><stop offset="0%" stopColor="#E87B35"/><stop offset="100%" stopColor="#F5A623"/></linearGradient></defs>
    <circle cx="18" cy="16" r="9" fill="#FFF8DC"/><circle cx="22" cy="13" r="7" fill="#0B0E2D"/>
    <circle cx="6" cy="8" r="1" fill="#FFEAA7" opacity=".7"/><circle cx="32" cy="6" r=".8" fill="#FFEAA7" opacity=".5"/>
    <circle cx="20" cy="30" r="8" fill="#E87B35"/><circle cx="20" cy="30" r="6.5" fill="#F09548"/>
    <polygon points="13,25 14.5,17 18,24" fill="#E87B35"/><polygon points="14.5,24 15.5,19 17,23.5" fill="#FFB8B8" opacity=".5"/>
    <polygon points="24,23 28,16 28.5,24" fill="#E87B35"/><polygon points="25,23 27,18 27.5,23.5" fill="#FFB8B8" opacity=".5"/>
    <path d="M16 30 Q18 28 20 30" stroke="#6B3410" strokeWidth="1" strokeLinecap="round" fill="none"/>
    <path d="M21.5 29.5 Q23.5 27.5 25.5 29.5" stroke="#6B3410" strokeWidth="1" strokeLinecap="round" fill="none"/>
    <ellipse cx="20" cy="32.5" rx="1.5" ry="1" fill="#2D1B0E"/>
    <ellipse cx="17" cy="33" rx="2.2" ry="1.6" fill="#FFF8DC" opacity=".3"/><ellipse cx="23" cy="33" rx="2.2" ry="1.6" fill="#FFF8DC" opacity=".3"/>
    <path d="M28 30 Q36 22 44 26" stroke="url(#htG)" strokeWidth="2" strokeLinecap="round" fill="none" opacity=".5"/>
    <text x="48" y="32" fontFamily="Quicksand,sans-serif" fontWeight="800" fontSize="24" letterSpacing=".5">
      <tspan fill="#FFF8DC">T</tspan><tspan fill="#F5A623">a</tspan><tspan fill="#FFF8DC">il </tspan>
      <tspan fill="#C5B3E6" fontSize="18" dy="1">a</tspan><tspan dy="-1"> </tspan>
      <tspan fill="#FFF8DC">T</tspan><tspan fill="#F5A623">a</tspan><tspan fill="#FFF8DC">le</tspan>
    </text>
  </svg>);
}

// Tutorial Stepper
function TutStepper({step}){
  const labels=['Account','Voice','Story','Play'];
  return(<div className="tut-steps">{labels.map((l,i)=><React.Fragment key={i}>
    {i>0&&<div className={`tut-line ${i<=step?'done':''}`}/>}
    <div className={`tut-dot ${i===step?'active':i<step?'done':''}`}>{i<step?<Icon name="check" size={14} color="var(--teal)"/>:i+1}</div>
  </React.Fragment>)}</div>);
}

// Tutorial Step 1: Welcome
function TutWelcome({onDone,lang,setLang,t}){
  const[name,setName]=useState('');
  const go=e=>{e.preventDefault();if(name.trim())onDone(name.trim())};
  return(<div className="wel fi"><LogoFull className="logo-welcome"/>
    <div className="wbx">
    <div style={{marginBottom:16}}><label className="il" style={{marginBottom:6,display:'block'}}><Icon name="globe" size={14}/> {t('language')}</label>
      <div className="langsel">{LANGS.map(l=><button key={l.c} className={`langopt ${lang===l.c?'a':''}`} onClick={()=>setLang(l.c)}>{l.f} {l.n}</button>)}</div></div>
    <form onSubmit={go}><div className="ig"><label className="il">{t('whosReading')}</label>
    <input className="inp" placeholder={t('placeholder')} value={name} onChange={e=>setName(e.target.value)} autoFocus/></div>
    <button className="btn bp bw" type="submit" disabled={!name.trim()}><Icon name="sparkle" size={18} color="#fff"/> {t('getStarted')}</button></form></div></div>);
}

// Tutorial Step 2: Voice
function TutVoice({voices,onSave,onSelect,selected,onNext,pw,t,lang}){
  const[samplePlaying,setSamplePlaying]=useState(null);
  const testVoice=(e,v)=>{e.stopPropagation();setSamplePlaying(v.id);
    playVoiceSample(lang,v.id);setTimeout(()=>setSamplePlaying(null),5000)};
  return(<div className="fi"><TutStepper step={1}/>
    <div className="tut-title">{t('setupVoice')}</div>
    <div className="tut-sub">{t('voiceSub')}</div>
    <Recorder onSave={onSave} t={t}/>
    {pw?.active&&<div className="prewarm"><span className="spinner"/> {t('warming')} {pw.progress>0&&pw.progress<1?Math.round(pw.progress*100)+'%':''}</div>}
    {pw?.done&&<div className="prewarm" style={{color:'var(--teal)',borderColor:'rgba(85,230,193,.2)'}}><Icon name="check" size={14} color="var(--teal)"/> {t('cloneReady')}</div>}
    {voices.length>0&&<><div className="sh" style={{fontSize:16,marginTop:12}}><Icon name="brain" size={18} color="var(--teal)"/> {t('clonedVoices')}</div>
      {voices.map(v=><div key={v.id} className={`vc ${selected?.id===v.id?'sel':''}`} onClick={()=>onSelect(v)}>
        <div className="va va-u"><Icon name="mic" size={20} color="var(--teal)"/></div>
        <div style={{flex:1,minWidth:0}}><div className="vn">{v.name}</div><div className="vd">{t('aiClone')}</div></div>
        <button className={`vsample ${samplePlaying===v.id?'playing':''}`} onClick={e=>testVoice(e,v)} title={t('testVoice')||'Test voice'}><Icon name="play" size={14} color="var(--teal)"/></button>
        {selected?.id===v.id&&<span><Icon name="check" size={18} color="var(--teal)"/></span>}
      </div>)}</>}
    <button className="btn bp bw" style={{marginTop:16}} onClick={onNext} disabled={!selected}>{t('continue')} <Icon name="right" size={18} color="#fff"/></button>
  </div>);
}

// Tutorial Step 3: Story
function TutStory({onSelect,selected,onNext,getVer,setVer,t,lang}){
  const[filter,setFilter]=useState('all');
  const filtered=filter==='all'?S:S.filter(s=>s.c===filter);
  return(<div className="fi"><TutStepper step={2}/>
    <div className="tut-title">{t('pickStory')}</div>
    <div className="tut-sub">{t('storySub')}</div>
    <div className="flt">{[{k:'all',l:t('all')},{k:'fairytale',l:t('fairytales')},{k:'fable',l:t('fables')},{k:'bedtime',l:t('bedtime')}].map(f=>
      <button key={f.k} className={`fc ${filter===f.k?'a':''}`} onClick={()=>setFilter(f.k)}>{f.l}</button>)}</div>
    <div className="slist">{filtered.map(s=><div key={s.id} className={`sr ${selected?.id===s.id?'sel':''}`} onClick={()=>onSelect(s)}>
      <div className="se"><StoryIcon id={s.id} size={42}/></div>
      <div className="si"><div className="sn">{getStoryTitle(s.id,lang)}</div><div className="sd">{getStoryAuthor(s.a,lang)} Â· {s.age} Â· ~{getVer(s.id)==='long'?s.mL:s.mS} min</div>
      <div className="ver-btns" onClick={e=>e.stopPropagation()}>
        <button className={`vbtn ${getVer(s.id)==='short'?'va2':''}`} onClick={()=>setVer(s.id,'short')}>{t('short')} ~{s.mS}m</button>
        <button className={`vbtn ${getVer(s.id)==='long'?'va2':''}`} onClick={()=>setVer(s.id,'long')}>{t('long')} ~{s.mL}m</button>
      </div></div>
      {selected?.id===s.id&&<Icon name="check" size={20} color="var(--lav)"/>}
    </div>)}</div>
    <button className="btn bp bw" style={{marginTop:8}} onClick={onNext} disabled={!selected}><Icon name="play" size={16} color="#fff"/> {t('startReading')}</button>
  </div>);
}

// Recorder
function Recorder({onSave,t}){
  const[rec,setRec]=useState(false);const[blob,setBlob]=useState(null);const[url,setUrl]=useState(null);
  const[vname,setVname]=useState('');const[timer,setTimer]=useState(0);
  const mr=useRef(null);const chunks=useRef([]);const tr=useRef(null);
  const start=async()=>{try{const s=await navigator.mediaDevices.getUserMedia({audio:true});mr.current=new MediaRecorder(s);chunks.current=[];mr.current.ondataavailable=e=>chunks.current.push(e.data);
    mr.current.onstop=()=>{const b=new Blob(chunks.current,{type:'audio/webm'});setBlob(b);setUrl(URL.createObjectURL(b))};
    mr.current.start();setRec(true);setTimer(0);tr.current=setInterval(()=>setTimer(t=>t+1),1000)}catch(e){alert('Microphone access needed')}};
  const stop=()=>{if(mr.current&&rec){mr.current.stop();setRec(false);clearInterval(tr.current)}};
  const save=()=>{if(blob&&vname.trim()){onSave(vname.trim(),blob);setBlob(null);setUrl(null);setVname('');setTimer(0)}};
  const reset=()=>{setBlob(null);setUrl(null);setTimer(0)};
  const fmt=s=>`${Math.floor(s/60)}:${String(s%60).padStart(2,'0')}`;
  return(<div className="card fi"><div className="ct"><Icon name="mic" size={18} color="var(--coral)"/> {t('recordVoice')}</div><div className="cs">{t('readSoftly')}</div><div style={{textAlign:'center',padding:'20px 0'}}>
    {!blob?<><button className={`rb ${rec?'rec':''}`} onClick={rec?stop:start}>{rec?<Icon name="stop" size={28} color="#fff"/>:<Icon name="record" size={28} color="#fff"/>}</button>
      <p style={{marginTop:12,fontSize:13,color:'var(--txs)',fontWeight:600}}>{rec?`${t('recording')} ${fmt(timer)}`:t('tapRecord')}</p>
      {rec&&<div className="wf">{[...Array(10)].map((_,i)=><div key={i} className="wb" style={{animationDelay:`${i*.08}s`}}/>)}</div>}
      {rec&&<p style={{fontSize:12,color:'var(--txd)',maxWidth:260,margin:'0 auto',lineHeight:1.5}}>{t('readSample')}</p>}
    </>:<><p style={{marginBottom:12}}><Icon name="sparkle" size={32} color="var(--wg)"/></p>
      <p style={{fontWeight:700,marginBottom:12,color:'var(--moon)',fontSize:15}}>{t('recorded')} ({fmt(timer)})</p>
      <audio src={url} controls style={{width:'100%',maxWidth:280,marginBottom:14,filter:'invert(.85) hue-rotate(180deg)',borderRadius:8}}/>
      <div className="ig" style={{textAlign:'left',maxWidth:280,margin:'0 auto'}}><label className="il">{t('nameVoice')}</label><input className="inp" placeholder={t('voicePlaceholder')} value={vname} onChange={e=>setVname(e.target.value)}/></div>
      <div style={{display:'flex',gap:8,justifyContent:'center',marginTop:12}}><button className="btn bg2 bsm" onClick={reset}><Icon name="replay" size={14}/> {t('redo')}</button><button className="btn bgr bsm" onClick={save} disabled={!vname.trim()}><Icon name="check" size={14} color="#0B0E2D"/> {t('save')}</button></div></>}
  </div></div>);
}

// Player with Voice Cloning â€” Word-level highlighting
function Player({story,voice,ver,onBack,show,t,text,lang}){
  const[status,setStatus]=useState('idle');const[genMsg,setGenMsg]=useState('');
  const[progress,setProgress]=useState(0);const[hlWord,setHlWord]=useState(-1);
  const[paused,setPaused]=useState(false);const[elapsed,setElapsed]=useState(0);
  const audioRef=useRef(null);const chunksAudio=useRef([]);const chunkDurations=useRef([]);
  const stopped=useRef(false);const pausedRef=useRef(false);const currentIdx=useRef(0);
  const allChunks=useRef([]);const timerRef=useRef(null);const readingRef=useRef(null);
  const chunkOffsetsRef=useRef([]);
  const ttsModeRef=useRef('clone'); // 'clone' or 'device'
  const deviceNextRef=useRef(null); // store device TTS restart function
  const deviceStartRef=useRef(0);
  const content=text||(ver==='long'?story?.txL:story?.txS)||'';const paragraphs=content.split('\n\n');
  const storyMin=(ver==='long'?story?.mL:story?.mS)||4;

  // Build word map: flat array of {text, pi, start, end, idx}
  const wordMap=useMemo(()=>{
    const words=[];let ci=0;
    paragraphs.forEach((p,pi)=>{
      const re=/\S+/g;let m;
      while((m=re.exec(p))!==null){
        words.push({text:m[0],pi,start:ci+m.index,end:ci+m.index+m[0].length,idx:words.length});
      }
      ci+=p.length+2;
    });
    return words;
  },[content]);
  const wordsByPara=useMemo(()=>{const g=paragraphs.map(()=>[]);wordMap.forEach(w=>{if(g[w.pi])g[w.pi].push(w)});return g},[wordMap]);
  const charToWord=(pos)=>{for(let i=wordMap.length-1;i>=0;i--){if(pos>=wordMap[i].start)return i}return 0};

  const computeChunkOffsets=(chunks)=>{
    const offsets=[];let sf=0;
    for(const c of chunks){const idx=content.indexOf(c,sf);offsets.push(idx>=0?idx:sf);sf=(idx>=0?idx:sf)+c.length}
    chunkOffsetsRef.current=offsets;
  };

  const doProgress=()=>{
    if(stopped.current||pausedRef.current||!audioRef.current)return;
    const audio=audioRef.current;const total=allChunks.current.length;if(!total)return;
    const idx=currentIdx.current;let ct=0;for(let i=0;i<idx;i++)ct+=(chunkDurations.current[i]||3);
    const cd=audio.duration||3;const cc=audio.currentTime||0;ct+=cc;
    let td=0;for(let i=0;i<total;i++)td+=(chunkDurations.current[i]||(i<idx?3:cd));
    if(td>0)setProgress(Math.min(99.5,(ct/td)*100));
    setElapsed(Math.round(ct));
    const chunkStart=chunkOffsetsRef.current[idx]||0;
    const chunkLen=allChunks.current[idx]?.length||1;
    const charInChunk=Math.round(chunkLen*(cd>0?cc/cd:0));
    setHlWord(charToWord(chunkStart+charInChunk));
  };
  const startTimer=()=>{stopTimer();timerRef.current=setInterval(doProgress,120)};
  const stopTimer=()=>{if(timerRef.current){clearInterval(timerRef.current);timerRef.current=null}};
  const playChunk=(idx)=>{
    if(stopped.current||idx>=allChunks.current.length){setStatus('done');setProgress(100);setHlWord(-1);stopTimer();return}
    currentIdx.current=idx;const url=chunksAudio.current[idx];if(!url){playChunk(idx+1);return}
    if(audioRef.current){audioRef.current.src=url;
      audioRef.current.onloadedmetadata=()=>{chunkDurations.current[idx]=audioRef.current.duration};
      audioRef.current.onended=()=>playChunk(idx+1);audioRef.current.onerror=()=>playChunk(idx+1);
      audioRef.current.play().then(()=>startTimer()).catch(()=>playChunk(idx+1))}
  };
  const generateAndPlay=useCallback(async()=>{
    stopped.current=false;pausedRef.current=false;setPaused(false);
    setStatus('generating');setProgress(0);setHlWord(-1);setElapsed(0);
    chunksAudio.current=[];chunkDurations.current=[];currentIdx.current=0;
    ttsModeRef.current='clone';
    if(!voice?.id?.startsWith('v-')){show(t('noVoiceWarn'));setStatus('idle');return}
    let vb=null;
    try{const d=await dbGet('voices',voice.id);vb=d?.blob;console.log('[TTS] Voice blob:',vb?.size,vb?.type)}
    catch(e){console.warn('Voice DB error:',e)}
    if(!vb){show(t('voiceFailed'));setStatus('idle');return}
    const chunks=chunkText(content,280);allChunks.current=chunks;computeChunkOffsets(chunks);let started=false;
    // Show download progress if models not yet cached
    let dlUnsub=null;
    if(!f5Ready){
      setGenMsg(t('gpuWake'));
      dlUnsub=onF5Progress(p=>{
        if(p>=1)setGenMsg(t('cloningPart')+' 1/'+chunks.length);
        else setGenMsg(t('gpuWake')+' '+Math.round(p*100)+'%');
      });
    }
    for(let i=0;i<chunks.length;i++){if(stopped.current){if(dlUnsub)dlUnsub();return;}
      if(f5Ready)setGenMsg(t('cloningPart')+' '+(i+1)+'/'+chunks.length);
      try{const blob=await generateChunk(chunks[i],vb,lang);
        if(dlUnsub){dlUnsub();dlUnsub=null;setGenMsg(t('cloningPart')+' '+(i+1)+'/'+chunks.length)}
        chunksAudio.current[i]=URL.createObjectURL(blob);
        const tmp=new Audio(chunksAudio.current[i]);
        await new Promise(r=>{tmp.onloadedmetadata=()=>{chunkDurations.current[i]=tmp.duration;r()};tmp.onerror=r;setTimeout(r,3000)});
        if(!started&&!stopped.current){started=true;setStatus('playing');setGenMsg('');playChunk(0)}
      }catch(e){if(dlUnsub){dlUnsub();dlUnsub=null}console.error('[TTS] âŒ Generation error chunk',i,':',e.message||e);if(i===0){show(t('voiceFailed')+' ('+((e.message||'').substring(0,60))+')');setStatus('playing');fallbackTTS(0);return}chunksAudio.current[i]=null}}
    if(!started&&!stopped.current){show(t('voiceFailed'));setStatus('playing');fallbackTTS(0)}
  },[content,voice,show,t]);

  const fallbackTTS=(startIdx)=>{
    ttsModeRef.current='device';
    const synth=window.speechSynthesis;synth.cancel();
    const chunks=allChunks.current.length?allChunks.current:chunkText(content,250);
    if(!allChunks.current.length){allChunks.current=chunks;computeChunkOffsets(chunks)}
    deviceStartRef.current=Date.now();
    const next=(idx)=>{
      if(idx>=chunks.length||stopped.current){setStatus('done');setProgress(100);setHlWord(-1);return}
      currentIdx.current=idx;
      setProgress((idx/chunks.length)*100);
      setElapsed(Math.round((Date.now()-deviceStartRef.current)/1000));
      const chunkStart=chunkOffsetsRef.current[idx]||0;
      setHlWord(charToWord(chunkStart));
      const u=new SpeechSynthesisUtterance(chunks[idx]);u.rate=0.88;u.pitch=1.0;
      const langCode=localStorage.getItem('tat_lang')||'en';const lc=langCode==='zh'?'zh-CN':langCode;
      const vs=synth.getVoices();const pk=vs.find(v=>v.lang.startsWith(lc))||vs.find(v=>/Google/i.test(v.name)&&v.lang.startsWith(lc))||vs.find(v=>v.lang.startsWith('en'))||vs[0];
      if(pk)u.voice=pk;
      u.onboundary=(e)=>{
        if(e.name==='word'&&!stopped.current&&!pausedRef.current){
          setHlWord(charToWord(chunkStart+e.charIndex));
          setElapsed(Math.round((Date.now()-deviceStartRef.current)/1000));
          setProgress(((idx+(e.charIndex/(chunks[idx].length||1)))/chunks.length)*100);
        }
      };
      u.onend=()=>next(idx+1);u.onerror=e=>{if(e.error!=='canceled')next(idx+1)};synth.speak(u)};
    deviceNextRef.current=next;
    next(startIdx||0);
  };

  const togglePause=()=>{if(status!=='playing')return;
    if(pausedRef.current){
      // RESUME
      pausedRef.current=false;setPaused(false);
      if(ttsModeRef.current==='device'){
        window.speechSynthesis?.resume();
      }else{
        if(audioRef.current?.src&&audioRef.current.src!==''){audioRef.current.play().catch(()=>{});startTimer()}
      }
    }else{
      // PAUSE
      pausedRef.current=true;setPaused(true);stopTimer();
      if(ttsModeRef.current==='device'){
        window.speechSynthesis?.pause();
      }else{
        if(audioRef.current)audioRef.current.pause();
      }
    }
  };
  const stopAll=()=>{stopped.current=true;stopTimer();
    if(audioRef.current){audioRef.current.pause();audioRef.current.src=''}
    window.speechSynthesis?.cancel();
    setStatus('idle');setProgress(0);setHlWord(-1);setPaused(false);setElapsed(0);
    deviceNextRef.current=null};

  const handleSeek=(e)=>{
    const rect=e.currentTarget.getBoundingClientRect();
    const cx=e.changedTouches?e.changedTouches[0].clientX:e.touches?e.touches[0].clientX:e.clientX;
    const pct=Math.max(0,Math.min(1,(cx-rect.left)/rect.width));
    // Update visual progress immediately
    setProgress(pct*100);

    if(ttsModeRef.current==='device'){
      // Device TTS: skip to the chunk at this position
      const chunks=allChunks.current;if(!chunks.length)return;
      const ti=Math.min(Math.floor(pct*chunks.length),chunks.length-1);
      window.speechSynthesis?.cancel();
      stopped.current=false;pausedRef.current=false;setPaused(false);
      if(deviceNextRef.current){deviceNextRef.current(ti)}
      else{setStatus('playing');fallbackTTS(ti)}
    }else{
      // Clone mode: seek within audio chunks
      if(!allChunks.current.length||!chunksAudio.current.some(Boolean))return;
      let td=0;for(let i=0;i<allChunks.current.length;i++)td+=(chunkDurations.current[i]||3);
      const tt=pct*td;let ac=0;let ti=0;let st=0;
      for(let i=0;i<allChunks.current.length;i++){const d=chunkDurations.current[i]||3;if(ac+d>tt){ti=i;st=tt-ac;break}ac+=d;ti=i;st=0}
      stopTimer();if(audioRef.current){audioRef.current.pause();audioRef.current.src=''}window.speechSynthesis?.cancel();
      stopped.current=false;
      if(chunksAudio.current[ti]){currentIdx.current=ti;audioRef.current.src=chunksAudio.current[ti];
        audioRef.current.onloadedmetadata=()=>{audioRef.current.currentTime=Math.min(st,audioRef.current.duration-0.1);audioRef.current.play().then(()=>{setStatus('playing');setPaused(false);pausedRef.current=false;startTimer()}).catch(()=>{})};
        audioRef.current.onended=()=>playChunk(ti+1);audioRef.current.onerror=()=>playChunk(ti+1);audioRef.current.load()}
      else{setStatus('playing');setPaused(false);pausedRef.current=false;playChunk(ti)}
    }
  };

  // Scroll highlighted word into view
  useEffect(()=>{
    if(hlWord<0||!readingRef.current)return;
    const el=readingRef.current.querySelector('.whl');
    if(el){const cr=readingRef.current.getBoundingClientRect();const er=el.getBoundingClientRect();
      if(er.bottom>cr.bottom-20||er.top<cr.top+20)el.scrollIntoView({behavior:'smooth',block:'center'})}
  },[hlWord]);
  useEffect(()=>()=>{stopped.current=true;stopTimer();window.speechSynthesis?.cancel()},[]);
  useEffect(()=>{const onVis=()=>{if(document.hidden)stopTimer();
    else if(!stopped.current&&!pausedRef.current&&ttsModeRef.current==='clone'&&audioRef.current&&!audioRef.current.paused)startTimer()};
    document.addEventListener('visibilitychange',onVis);return()=>document.removeEventListener('visibilitychange',onVis)},[]);
  useEffect(()=>{if(!('mediaSession' in navigator)||status==='idle')return;
    const title=getStoryTitle(story?.id,lang)||story?.t||'Bedtime Story';
    navigator.mediaSession.metadata=new MediaMetadata({title,artist:'Tail a Tale',album:voice?.name||''});
    navigator.mediaSession.setActionHandler('play',()=>{if(pausedRef.current)togglePause()});
    navigator.mediaSession.setActionHandler('pause',()=>{if(!pausedRef.current)togglePause()});
    navigator.mediaSession.setActionHandler('stop',stopAll);
  },[status,story,lang]);
  const isClone=voice?.id?.startsWith('v-');const fmtSec=(s)=>Math.floor(s/60)+':'+String(s%60).padStart(2,'0');
  return(<div className="fi">
    <audio ref={audioRef} style={{display:'none'}}/>
    <button className="btn bg2 bsm" onClick={()=>{stopAll();onBack()}} style={{marginBottom:10}}><Icon name="back" size={16}/> {t('back')}</button>
    <div className="pc"><div className="pb">
      <div className="pti">{getStoryTitle(story?.id,lang)||story?.t||t('story')}</div><div className="pau">{getStoryAuthor(story?.a||'',lang)}</div>
      <div className="pbar" onClick={handleSeek} onTouchStart={e=>{e.preventDefault();handleSeek(e)}} onTouchMove={e=>{e.preventDefault();handleSeek(e)}} onTouchEnd={e=>e.preventDefault()} onMouseDown={e=>{
        handleSeek(e);const onMove=ev=>{handleSeek(ev)};const onUp=()=>{document.removeEventListener('mousemove',onMove);document.removeEventListener('mouseup',onUp)};
        document.addEventListener('mousemove',onMove);document.addEventListener('mouseup',onUp);
      }}><div className="pbtr"><div className="pbfl" style={{width:progress+'%'}}><div className="pbth"/></div></div></div>
      <div className="ptm"><span>{fmtSec(elapsed)}</span><span>~{storyMin}:00</span></div>
      <div className="pcc">
        {status==='idle'&&<button className="cb pp" onClick={generateAndPlay}><Icon name="play" size={26} color="#fff"/></button>}
        {status==='generating'&&<span className="spinner" style={{width:24,height:24,border:'2px solid rgba(197,179,230,.3)',borderTopColor:'var(--lav)',borderRadius:'50%',animation:'spin 1s linear infinite',display:'inline-block'}}/>}
        {status==='playing'&&<><button className="cb" onClick={togglePause}><Icon name={paused?'play':'pause'} size={20} color="rgba(255,255,255,.6)"/></button><button className="cb pp" onClick={stopAll}><Icon name="stop" size={22} color="#fff"/></button></>}
        {status==='done'&&<button className="cb pp" onClick={generateAndPlay}><Icon name="replay" size={22} color="#fff"/></button>}
      </div>
      <div className="pvb">{t('voice')}: <b>{voice?.name||t('noneSelected')}</b>{isClone&&<> Â· <Icon name="brain" size={12} color="var(--wg)"/> {t('aiClone')}</>}</div>
    </div></div>
    {status==='generating'&&<div className="genst"><span className="spinner"/>{genMsg}</div>}
    {status==='done'&&<div className="genst"><span className="done"><Icon name="check" size={14} color="var(--teal)"/> {t('storyComplete')}</span></div>}
    <div className="ra" ref={readingRef}>{wordsByPara.map((pWords,pi)=>
      <p key={pi}>{pWords.map(w=>
        <span key={w.idx} className={w.idx===hlWord?'whl':''}>{w.text} </span>
      )}</p>
    )}</div>
  </div>);
}

// Main App
function App(){
  const[name,setName]=useState(()=>{
    if(localStorage.getItem('tat_v')!=='5'){localStorage.removeItem('sv_name');localStorage.removeItem('tat_name');localStorage.removeItem('tat_v');return ''}
    return localStorage.getItem('tat_name')||''});
  const[tutDone,setTutDone]=useState(()=>localStorage.getItem('tat_tut')==='1');
  const[tutStep,setTutStep]=useState(0);
  const[tab,setTab]=useState('stories');
  const[voices,setVoices]=useState([]);const[sv,setSv]=useState(null);const[ss,setSs]=useState(null);
  const[filter,setFilter]=useState('all');const[toast,setToast]=useState('');const[gOk,setGOk]=useState(false);
  const[verPrefs,setVerPrefs]=useState(()=>{try{return JSON.parse(localStorage.getItem('tat_verPrefs')||'{}')}catch{return {}}});
  const[pw,setPw]=useState({active:false,done:false,error:false});
  const[lang,setLangState]=useState(()=>localStorage.getItem('tat_lang')||'en');
  const[menu,setMenu]=useState(false);
  const[tlCache,setTlCache]=useState({});
  const[customStories,setCustomStories]=useState([]);
  const[createMode,setCreateMode]=useState(null); // null | 'write' | 'generate'
  const[samplePl,setSamplePl]=useState(null);
  const[csTitle,setCsTitle]=useState('');
  const[csText,setCsText]=useState('');
  const[genDesc,setGenDesc]=useState('');
  const[genLoading,setGenLoading]=useState(false);

  const t=makeT(lang);
  const dir=getLangDir(lang);

  const setLang=(l)=>{setLangState(l);localStorage.setItem('tat_lang',l);
    const un=localStorage.getItem('tat_name');if(un)dbPut('settings',{key:'user_'+un,lang:l,ts:Date.now()}).catch(()=>{})};

  useEffect(()=>{document.documentElement.dir=dir;document.documentElement.lang=lang},[lang,dir]);

  // Load user settings (including lang) from DB on name set
  useEffect(()=>{if(!name)return;
    dbGet('settings','user_'+name).then(s=>{if(s?.lang&&s.lang!==lang){setLangState(s.lang);localStorage.setItem('tat_lang',s.lang)}}).catch(()=>{})
  },[name]);
  const setVer=(sid,ver)=>{const nv={...verPrefs,[sid]:ver};setVerPrefs(nv);localStorage.setItem('tat_verPrefs',JSON.stringify(nv))};
  const getVer=(sid)=>verPrefs[sid]||'short';

  useEffect(()=>{
    try{const vl=JSON.parse(localStorage.getItem('sv_voices')||'[]').filter(v=>v.id?.startsWith('v-'));setVoices(vl);
    localStorage.setItem('sv_voices',JSON.stringify(vl));
    const lv=localStorage.getItem('tat_lastVoice');if(lv&&lv.startsWith('v-')){const f=vl.find(v=>v.id===lv);if(f)setSv(f)}
    else{localStorage.removeItem('tat_lastVoice')}}catch{}
    speechSynthesis?.getVoices();if(speechSynthesis)speechSynthesis.onvoiceschanged=()=>speechSynthesis.getVoices();
    // F5-TTS will be initialized on-demand when voice cloning is first used
    console.log('[App] ORT available:',!!window.ort);
    dbGetAll('customStories').then(cs=>setCustomStories(cs||[])).catch(()=>{});
    return onPreWarmChange(s=>setPw(s));},[]);

  // Translation helper â€” returns cached or translates silently
  const getTranslatedText=useCallback(async(storyId,ver)=>{
    if(lang==='en')return null;
    const key=`${storyId}_${ver}_${lang}`;
    if(tlCache[key])return tlCache[key];
    const cached=await dbGet('translations',key).catch(()=>null);
    if(cached){setTlCache(p=>({...p,[key]:cached.text}));return cached.text}
    // Translate on demand (silently)
    try{
      let src;
      if(storyId.startsWith('cs-')){const cs=customStories.find(s=>s.id===storyId);src=cs?cs.txS:null}
      else{const story=S.find(s=>s.id===storyId);src=story?(ver==='long'?story.txL:story.txS):null}
      if(!src)return null;
      const result=await translateText(src,'en',lang);
      setTlCache(p=>({...p,[key]:result}));return result;
    }catch(e){return null}
  },[lang,tlCache,customStories]);

  // Background pre-translate ALL built-in stories for current language
  const preTranslateRef=useRef(null);
  const[seedProg,setSeedProg]=useState(null); // null=done, {done,total}=in progress
  useEffect(()=>{
    if(lang==='en'){preTranslateRef.current=null;setSeedProg(null);return}
    let cancelled=false;preTranslateRef.current=lang;
    (async()=>{
      // Count how many need translation
      const total=S.length*2;let done=0;let needsWork=false;
      for(const story of S){
        for(const ver of['short','long']){
          const key=`${story.id}_${ver}_${lang}`;
          const cached=await dbGet('translations',key).catch(()=>null);
          if(cached&&!cached.text?.includes('MYMEMORY')){
            setTlCache(p=>({...p,[key]:cached.text}));done++;
          }else{needsWork=true}
        }
      }
      if(!needsWork||cancelled){setSeedProg(null);return}
      setSeedProg({done,total});
      for(const story of S){
        if(cancelled||preTranslateRef.current!==lang)return;
        for(const ver of['short','long']){
          if(cancelled)return;
          const key=`${story.id}_${ver}_${lang}`;
          // Skip if already in cache
          if(tlCache[key]){done++;setSeedProg({done,total});continue}
          const cached=await dbGet('translations',key).catch(()=>null);
          if(cached&&!cached.text?.includes('MYMEMORY')){
            setTlCache(p=>({...p,[key]:cached.text}));done++;setSeedProg({done,total});continue}
          try{
            const src=ver==='long'?story.txL:story.txS;
            const result=await translateText(src,'en',lang);
            // Store with STORY-BASED key in DB (not just hash key)
            await dbPut('translations',{key,text:result,from:'en',to:lang,ts:Date.now()}).catch(()=>{});
            if(!cancelled){setTlCache(p=>({...p,[key]:result}));done++;setSeedProg({done,total})}
          }catch(e){console.warn('Pre-translate failed for',story.id,ver,e);done++;setSeedProg({done,total})}
          await new Promise(r=>setTimeout(r,200));
        }
      }
      if(!cancelled){setSeedProg(null);console.log('[i18n] Pre-translation complete for',lang)}
    })();
    return()=>{cancelled=true};
  },[lang]);

  // Play story â€” use cached translation or English fallback (no spinner)
  const[playerText,setPlayerText]=useState(null);
  const playStory=async()=>{if(!ss){show(t('noneSelected'));return}
    if(lang!=='en'){
      const key=`${ss.id}_${getVer(ss.id)}_${lang}`;
      // Try memory cache first, then DB
      let txt=tlCache[key]||null;
      if(!txt){const cached=await dbGet('translations',key).catch(()=>null);if(cached)txt=cached.text}
      setPlayerText(txt);// null = use English fallback
    }else{setPlayerText(null)}
    setTab('player')};

  const show=m=>{setToast(m);setTimeout(()=>setToast(''),2800)};
  const saveVoice=async(vn,blob)=>{const id='v-'+Date.now();await dbPut('voices',{id,blob,ts:Date.now()});
    const v={id,name:vn,ts:Date.now()};const nv=[v,...voices];setVoices(nv);
    localStorage.setItem('sv_voices',JSON.stringify(nv));setSv(v);localStorage.setItem('tat_lastVoice',id);show(t('save')+'! '+t('warming'));
    preWarmVoice(id)};
  const selectVoice=(v)=>{setSv(v);localStorage.setItem('tat_lastVoice',v.id)};
  const delVoice=async id=>{await dbDel('voices',id);const nv=voices.filter(v=>v.id!==id);setVoices(nv);localStorage.setItem('sv_voices',JSON.stringify(nv));if(sv?.id===id)setSv(null);show('Removed')};
  const saveCustomStory=async(overrideTitle,overrideText,cat)=>{
    const title=overrideTitle||csTitle.trim();const text=overrideText||csText.trim();
    if(!title||!text)return;
    const id='cs-'+Date.now();const words=text.split(/\s+/).length;const mins=Math.max(1,Math.round(words/130));
    const cs={id,t:title,a:name,c:cat||'written',age:'All',mS:mins,mL:mins,txS:text,txL:text,ts:Date.now()};
    await dbPut('customStories',cs);setCustomStories(prev=>[cs,...prev]);
    setCsTitle('');setCsText('');setGenDesc('');setCreateMode(null);show(t('saveStory')+'!')};
  const generateStory=async(desc)=>{
    const d=desc||genDesc.trim();if(!d){show(t('describeStory'));return}
    setGenLoading(true);
    const result=await generateStoryAI(d,lang,name);
    setGenLoading(false);
    if(!result){show(t('genFailed'));return}
    await saveCustomStory(result.title,result.body,'generated')};
  const surpriseGenerate=async()=>{
    const prompt=getRandomPrompt();setGenDesc(prompt);
    setGenLoading(true);
    const result=await generateStoryAI(prompt,lang,name);
    setGenLoading(false);
    if(!result){show(t('genFailed'));return}
    await saveCustomStory(result.title,result.body,'generated')};
  const delCustomStory=async id=>{if(!confirm(t('deleteStory')))return;
    await dbDel('customStories',id);setCustomStories(prev=>prev.filter(s=>s.id!==id));
    if(ss?.id===id)setSs(null);show('Removed')};
  const allStories=useMemo(()=>[...customStories,...S],[customStories]);
  const userStories=useMemo(()=>customStories,[customStories]);
  const filtered=filter==='all'?allStories:filter==='mine'?userStories:filter==='classics'?S:allStories.filter(s=>s.c===filter);
  const finishName=(n)=>{setName(n);localStorage.setItem('tat_name',n);localStorage.setItem('tat_v','5');
    dbPut('settings',{key:'user_'+n,lang,ts:Date.now()}).catch(()=>{})};
  const finishTut=async()=>{setTutDone(true);localStorage.setItem('tat_tut','1');
    if(lang!=='en'&&ss){
      const key=`${ss.id}_${getVer(ss.id)}_${lang}`;
      let txt=tlCache[key]||null;
      if(!txt){const cached=await dbGet('translations',key).catch(()=>null);if(cached)txt=cached.text}
      setPlayerText(txt);
    }
    setTab('player')};;
  const doLogout=()=>{localStorage.removeItem('tat_name');localStorage.removeItem('tat_v');localStorage.removeItem('tat_tut');setName('');setTutDone(false);setTutStep(0);setSv(null);setSs(null);speechSynthesis?.cancel();setMenu(false);
    // Reload custom stories for next user (they're shared across readers)
    dbGetAll('customStories').then(cs=>setCustomStories(cs||[])).catch(()=>{})};

  if(!name)return<><BG/><div className="app" dir={dir} key={lang}><TutWelcome onDone={finishName} lang={lang} setLang={setLang} t={t}/></div></>;

  if(!tutDone)return(<><BG dim/><div className="app" dir={dir} key={lang}>
    <div className="hdr"><div className="logo"><LogoHeader/></div><span style={{fontSize:12,color:'var(--txd)',fontWeight:600}}>{t('hi')}, {name}</span></div>
    <div className="main" style={{overflowY:'auto'}}>
      {tutStep===0&&<TutVoice voices={voices} onSave={saveVoice} onSelect={selectVoice} selected={sv} onNext={()=>setTutStep(1)} pw={pw} t={t} lang={lang}/>}
      {tutStep===1&&<TutStory onSelect={setSs} selected={ss} onNext={()=>{setTutStep(2);finishTut()}} getVer={getVer} setVer={setVer} t={t} lang={lang}/>}
    </div><Toast msg={toast}/></div></>);

  return(<><BG dim/><div className="app" dir={dir}>
    <div className="hdr"><div className="logo"><LogoHeader/></div>
      <button className="hbtn" onClick={e=>{e.stopPropagation();setMenu(!menu)}}><Icon name="user" size={14}/> {name}</button>
      {menu&&<><div style={{position:'fixed',inset:0,zIndex:40}} onClick={e=>{e.stopPropagation();setMenu(false)}}/>
        <div className="ddmenu" onClick={e=>e.stopPropagation()}>
          <div style={{padding:'6px 14px 2px',fontSize:11,color:'var(--txd)',fontWeight:700,textTransform:'uppercase',letterSpacing:1}}>{t('settings')}</div>
          <div className="ddi" style={{cursor:'default',flexDirection:'column',alignItems:'stretch',gap:6}}>
            <div style={{display:'flex',alignItems:'center',gap:6}}><Icon name="globe" size={14}/> {t('language')}</div>
            <div className="langsel" style={{margin:0}}>{LANGS.map(l=><button key={l.c} className={`langopt ${lang===l.c?'a':''}`} onClick={()=>{setLang(l.c);setTlCache({})}}>{l.f} {l.n}</button>)}</div>
          </div>
          <div className="ddiv"/>
          <button className="ddi" onClick={()=>{if(confirm(t('switchUser')+'?'))doLogout()}}><Icon name="logout" size={16} color="var(--coral)"/> {t('switchUser')}</button>
        </div></>}
    </div>
    <div className="main">
      {seedProg&&seedProg.done<seedProg.total&&<div style={{flexShrink:0,padding:'8px 14px',background:'rgba(139,111,192,.1)',borderRadius:12,marginBottom:8,display:'flex',alignItems:'center',gap:10,fontSize:12,color:'var(--lav)',fontWeight:600}}>
        <span className="spinner" style={{width:14,height:14,border:'2px solid rgba(197,179,230,.3)',borderTopColor:'var(--lav)',borderRadius:'50%',animation:'spin 1s linear infinite',flexShrink:0}}/>
        <span style={{flex:1}}>{t('translating')||'Translating stories...'} {seedProg.done}/{seedProg.total}</span>
        <div style={{width:60,height:4,background:'rgba(255,255,255,.08)',borderRadius:2,overflow:'hidden'}}><div style={{height:'100%',background:'var(--lav)',borderRadius:2,width:(seedProg.done/seedProg.total*100)+'%',transition:'width .3s'}}/></div>
      </div>}
      {tab==='stories'&&<div className="fi">
        <div className="sh"><Icon name="book" size={22} color="var(--moon)"/> {t('bedtimeStories')}</div>
        <div className="ss">{t('chooseAdventure')}</div>

        {/* Create mode tabs */}
        {!createMode?<div className="cmtabs">
          <button className="cmtab" onClick={()=>setCreateMode('write')}><Icon name="pen" size={20} color="var(--lav)"/>{t('writeStory')}</button>
          <button className="cmtab" onClick={()=>setCreateMode('generate')}><Icon name="wand" size={20} color="var(--warm)"/>{t('generateStory')}</button>
          <button className="cmtab" onClick={surpriseGenerate} disabled={genLoading}><Icon name="dice" size={20} color="var(--teal)"/>{t('surpriseMe')}</button>
        </div>

        :createMode==='write'?<div className="csform">
          <div className="ct" style={{marginBottom:8}}><Icon name="pen" size={16} color="var(--lav)"/> {t('writeStory')}</div>
          <div className="ig"><label className="il">{t('storyTitle')}</label><input className="inp" value={csTitle} onChange={e=>setCsTitle(e.target.value)} placeholder="The Brave Little Star..."/></div>
          <div className="ig"><label className="il">{t('storyText')}</label><textarea className="inp" rows={6} value={csText} onChange={e=>setCsText(e.target.value)} placeholder={t('storyText')} style={{resize:'vertical',minHeight:100,lineHeight:1.6}}/></div>
          <div style={{display:'flex',gap:8}}><button className="btn bg2 bsm" onClick={()=>{setCreateMode(null);setCsTitle('');setCsText('')}}>{t('back')}</button>
            <button className="btn bgr bsm" onClick={()=>saveCustomStory(null,null,'written')} disabled={!csTitle.trim()||!csText.trim()}><Icon name="check" size={14} color="#0B0E2D"/> {t('saveStory')}</button></div>
        </div>

        :<div className="gencard">
          <div className="ct" style={{marginBottom:8}}><Icon name="wand" size={16} color="var(--warm)"/> {t('generateStory')}</div>
          {!genLoading?<>
            <div className="ig"><label className="il">{t('describeStory')}</label><textarea className="inp" rows={3} value={genDesc} onChange={e=>setGenDesc(e.target.value)} placeholder={t('descPlaceholder')} style={{resize:'vertical',minHeight:60,lineHeight:1.6}}/></div>
            <div style={{display:'flex',gap:8}}><button className="btn bg2 bsm" onClick={()=>{setCreateMode(null);setGenDesc('')}}>{t('back')}</button>
              <button className="btn bgr bsm" onClick={()=>generateStory()} disabled={!genDesc.trim()}><Icon name="wand" size={14} color="#0B0E2D"/> {t('generateStory')}</button>
              <button className="btn bg2 bsm" onClick={()=>{const p=getRandomPrompt();setGenDesc(p)}} title={t('surpriseMe')} style={{padding:'8px 12px'}}><Icon name="dice" size={14}/></button></div>
          </>:<div className="genloading"><span className="spinner"/>{t('generating')}</div>}
        </div>}

        {genLoading&&!createMode&&<div className="genloading" style={{marginBottom:14}}><span className="spinner"/>{t('generating')}</div>}

        <div className="flt">{[{k:'all',l:t('all')},{k:'classics',l:t('classics')},...(userStories.length?[{k:'mine',l:t('myStories')}]:[])].map(f=><button key={f.k} className={`fc ${filter===f.k?'a':''}`} onClick={()=>setFilter(f.k)}>{f.l}</button>)}</div>
        <div className="slist">{filtered.map(s=><div key={s.id} className={`sr ${ss?.id===s.id?'sel':''}`} onClick={()=>{setSs(s);show(getStoryTitle(s.id,lang)||s.t)}} style={{position:'relative'}}>
          <div className="se"><StoryIcon id={s.id} size={42}/></div>
          <div className="si"><div className="sn">{getStoryTitle(s.id,lang)||s.t}</div><div className="sd">{s.c==='generated'?<><Icon name="wand" size={11} color="var(--warm)"/> AI</>:s.c==='written'?<><Icon name="pen" size={11} color="var(--lav)"/> {name}</>:getStoryAuthor(s.a,lang)} Â· {s.age} Â· ~{getVer(s.id)==='long'?s.mL:s.mS} min</div>
          {s.txS!==s.txL&&<div className="ver-btns" onClick={e=>e.stopPropagation()}>
            <button className={`vbtn ${getVer(s.id)==='short'?'va2':''}`} onClick={()=>setVer(s.id,'short')}>{t('short')} ~{s.mS}m</button>
            <button className={`vbtn ${getVer(s.id)==='long'?'va2':''}`} onClick={()=>setVer(s.id,'long')}>{t('long')} ~{s.mL}m</button>
          </div>}</div>
          {ss?.id===s.id&&<Icon name="check" size={20} color="var(--lav)"/>}
          {s.id?.startsWith('cs-')&&<button className="csdel" onClick={e=>{e.stopPropagation();delCustomStory(s.id)}}><Icon name="trash" size={14}/></button>}
        </div>)}</div></div>}

      {tab==='voices'&&<div className="fi">
        <div className="sh"><Icon name="mic" size={22} color="var(--moon)"/> {t('yourVoices')}</div>
        <div className="ss">{t('recSub')}</div>
        <Recorder onSave={saveVoice} t={t}/>
        {pw.active&&<div className="prewarm"><span className="spinner"/> {t('warming')}</div>}
        {pw.done&&<div className="prewarm" style={{color:'var(--teal)',borderColor:'rgba(85,230,193,.2)'}}><Icon name="check" size={14} color="var(--teal)"/> {t('cloneReady')}</div>}
        <div className="vlist">
        {voices.length>0&&<><div className="sh" style={{fontSize:16,marginTop:12}}><Icon name="brain" size={18} color="var(--teal)"/> {t('clonedVoices')}</div>
          {voices.map(v=><div key={v.id} className={`vc ${sv?.id===v.id?'sel':''}`} onClick={()=>selectVoice(v)}>
            <div className="va va-u"><Icon name="mic" size={20} color="var(--teal)"/></div><div style={{flex:1,minWidth:0}}><div className="vn">{v.name}</div><div className="vd">{t('aiClone')}</div></div>
            <button className={`vsample ${samplePl===v.id?'playing':''}`} onClick={e=>{e.stopPropagation();setSamplePl(v.id);playVoiceSample(lang,v.id);setTimeout(()=>setSamplePl(null),5000)}} title={t('testVoice')||'Test voice'}><Icon name="play" size={14} color="var(--teal)"/></button>
            {sv?.id===v.id&&<span><Icon name="check" size={18} color="var(--teal)"/></span>}
            <button className="vx" onClick={e=>{e.stopPropagation();delVoice(v.id)}}><Icon name="trash" size={14}/></button></div>)}</>}
        {voices.length===0&&<div className="info" style={{marginTop:8}}>{t('recSub')}</div>}
        </div>
        </div>}

      {tab==='play'&&<div className="fi" style={{overflowY:'auto',paddingBottom:16}}>
        <div className="sh"><Icon name="sparkle" size={22} color="var(--moon)"/> {t('goodnight')}</div>
        <div className="steps"><div className={`step ${sv?'d':'a'}`}/><div className={`step ${ss?'d':sv?'a':''}`}/><div className={`step ${sv&&ss?'a':''}`}/></div>
        <div className="card" style={{borderLeft:'3px solid '+(sv?'var(--teal)':'var(--wg)')}}>
          <div style={{display:'flex',alignItems:'center',justifyContent:'space-between'}}>
            <div><div className="ct"><Icon name={sv?'check':'mic'} size={16} color={sv?'var(--teal)':'var(--txd)'}/> {t('voice')}</div><div className="cs">{sv?sv.name+' Â· '+t('aiClone'):t('noneSelected')}</div></div>
            <button className="btn bg2 bsm" onClick={()=>setTab('voices')}>{sv?t('change'):t('pick')}</button></div></div>
        <div className="card" style={{borderLeft:'3px solid '+(ss?'var(--teal)':'var(--wg)')}}>
          <div style={{display:'flex',alignItems:'center',justifyContent:'space-between'}}>
            <div><div className="ct"><Icon name={ss?'check':'book'} size={16} color={ss?'var(--teal)':'var(--txd)'}/> {t('story')}</div><div className="cs">{ss?getStoryTitle(ss.id,lang)||ss.t:t('noneSelected')}</div>
            {ss&&<div className="ver-btns" style={{marginTop:4}}>
              <button className={`vbtn ${getVer(ss.id)==='short'?'va2':''}`} onClick={()=>setVer(ss.id,'short')}>{t('short')} ~{ss.mS}m</button>
              <button className={`vbtn ${getVer(ss.id)==='long'?'va2':''}`} onClick={()=>setVer(ss.id,'long')}>{t('long')} ~{ss.mL}m</button>
            </div>}</div>
            <button className="btn bg2 bsm" onClick={()=>setTab('stories')}>{ss?t('change'):t('pick')}</button></div></div>
        <button className="btn bp bw" onClick={playStory} disabled={!ss||!sv} style={{marginTop:8,fontSize:18,padding:'16px 24px'}}>
          <Icon name="play" size={18} color="#fff"/> {t('beginStory')}</button>
        {pw.active&&<div className="prewarm" style={{marginTop:10}}><span className="spinner"/> {t('warming')}</div>}
        {pw.done&&!pw.active&&<div className="prewarm" style={{marginTop:10,color:'var(--teal)',borderColor:'rgba(85,230,193,.2)'}}><Icon name="check" size={14} color="var(--teal)"/> {t('cloneReady')}</div>}
        </div>}

      {tab==='player'&&ss&&<Player story={ss} voice={sv} ver={getVer(ss.id)} text={playerText} onBack={()=>{setTab('play');setPlayerText(null)}} show={show} t={t} lang={lang}/>}
    </div>
    {tab!=='player'&&<div className="nav">
      <button className={`ni ${tab==='stories'?'a':''}`} onClick={()=>setTab('stories')}><Icon name="book" size={22} color={tab==='stories'?'var(--moon)':'var(--txd)'}/><span className="ni-l">{t('stories')}</span></button>
      <button className={`ni ${tab==='voices'?'a':''}`} onClick={()=>setTab('voices')}><Icon name="mic" size={22} color={tab==='voices'?'var(--moon)':'var(--txd)'}/><span className="ni-l">{t('voices')}</span></button>
      <button className={`ni ${tab==='play'?'a':''}`} onClick={()=>setTab('play')}><Icon name="play" size={22} color={tab==='play'?'var(--moon)':'var(--txd)'}/><span className="ni-l">{t('play')}</span></button>
    </div>}
    <Toast msg={toast}/>
  </div></>);
}
ReactDOM.createRoot(document.getElementById('root')).render(<App/>);

</script>
</body>
</html>
