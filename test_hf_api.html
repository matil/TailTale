<!DOCTYPE html>
<html><head><meta charset="utf-8"><title>HF Space Multi-Test</title>
<style>body{font-family:monospace;padding:20px;background:#111;color:#0f0}pre{white-space:pre-wrap}
button{font-size:18px;padding:10px 20px;margin:10px 5px;cursor:pointer}
</style></head><body>
<h2>Chatterbox HF Space — Multi-Space Tester</h2>
<p>Tests all 3 Chatterbox spaces to find which one actually works right now.</p>
<button onclick="runTests()">▶ Run Tests (may take 2+ min)</button>
<button onclick="document.getElementById('log').textContent=''">Clear</button>
<pre id="log"></pre>
<script>
const SPACES=[
  {name:'Multilingual',url:'https://resembleai-chatterbox-multilingual-tts.hf.space',hasLang:true},
  {name:'English Original',url:'https://resembleai-chatterbox.hf.space',hasLang:false},
  {name:'Turbo',url:'https://resembleai-chatterbox-turbo-demo.hf.space',hasLang:false},
];
const L=msg=>document.getElementById('log').textContent+=msg+'\n';

function makeTestWav(){
  const sr=16000,n=sr*2;
  const buf=new ArrayBuffer(44+n*2),v=new DataView(buf);
  const w=(o,s)=>{for(let i=0;i<s.length;i++)v.setUint8(o+i,s.charCodeAt(i))};
  w(0,'RIFF');v.setUint32(4,36+n*2,true);w(8,'WAVE');
  w(12,'fmt ');v.setUint32(16,16,true);v.setUint16(20,1,true);
  v.setUint16(22,1,true);v.setUint32(24,sr,true);
  v.setUint32(28,sr*2,true);v.setUint16(32,2,true);v.setUint16(34,16,true);
  w(36,'data');v.setUint32(40,n*2,true);
  for(let i=0;i<n;i++)v.setInt16(44+i*2,Math.sin(2*Math.PI*300*i/sr)*16000,true);
  return new Blob([buf],{type:'audio/wav'});
}

async function testSpace(space){
  L('\n━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━');
  L('Testing: '+space.name+' ('+space.url+')');
  L('━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━');
  
  // Step 1: Check API info
  for(const prefix of ['/gradio_api','/api','']){
    try{
      const r=await fetch(space.url+prefix+'/info');
      if(r.ok){
        const info=await r.json();
        L('  API info ('+prefix+'/info): found, version='+info.version);
        break;
      }
    }catch(e){}
  }
  
  // Step 2: Upload
  const wav=makeTestWav();
  let uploadPath=null;
  for(const prefix of ['/gradio_api/upload','/upload']){
    try{
      const form=new FormData();
      form.append('files',wav,'voice.wav');
      const r=await fetch(space.url+prefix,{method:'POST',body:form});
      if(r.ok){
        const paths=await r.json();
        uploadPath=paths[0];
        L('  Upload ('+prefix+'): OK → '+uploadPath);
        break;
      }else{L('  Upload ('+prefix+'): '+r.status)}
    }catch(e){L('  Upload ('+prefix+'): Error - '+e.message)}
  }
  
  // Step 3: Try to generate with null audio (default voice, no file needed)
  const tests=[];
  if(space.hasLang){
    tests.push({label:'null audio',data:["Hello, this is a test.","en",null,0.5,0.8,0,0.5]});
    if(uploadPath){
      tests.push({label:'path string',data:["Hello test.","en",uploadPath,0.5,0.8,0,0.5]});
      tests.push({label:'FileData',data:["Hello test.","en",{path:uploadPath,meta:{_type:'gradio.FileData'}},0.5,0.8,0,0.5]});
    }
  }else{
    tests.push({label:'null audio',data:["Hello, this is a test.",null,0.5,0.8,0,0.5]});
    if(uploadPath){
      tests.push({label:'path string',data:["Hello test.",uploadPath,0.5,0.8,0,0.5]});
      tests.push({label:'FileData',data:["Hello test.",{path:uploadPath,meta:{_type:'gradio.FileData'}},0.5,0.8,0,0.5]});
    }
  }
  
  for(const test of tests){
    L('  --- '+test.label+' ---');
    for(const ep of ['generate_tts_audio','predict']){
      for(const prefix of ['/gradio_api/call/','/call/']){
        const callUrl=space.url+prefix+ep;
        try{
          const qr=await fetch(callUrl,{
            method:'POST',
            headers:{'Content-Type':'application/json'},
            body:JSON.stringify({data:test.data})
          });
          if(!qr.ok)continue;
          const{event_id}=await qr.json();
          L('  Queued at '+prefix+ep+': '+event_id);
          
          const sseUrl=callUrl+'/'+event_id;
          const ctrl=new AbortController();
          const timer=setTimeout(()=>ctrl.abort(),120000);
          try{
            const sr=await fetch(sseUrl,{signal:ctrl.signal});
            const txt=await sr.text();
            clearTimeout(timer);
            L('  SSE (first 600 chars):');
            txt.substring(0,600).split('\n').forEach(l=>L('    '+l));
            
            if(txt.includes('event: complete')){
              L('  ✅ SUCCESS with: '+test.label+' via '+prefix+ep);
              return {works:true,prefix,ep,format:test.label,space};
            }
            if(txt.includes('event: error'))L('  ❌ Server error');
          }catch(e){clearTimeout(timer);L('  Timeout/error: '+e.message)}
          break;
        }catch(e){}
      }
    }
  }
  return false;
}

async function runTests(){
  document.getElementById('log').textContent='';
  L('=== Testing all Chatterbox HF Spaces ===');
  L('Time: '+new Date().toISOString());
  L('Each space may take 1-2 min (GPU cold start)...\n');
  
  let winner=null;
  for(const space of SPACES){
    const result=await testSpace(space);
    if(result&&result.works&&!winner)winner=result;
  }
  
  L('\n\n========= FINAL RESULT =========');
  if(winner){
    L('✅ WORKING: '+winner.space.name);
    L('   URL: '+winner.space.url);
    L('   Prefix: '+winner.prefix);
    L('   Endpoint: '+winner.ep);
    L('   Format: '+winner.format);
  }else{
    L('❌ ALL SPACES FAILED');
    L('');
    L('Quick check: go to the space directly in your browser:');
    L('https://huggingface.co/spaces/ResembleAI/Chatterbox-Multilingual-TTS');
    L('Click Generate with default text/voice.');
    L('If that ALSO fails → the Space is broken (not our code).');
    L('If it works → paste the result here and I will match the format.');
  }
}
</script>
</body></html>
